<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-material.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="在梦里啥都有"><meta property="og:type" content="website"><meta property="og:title" content="睡觉万岁"><meta property="og:url" content="http://example.com/index.html"><meta property="og:site_name" content="睡觉万岁"><meta property="og:description" content="在梦里啥都有"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="毛"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>睡觉万岁</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><script src="https://g.joyinshare.com/hc/ribbon.min.js" type="text/javascript"></script><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><a target="_blank" rel="noopener" href="https://github.com/maduit" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64ceaa;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">睡觉万岁</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/02/23/breautiful/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/02/23/breautiful/" class="post-title-link" itemprop="url">之前的博客慢慢再修复，先把最近的东西放上来，sos！</a></h2><div class="post-meta"><i class="fa fa-thumb-tack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-02-23 22:17:31 / 修改时间：21:41:12" itemprop="dateCreated datePublished" datetime="2023-02-23T22:17:31+08:00">2023-02-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/2023/" itemprop="url" rel="index"><span itemprop="name">2023</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/images/loading.gif" data-original="/images/saltyfish.png"></p><div style="font-size:40px;color:purple">之前的博客慢慢再修复，先把最近的东西放上来，sos！</div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/07/05/%E5%85%AD%E3%80%81%E6%9A%91%E5%81%87%E4%BD%9C%E4%B8%9A/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/07/05/%E5%85%AD%E3%80%81%E6%9A%91%E5%81%87%E4%BD%9C%E4%B8%9A/" class="post-title-link" itemprop="url">六、暑假作业</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-05 14:47:26 / 修改时间：14:49:19" itemprop="dateCreated datePublished" datetime="2023-07-05T14:47:26+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database ods_edu;</span><br><span class="line">use ods_edu;</span><br><span class="line"><span class="comment">-- create table if not exists</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> database dw_edu;</span><br><span class="line"><span class="keyword">create</span> database app_edu;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_edu.t_edu_chat</span><br><span class="line">(</span><br><span class="line">    id                           <span class="type">int</span> comment <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    create_date_time             <span class="type">timestamp</span> comment <span class="string">&#x27;数据创建时间&#x27;</span>,</span><br><span class="line">    sid                          string comment <span class="string">&#x27;访客id&#x27;</span>,</span><br><span class="line">    create_time                  <span class="type">timestamp</span> comment <span class="string">&#x27;会话创建时间&#x27;</span>,</span><br><span class="line">    seo_source                   string comment <span class="string">&#x27;搜索来源&#x27;</span>,</span><br><span class="line">    seo_keywords                 string comment <span class="string">&#x27;关键字&#x27;</span>,</span><br><span class="line">    ip                           string comment <span class="string">&#x27;IP地址&#x27;</span>,</span><br><span class="line">    area                         string comment <span class="string">&#x27;地域&#x27;</span>,</span><br><span class="line">    country                      string comment <span class="string">&#x27;所在国家&#x27;</span>,</span><br><span class="line">    province                     string comment <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">    city                         string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    origin_channel               string comment <span class="string">&#x27;投放渠道&#x27;</span>,</span><br><span class="line">    `<span class="keyword">user</span>`                       string comment <span class="string">&#x27;所属坐席&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    manual_time                  <span class="type">timestamp</span> comment <span class="string">&#x27;人工开始时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    begin_time                   <span class="type">timestamp</span> comment <span class="string">&#x27;坐席领取时间 &#x27;</span>,</span><br><span class="line"></span><br><span class="line">    end_time                     <span class="type">timestamp</span> comment <span class="string">&#x27;会话结束时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    last_customer_msg_time_stamp <span class="type">timestamp</span> comment <span class="string">&#x27;客户最后一条消息的时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    last_agent_msg_time_stamp    <span class="type">timestamp</span> comment <span class="string">&#x27;坐席最后一下回复的时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    reply_msg_count              <span class="type">int</span> comment <span class="string">&#x27;客服回复消息数&#x27;</span>,</span><br><span class="line">    msg_count                    <span class="type">int</span> comment <span class="string">&#x27;客户发送消息数&#x27;</span>,</span><br><span class="line">    browser_name                 string comment <span class="string">&#x27;浏览器名称&#x27;</span>,</span><br><span class="line">    os_info                      string comment <span class="string">&#x27;系统名称&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_edu.t_edu_chat <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       create_date_time,</span><br><span class="line">       sid,</span><br><span class="line">       create_time,</span><br><span class="line"></span><br><span class="line">       seo_source comment,</span><br><span class="line">       seo_keywords,</span><br><span class="line">       ip,</span><br><span class="line">       area,</span><br><span class="line">       country,</span><br><span class="line">       province,</span><br><span class="line">       city,</span><br><span class="line">       origin_channel,</span><br><span class="line">       `<span class="keyword">user</span>`,</span><br><span class="line">       manual_time,</span><br><span class="line"></span><br><span class="line">       begin_time,</span><br><span class="line"></span><br><span class="line">       end_time,</span><br><span class="line"></span><br><span class="line">       last_customer_msg_time_stamp,</span><br><span class="line"></span><br><span class="line">       last_agent_msg_time_stamp,</span><br><span class="line"></span><br><span class="line">       reply_msg_count,</span><br><span class="line">       msg_count,</span><br><span class="line">       browser_name,</span><br><span class="line">       os_info</span><br><span class="line"><span class="keyword">from</span> web_chat_ems_2019_07;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--1.总访问客户量</span></span><br><span class="line"><span class="comment">-- 1.1年日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_year</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_year <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2020&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">--1.2季度日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_quater</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_quater string comment <span class="string">&#x27;季度&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_quater <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)    <span class="keyword">AS</span> `年份`,</span><br><span class="line">       QUARTER(create_time) <span class="keyword">AS</span> `季度`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)     <span class="keyword">AS</span> `日期`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)  <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> QUARTER(create_time) <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--1.3月日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_month</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string comment <span class="string">&#x27;月份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_month <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">-- 2 	地区独立访客热力图</span></span><br><span class="line"><span class="comment">-- 2.1.1 地区日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.area_day</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    province string ,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.area_day <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       province            <span class="keyword">AS</span> `省份`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> create_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">YEAR</span>(create_time) <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2020&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"><span class="comment">-- 2.2 地区月</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--2.2季度日</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)    <span class="keyword">AS</span> `年份`,</span><br><span class="line">       QUARTER(create_time) <span class="keyword">AS</span> `季度`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)     <span class="keyword">AS</span> `日期`,</span><br><span class="line">       province             <span class="keyword">AS</span> `省份`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)  <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> QUARTER(create_time) <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"></span><br><span class="line"><span class="comment">--2.3 month</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">       province,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- SELECT province, COUNT(DISTINCT CASE WHEN msg_count &gt; 0 THEN sid END) AS `咨询人数`</span></span><br><span class="line"><span class="comment">-- FROM dw_edu.t_edu_chat</span></span><br><span class="line"><span class="comment">-- GROUP BY province;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.	访客咨询率趋势</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.click_tender</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    province string ,</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.click_tender <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">    <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">    <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">    province, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="keyword">AS</span> `咨询人数`,</span><br><span class="line">       concat(round(<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="operator">/</span> total.total_consultations <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> `百分比`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line">         <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="keyword">AS</span> total_consultations <span class="keyword">FROM</span> dw_edu.t_edu_chat) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province, total.total_consultations;</span><br><span class="line"></span><br><span class="line"><span class="comment">--4.	客户访问量和访客咨询率双轴趋势</span></span><br><span class="line"><span class="comment">-- concat(round( COUNT(DISTINCT CASE WHEN msg_count &gt; 0 THEN sid END) / COUNT(DISTINCT sid) * 100, 2), &#x27;%&#x27;) as `百分比`</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.vis_tender</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.vis_tender <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span>     <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">           <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">           <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `客户访问量`,</span><br><span class="line">           concat(round( <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)  <span class="keyword">AS</span> `咨询率`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="comment">-- WHERE create_time BETWEEN &#x27;2019-01-01&#x27; AND &#x27;2020&#x27; -- 替换为实际的日期范围</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">-- 5.	时间段访问客户量趋势</span></span><br><span class="line"><span class="comment">-- 指定时间段的起始日期和结束日期</span></span><br><span class="line"><span class="comment">-- DECLARE @start_date DATE = &#x27;开始日期&#x27;;</span></span><br><span class="line"><span class="comment">-- DECLARE @end_date DATE = &#x27;结束日期&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询指定时间段内每个小时的访问客户量</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.vis_per_hour</span><br><span class="line">(</span><br><span class="line"></span><br><span class="line">    date_hour string,</span><br><span class="line">    con_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.vis_per_hour <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">HOUR</span>(create_time) <span class="keyword">AS</span> `小时`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="comment">-- WHERE create_date_time &gt;= @start_date AND create_date_time &lt;= @end_date</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span>(create_time);</span><br><span class="line"><span class="comment">-- 6.</span></span><br><span class="line"><span class="comment">-- 查询指定时间段内不同来源渠道和小时的访问客户量</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.dif_channel</span><br><span class="line">(</span><br><span class="line">    chennel_c string,</span><br><span class="line">    visiting <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.dif_channel <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> origin_channel <span class="keyword">AS</span> `来源渠道`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`,</span><br><span class="line">       concat(round(        <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)</span><br><span class="line">           <span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"></span><br><span class="line">       ) , <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)   <span class="keyword">AS</span> `占比`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> origin_channel</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> origin_channel;</span><br><span class="line"><span class="comment">-- 7.</span></span><br><span class="line"><span class="comment">-- 指定时间段的起始日期和结束日期</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.dif_source</span><br><span class="line">(</span><br><span class="line">    source_c string,</span><br><span class="line">visit_count <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.dif_source <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    seo_source,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> visitor_count,</span><br><span class="line">    concat(round(    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)</span><br><span class="line">        <span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"></span><br><span class="line">    )  , <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)   <span class="keyword">AS</span> visitor_ratio</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> seo_source;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 8.</span></span><br><span class="line"><span class="comment">-- 查询访问客户量最多的页面排行榜</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.top_web</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    brouse_name string,</span><br><span class="line">    vis_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.top_web <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">           <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">           <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">    browser_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">AS</span> visitor_count</span><br><span class="line"><span class="keyword">FROM</span> ods_edu.web_chat_ems_2019_07</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> browser_name,<span class="keyword">YEAR</span>(create_time),<span class="keyword">MONTH</span>(create_time),<span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> visitor_count <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database app_edu_chat;</span><br><span class="line">use app_edu_chat;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_year</span><br><span class="line">(</span><br><span class="line">    date_year       <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day   <span class="type">varchar</span>(<span class="number">20</span>) comment  <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel  <span class="type">varchar</span>(<span class="number">20</span>) comment  <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">);</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_year \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_year/dt=2019</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_quater</span><br><span class="line">(</span><br><span class="line">    date_year   <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_quater <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel   <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_quater \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_quater/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_month</span><br><span class="line">(</span><br><span class="line">    date_year  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day   <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel  <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_month \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_month/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.area_day</span><br><span class="line">(</span><br><span class="line">    date_year <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    province  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table area_day \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/area_day/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.click_tender</span><br><span class="line">(</span><br><span class="line">    date_year     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    province      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_      <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">) ;</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table click_tender \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/click_tender/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.vis_tender</span><br><span class="line">(</span><br><span class="line">    date_year      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_       <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table vis_tender \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/vis_tender/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.vis_per_hour</span><br><span class="line">(</span><br><span class="line"></span><br><span class="line">    date_hour <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table vis_per_hour \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/vis_per_hour/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.dif_channel</span><br><span class="line">(</span><br><span class="line">    chennel_c       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    visiting <span class="type">int</span>,</span><br><span class="line">    percent_        <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table dif_channel \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/dif_channel/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.dif_source</span><br><span class="line">(</span><br><span class="line">    source_c           <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    visit_count <span class="type">int</span>,</span><br><span class="line">    percent_           <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table dif_source \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/dif_source/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.top_web</span><br><span class="line">(</span><br><span class="line">    date_year      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    brouse_name    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    vis_cnt <span class="type">int</span></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table top_web \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/top_web/dt=2019</span></span><br></pre></td></tr></table></figure><p>mysql导入hive</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sqoop import \ <span class="comment">--connect jdbc:mysql://node1:3306/nev \</span></span><br><span class="line"><span class="comment">--username root \ </span></span><br><span class="line"><span class="comment">--password 123456 \ </span></span><br><span class="line"><span class="comment">--table web_chat_ems_2019_07 \ </span></span><br><span class="line"><span class="comment">--warehouse-dir /user/hive/warehouse </span></span><br><span class="line"><span class="comment">--hive-database ods_edu \ </span></span><br><span class="line"><span class="comment">--hive-import \ </span></span><br><span class="line"><span class="comment">--hive-table web_chat_ems_2019_07</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/07/04/%E6%9A%82%E5%AD%98/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/07/04/%E6%9A%82%E5%AD%98/" class="post-title-link" itemprop="url">五、一些完成的sql</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-04 14:43:14" itemprop="dateCreated datePublished" datetime="2023-07-04T14:43:14+08:00">2023-07-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 14:47:07" itemprop="dateModified" datetime="2023-07-05T14:47:07+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.数据仓库构建-- 1.1创建ods库create database if not exists ods_didi;-- 1.2创建dw数据库create database if not exists dw_didi;-- 1.3创建app数据库create database if not exists app_didi;use ods_didi;-- 2.在ods层创建表-- 2.1创建订单结构表-- 创建用户订单表结构create table if not exists ods_didi.t_user_order(    orderId         string comment &#x27;订单id&#x27;,    telephone       string comment &#x27;打车用户手机&#x27;,    lng             string comment &#x27;用户发起打车的经度&#x27;,    lat             string comment &#x27;用户发起打车的纬度&#x27;,    province        string comment &#x27;所在省份&#x27;,    city            string comment &#x27;所在城市&#x27;,    es_money        double comment &#x27;预估打车费用&#x27;,    gender          string comment &#x27;用户信息 - 性别&#x27;,    profession      string comment &#x27;用户信息 - 行业&#x27;,    age_range       string comment &#x27;年龄段（70后、80后、...）&#x27;,    tip             double comment &#x27;小费&#x27;,    subscribe       int comment &#x27;是否预约（0 - 非预约、1 - 预约）&#x27;,    sub_time        string comment &#x27;预约时间&#x27;,    is_agent        int comment &#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;,    agent_telephone string comment &#x27;预约人手机&#x27;,    order_time      string comment &#x27;订单时间&#x27;)    partitioned by (dt string comment &#x27;时间分区&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;-- ods创建取消订单表create table if not exists ods_didi.t_user_cancel_order(    orderId        string comment &#x27;订单ID&#x27;,    cstm_telephone string comment &#x27;客户联系电话&#x27;,    lng            string comment &#x27;取消订单的经度&#x27;,    lat            string comment &#x27;取消订单的纬度&#x27;,    province       string comment &#x27;所在省份&#x27;,    city           string comment &#x27;所在城市&#x27;,    es_distance    double comment &#x27;预估距离&#x27;,    gender         string comment &#x27;性别&#x27;,    profession     string comment &#x27;行业&#x27;,    age_range      string comment &#x27;年龄段&#x27;,    reason         int comment &#x27;取消订单原因（1 - 选择了其他交通方式、2 - 与司机达成一致，取消订单、3 - 投诉司机没来接我、4 - 已不需要用车、5 - 无理由取消订单）&#x27;,    cancel_time    string comment &#x27;取消时间&#x27;)    partitioned by (dt string comment &#x27;时间分区&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;-- ods创建订单表支付表create table if not exists ods_didi.t_user_pay_order(    id                         string comment &#x27;支付订单ID&#x27;,    orderId                    string comment &#x27;订单ID&#x27;,    lng                        string comment &#x27;目的地的经度（支付地址）&#x27;,    lat                        string comment &#x27;目的地的纬度（支付地址）&#x27;,    province                   string comment &#x27;省份&#x27;,    city                       string comment &#x27;城市&#x27;,    total_money                double comment &#x27;车费总价&#x27;,    real_pay_money             double comment &#x27;实际支付总额&#x27;,    passenger_additional_money double comment &#x27;乘客额外加价&#x27;,    base_money                 double comment &#x27;车费合计&#x27;,    has_coupon                 int comment &#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;,    coupon_total               double comment &#x27;优惠券合计&#x27;,    pay_way                    int comment &#x27;支付方式（0 - 微信支付、1 - 支付宝支付、3 - QQ钱包支付、4 - 一网通银行卡支付）&#x27;,    mileage                    double comment &#x27;里程（单位公里）&#x27;,    pay_time                   string comment &#x27;支付时间&#x27;)    partitioned by (dt string comment &#x27;时间分区&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;-- ods创建用户评价表create table if not exists ods_didi.t_user_evaluate(    id                  string comment &#x27;评价日志唯一ID&#x27;,    orderId             string comment &#x27;订单ID&#x27;,    passenger_telephone string comment &#x27;用户电话&#x27;,    passenger_province  string comment &#x27;用户所在省份&#x27;,    passenger_city      string comment &#x27;用户所在城市&#x27;,    eva_level           int comment &#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;,    eva_time            string comment &#x27;评价时间&#x27;)    partitioned by (dt string comment &#x27;时间分区&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;-- 创建数据仓库 导入数据load data local inpath &#x27;/export/data/didi/order.csv&#x27; into table ods_didi.t_user_order partition (dt = &#x27;2020-04-12&#x27;);load data local inpath &#x27;/export/data/didi/cancel_order.csv&#x27; into table ods_didi.t_user_cancel_order partition (dt = &#x27;2020-04-12&#x27;);load data local inpath &#x27;/export/data/didi/pay.csv&#x27; into table ods_didi.t_user_pay_order partition (dt = &#x27;2020-04-12&#x27;);load data local inpath &#x27;/export/data/didi/evaluate.csv&#x27; into table ods_didi.t_user_evaluate partition (dt = &#x27;2020-04-12&#x27;);-- truncate table dw_didi.t_user_pay_order;-- 3.在dw层进行数据预处理use dw_didi;-- 创建宽表语句create table if not exists dw_didi.t_user_order_wide(    orderId          string comment &#x27;订单id&#x27;,    telephone        string comment &#x27;打车用户手机&#x27;,    lng              string comment &#x27;用户发起打车的经度&#x27;,    lat              string comment &#x27;用户发起打车的纬度&#x27;,    province         string comment &#x27;所在省份&#x27;,    city             string comment &#x27;所在城市&#x27;,    es_money         double comment &#x27;预估打车费用&#x27;,    gender           string comment &#x27;用户信息 - 性别&#x27;,    profession       string comment &#x27;用户信息 - 行业&#x27;,    age_range        string comment &#x27;年龄段（70后、80后、...）&#x27;,    tip              double comment &#x27;小费&#x27;,    subscribe        int comment &#x27;是否预约（0 - 非预约、1 - 预约）&#x27;,    subscribe_name   string comment &#x27;是否预约名称&#x27;,    sub_time         string comment &#x27;预约时间&#x27;,    is_agent         int comment &#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;,    is_agent_name    string comment &#x27;是否代缴名称&#x27;,    agent_telephone  string comment &#x27;预约人手机&#x27;,    order_time       string comment &#x27;订单时间&#x27;,    order_date       string comment &#x27;订单时间，yyyy-MM-dd&#x27;,    order_year       string comment &#x27;年&#x27;,    order_month      string comment &#x27;月&#x27;,    order_day        string comment &#x27;日&#x27;,    order_hour       string comment &#x27;小时&#x27;,    order_time_range string comment &#x27;时间段&#x27;)    partitioned by (dt string comment &#x27;2020-04-12&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;-- 预处理sql语句 用户订单处理insert overwrite table dw_didi.t_user_order_wide partition (dt = &#x27;2020-04-12&#x27;)select orderid,       telephone,       lng,       lat,       province,       city,       es_money,       gender,       profession,       age_range,       tip,       subscribe,--        if(nvl(subscribe, 0) = 0, &#x27;非预约&#x27;, &#x27;预约&#x27;)                   as subscribe_name,       case           when subscribe = 0 or (subscribe is null) then &#x27;非预约&#x27;           when subscribe = 1 then &#x27;预约&#x27;           end                                                             as subscribe_name,       date_format(sub_time, &#x27;yyyy-MM-dd&#x27;)                                 as sub_time,       is_agent,       case           when is_agent = 0 or (subscribe is null) then &#x27;本人&#x27;           when is_agent = 1 then &#x27;代叫&#x27;           end                                                             as is_agent_name,       agent_telephone,--        substr(order_time, 1, 4)                                      as year,       date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)       as order_time,       date_format(order_time, &#x27;yyyy-MM-dd&#x27;)                               as order_data,       year(date_format(order_time, &#x27;yyyy-MM-dd&#x27;))                         as order_year,       month(date_format(order_time, &#x27;yyyy-MM-dd&#x27;))                        as order_month,       day(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;))  as order_day,       hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) as order_hour,       case           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 1 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 5 then &#x27;凌晨&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 5 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 8 then &#x27;早上&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 8 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 11 then &#x27;上午&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 11 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 13 then &#x27;中午&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 13 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 17 then &#x27;下午&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 17 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 19 then &#x27;晚上&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 19 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 20 then &#x27;半夜&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 20 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 24 then &#x27;深夜&#x27;           when hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &gt;= 0 and                hour(date_format(concat(order_time, &#x27;:00&#x27;), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)) &lt; 1 then &#x27;凌晨&#x27;           end--        date_format(order_time, &#x27;yyyy-MM-dd HH:mm:ss&#x27;),from ods_didi.t_user_orderwhere length(order_time) &gt;= 8  and dt = &#x27;2020-04-12&#x27;;create table if not exists dw_didi.t_user_cancel_order(    orderId     string,    Profession  string,    age_range   string,    Reason      string,    cancel_time string)    partitioned by (dt string comment &#x27;2020-04-12&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;insert overwrite table dw_didi.t_user_cancel_order partition (dt = &#x27;2020-04-12&#x27;)select orderId,       profession,       age_range,       reason,       cancel_timefrom ods_didi.t_user_cancel_orderwhere dt = &#x27;2020-04-12&#x27;;create table if not exists dw_didi.t_user_pay_order(    id             string comment &#x27;支付订单ID&#x27;,    orderId        string comment &#x27;订单ID&#x27;,    real_pay_money double comment &#x27;实际支付总额&#x27;,    has_coupon     int comment &#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;,    pay_way        int comment &#x27;支付方式（0-微信支付、1-支付宝支付、3-QQ钱包支付、4- 一网通银行卡支付）&#x27;,    mileage        double comment &#x27;里程（单位公里）&#x27;,    pay_time       string comment &#x27;支付时间&#x27;)    partitioned by (dt string comment &#x27;2020-04-12&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;insert overwrite table dw_didi.t_user_pay_order partition (dt = &#x27;2020-04-12&#x27;)select id,       orderId,       real_pay_money,       has_coupon,       pay_way,       mileage,       pay_timefrom ods_didi.t_user_pay_orderwhere dt = &#x27;2020-04-12&#x27;;create table if not exists dw_didi.t_user_evaluate(    id        string comment &#x27;评价日志唯一ID&#x27;,    orderId   string comment &#x27;订单ID&#x27;,    eva_level int comment &#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;,    eva_time  string comment &#x27;评价时间&#x27;)    partitioned by (dt string comment &#x27;时间分区&#x27;)    ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;,&#x27;;insert overwrite table dw_didi.t_user_evaluate partition (dt = &#x27;2020-04-12&#x27;)select id,       orderId,       eva_level,       eva_timefrom ods_didi.t_user_evaluatewhere dt = &#x27;2020-04-12&#x27;;-- 4.数据处理-- 4.1 总订单笔数分析-- 4.1.1计算4.12的总订单笔数分析select max(dt) as     `时间`,       count(orderid) `订单总笔数`from dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;;--建表create table if not exists app_didi.t_order_total(    date_val string comment &#x27;日期(yyyy-MM-dd)&#x27;,    count    int comment &#x27;订单笔数&#x27;) partitioned by (month string comment &#x27;按月分区yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;--加载数据据insert into table app_didi.t_order_total partition (month = &#x27;2020-04&#x27;)select max(dt)        as `时间`,       count(orderid) as `订单时间`from dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;;-- truncate table app_didi.t_order_total;-- 4.2 预约订单/非预约订单占比分析-- sum,avg,max,min-- 预约单/总单*100%select count(*) as cnt_totalfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;;select max(order_date)       as `日期`,       subscribe_name        as `是否预约`,       count(subscribe_name) as cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by subscribe_name;--左连接select *from (select max(order_date)       as `日期`,             subscribe_name        as `是否预约`,             count(subscribe_name) as cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by subscribe_name) t1         left join (select count(*) as cnt_total                    from dw_didi.t_user_order_wide                    where dt = &#x27;2020-04-12&#x27;) t2;-- 隐式内连接select `日期`,       `是否预约`,       concat(round(cnt / cnt_total * 100, 2), &#x27;%&#x27;) as `百分比`from (select max(order_date)       as `日期`,             subscribe_name        as `是否预约`,             count(subscribe_name) as cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by subscribe_name) t1,     (select count(*) as cnt_total      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;) t2;--开窗函数select order_date     as                                        `日期`,       subscribe_name as                                        `是否预约`,       count(subscribe_name) over (partition by subscribe_name) cnt,       count() over ()                                          cnt_totalfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;;-- group by subscribe_name;--开窗函数2select max(`日期`) as                                         `日期`,       `是否预约`,       concat(round(max(cnt) / max(cnt_total) * 100, 2), &#x27;%&#x27;) `百分比`from (select order_date     as                                        `日期`,             subscribe_name as                                        `是否预约`,             count(subscribe_name) over (partition by subscribe_name) cnt,             count() over ()                                          cnt_total      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;) tgroup by `是否预约`;--方法三select `日期`,       `是否预约`,       concat(round((cnt / sum(cnt) over ()) * 100, 2), &#x27;%&#x27;) `百分比`from (select max(order_date)       as `日期`,             subscribe_name        as `是否预约`,             count(subscribe_name) as cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by subscribe_name) t;create table if not exists app_didi.t_order_subscribe_percent(    date_val       string comment &#x27;日期&#x27;,    subscribe_name string comment &#x27;是否预约&#x27;,    percent_val    string comment &#x27;百分比&#x27;) partitioned by (month string comment &#x27;年月yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;select `日期`,       `是否预约`,       cnt / sum(cnt) over () * 100from (select max(order_date)       as `日期`,             subscribe_name        as `是否预约`,             count(subscribe_name) as cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by subscribe_name) t;insert overwrite table app_didi.t_order_subscribe_percent partition (month = &#x27;2020-04&#x27;)select `日期`,       `是否预约`,       concat(round((cnt / sum(cnt) over ()) * 100, 2), &#x27;%&#x27;) `百分比`from (select max(order_date)       as `日期`,             subscribe_name        as `是否预约`,             count(subscribe_name) as cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by subscribe_name) t;-- 4.3不同时段订单的个数create table if not exists app_didi.t_order_timerange_total(    datetime  string comment &#x27;日期&#x27;,    timerange string comment &#x27;时间段&#x27;,    count     int comment &#x27;订单数量&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;--sqlselect max(dt),       order_time_range,       count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by order_time_range;--加载数据insert overwrite table app_didi.t_order_timerange_total partition (month = &#x27;2020-04&#x27;)select max(dt),       order_time_range,       count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by order_time_range;--4.4不同年龄段、时段订单个数select max(dt),       age_range,       order_time_range,       count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by age_range,         order_time_range;create table if not exists app_didi.t_order_age_and_time_range_total(    datetime         string comment &#x27;日期&#x27;,    age_range        string comment &#x27;年龄段&#x27;,    order_time_range string comment &#x27;时段&#x27;,    count            int comment &#x27;订单数量&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;insert overwrite table app_didi.t_order_age_and_time_range_total partition (month = &#x27;2020-04&#x27;)select max(dt),       age_range,       order_time_range,       count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by age_range, order_time_range;--4.4不同地域订单个数select province, count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by province;--建表create table if not exists app_didi.t_order_province_total(    datetime string comment &#x27;日期&#x27;,    province string comment &#x27;省份&#x27;,    count    int comment &#x27;订单数量&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;insert overwrite table app_didi.t_order_province_total partition (month = &#x27;2020-04&#x27;)select &#x27;2020-04-12&#x27;,       province,       count(*) as order_cntfrom dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by province;-- 4.5求订单客户职业排名top5-- 第一步 ：按职业分组求客户数量select max(dt),       profession,       count(orderId)from dw_didi.t_user_order_widewhere dt = &#x27;2020-04-12&#x27;group by profession;-- 第二部 排名select dt1,       profession,       cnt,       row_number() over (order by cnt desc )from (select max(dt) as     dt1,             profession,             count(orderId) cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;      group by profession) t;-- 取前五select *from (select dt1,             profession,             cnt,             row_number() over (order by cnt desc ) as rk      from (select max(dt) as     dt1,                   profession,                   count(orderId) cnt            from dw_didi.t_user_order_wide            where dt = &#x27;2020-04-12&#x27;            group by profession) t1) t2where rk &lt;= 5;with t1 as (select max(dt) dt1,                   profession,                   count(orderId) cnt            from dw_didi.t_user_order_wide            where dt = &#x27;2020-04-12&#x27;            group by profession),     t2 as (select dt1,profession,cnt,                   row_number() over (order by cnt desc ) as rk            from t1)select *from t2where rk&lt;=5;select *from (select t.profession,             t.cnt,             rank() over (order by t.cnt desc ) as rk      from (select profession,                   count(*) as cnt            from dw_didi.t_user_order_wide            group by profession) t) ttwhere tt.rk &lt;= 5;--建表create table if not exists app_didi.t_order_profession_total_topn(    profession string comment &#x27;职业&#x27;,    Order_cnt  int comment &#x27;订单数量&#x27;,    rk         int comment &#x27;排名&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;--加载数据insert overwrite table app_didi.t_order_profession_total_topn partition (month = &#x27;2020-04&#x27;)select *from (select t.profession,             t.cnt,             rank() over (order by t.cnt desc ) as rk      from (select profession, count(*) as cnt from dw_didi.t_user_order_wide group by profession) t) ttwhere tt.rk &lt;= 5;--4.6用户订单取消占比select &#x27;2020-04-12&#x27;                                                date_val,       concat(round(t1.total_cnt / t2.total_cnt * 100, 2), &#x27;%&#x27;) as cancel_order_percentfrom (select count(orderid) as total_cnt      from ods_didi.t_user_cancel_order      where dt = &#x27;2020-04-12&#x27;) t1        ,     (select count(orderid) as total_cnt      from dw_didi.t_user_order_wide      where dt = &#x27;2020-04-12&#x27;) t2;--创建表create table if not exists app_didi.t_order_cancel_order_percent(    datetime             string comment &#x27;日期&#x27;,    cancel_order_percent string comment &#x27;百分比&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;--加载数据insert overwrite table app_didi.t_order_cancel_order_percent partition (month = &#x27;2020-04&#x27;)select &#x27;2020-04-12&#x27;                                                date_val        ,       concat(round(t1.total_cnt / t2.total_cnt * 100, 2), &#x27;%&#x27;) as percent_valfrom (select count(*) total_cnt from ods_didi.t_user_cancel_order where dt = &#x27;2020-04-12&#x27;) t1        ,     (select count(*) total_cnt from dw_didi.t_user_order_wide where dt = &#x27;2020-04-12&#x27;) t2;-- 4.8统计用户取消订单原因top1with t1 as(select               reason,profession,                   count(reason) over() cnt           from dw_didi.t_user_cancel_order           where dt = &#x27;2020-04-12&#x27;         ),     t2 as(select reason,profession,  cnt,                  row_number() over(order by cnt desc) as rk           from t1     )select *from t2where rk&lt;=5;insert overwrite table  app_didi.t_order_cancel_reason partition (month = &#x27;2020-04&#x27;)select *from(        select            t.profession,             t.cnt,             rank() over (order by t.cnt desc ) as rk        from (select                  profession,                  count(*) as cnt              from dw_didi.t_user_cancel_order group by profession) t    ) ttwhere tt.rk &lt;= 5;--建表create table if not exists app_didi.t_order_cancel_reason(    profession string comment &#x27;职业&#x27;,    cancel_cnt  int comment &#x27;订单数量&#x27;,    rk         int comment &#x27;排名&#x27;)partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)row format delimited fields terminated by &#x27;,&#x27;;--统计每个省订单量最高的城市top3select city,    count(city)from dw_didi.t_user_order_widewhere length(city) &gt; 0group by  city;--建表insert overwrite table  app_didi.t_order_city partition (month = &#x27;2020-04&#x27;)select *from(        select            t.city,            t.cnt,            rank() over (order by t.cnt desc ) as rk        from (select city,                     count(city) as cnt              from dw_didi.t_user_order_wide              where length(city) &gt; 0              group by  city) t    ) ttwhere tt.rk &lt;= 3;create table if not exists app_didi.t_order_city(    city string comment &#x27;城市&#x27;,    order_cnt  int comment &#x27;订单数量&#x27;,    rk         int comment &#x27;排名&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;--统计订单支付中使用优惠券的百分比create table if not exists app_didi.t_order_dicount(    isdicount string comment &#x27;是否使用优惠券&#x27;,    order_cnt  string comment &#x27;百分比&#x27;)partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;insert overwrite table  app_didi.t_order_dicount partition (month = &#x27;2020-04&#x27;)select       `是否使用优惠券`,       concat(round((cnt / sum(cnt) over ()) * 100, 2), &#x27;%&#x27;) `百分比`from (select             has_coupon         as `是否使用优惠券`,             count( has_coupon) as cnt      from dw_didi.t_user_pay_order      where has_coupon!=17      group by  has_coupon) t;--统计用户五星级好评的百分比create table if not exists app_didi.t_order_five_start(    fivestart string comment &#x27;是否是5&#x27;,    order_cnt  string comment &#x27;百分比&#x27;)    partitioned by (month string comment &#x27;年月，yyyy-MM&#x27;)    row format delimited fields terminated by &#x27;,&#x27;;insert overwrite table  app_didi.t_order_five_start partition (month = &#x27;2020-04&#x27;)select    `是否是5`,    concat(round((cnt / sum(cnt) over ()) * 100, 2), &#x27;%&#x27;) `百分比`from (select          eva_level         as `是否是5`,          count(eva_level ) as cnt      from dw_didi.t_user_evaluate      where length(eva_level)&gt;0      group by  eva_level ) t;</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_subscribe_percent</span><br><span class="line">(</span><br><span class="line">    date_val     <span class="type">date</span>,</span><br><span class="line">    subscribe_name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    percent_val <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#创建不同时段订单统计目标表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_timerange_total</span><br><span class="line">(</span><br><span class="line">    order_date <span class="type">date</span>,</span><br><span class="line">    timerange  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    count      <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#创建不同地域订单统计目标表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_province_total</span><br><span class="line">(</span><br><span class="line">    order_date <span class="type">date</span>,</span><br><span class="line">    province   <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    count      <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="keyword">create</span>  <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_profession_total_topn(</span><br><span class="line">    profession <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    order_cnt <span class="type">int</span>,</span><br><span class="line">    rk <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_profession_total_topn \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_profession_total_topn/month=2020-04;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_order_percent</span><br><span class="line">(</span><br><span class="line">    datetime             string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    cancel_order_percent string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_order_percent(</span><br><span class="line">        datatime <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">        cancel_order_percent <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_detail</span><br><span class="line">(</span><br><span class="line">    datetime <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    province <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    count    <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    lng <span class="type">varchar</span>(<span class="number">50</span>) comment <span class="string">&#x27;经度&#x27;</span> ,</span><br><span class="line">    lat <span class="type">varchar</span>(<span class="number">50</span>) comment <span class="string">&#x27;纬度&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_detail \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_detail/month=2020-04;</span></span><br><span class="line"></span><br><span class="line">#创建不同年龄段，不同时段订单目标表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_age_and_time_range_total</span><br><span class="line">(</span><br><span class="line">    order_date       <span class="type">date</span>,</span><br><span class="line">    age_range        <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    order_time_range <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    count            <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_subscribe_percent \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_subscribe_percent/month=2020-04;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_timerange_total \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_timerange_total/month=2020-04</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_province_total  \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_province_total/month=2020-04</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_age_and_time_range_total  \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_age_and_time_range_total/month=2020-04</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_reason</span><br><span class="line">(</span><br><span class="line">    profession <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;职业&#x27;</span>,</span><br><span class="line">    cancel_cnt  <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk         <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_cancel_reason  \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_cancel_reason/month=2020-04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_city</span><br><span class="line">(</span><br><span class="line">    city <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    order_cnt  <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk         <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_city  \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_city/month=2020-04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_dicount</span><br><span class="line">(</span><br><span class="line">    isdicount <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;是否使用优惠券&#x27;</span>,</span><br><span class="line">    order_cnt  <span class="type">varchar</span>(<span class="number">20</span>)comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_dicount \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_dicount/month=2020-04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_five_start</span><br><span class="line">(</span><br><span class="line">    fivestart <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;是否是5&#x27;</span>,</span><br><span class="line">    order_cnt  <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_five_start \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_five_start/month=2020-04</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.数据仓库构建</span></span><br><span class="line"><span class="comment">-- 1.1创建ods库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi;</span><br><span class="line"><span class="comment">-- 1.2创建dw数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi;</span><br><span class="line"><span class="comment">-- 1.3创建app数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi;</span><br><span class="line">use ods_didi;</span><br><span class="line"><span class="comment">-- 2.在ods层创建表</span></span><br><span class="line"><span class="comment">-- 2.1创建订单结构表</span></span><br><span class="line"><span class="comment">-- 创建用户订单表结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_order</span><br><span class="line">(</span><br><span class="line">    orderId         string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone       string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng             string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat             string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province        string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city            string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money        <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender          string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession      string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range       string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip             <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe       <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    sub_time        string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent        <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    agent_telephone string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time      string comment <span class="string">&#x27;订单时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- ods创建取消订单表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_cancel_order</span><br><span class="line">(</span><br><span class="line">    orderId        string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    cstm_telephone string comment <span class="string">&#x27;客户联系电话&#x27;</span>,</span><br><span class="line">    lng            string comment <span class="string">&#x27;取消订单的经度&#x27;</span>,</span><br><span class="line">    lat            string comment <span class="string">&#x27;取消订单的纬度&#x27;</span>,</span><br><span class="line">    province       string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city           string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_distance    <span class="keyword">double</span> comment <span class="string">&#x27;预估距离&#x27;</span>,</span><br><span class="line">    gender         string comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    profession     string comment <span class="string">&#x27;行业&#x27;</span>,</span><br><span class="line">    age_range      string comment <span class="string">&#x27;年龄段&#x27;</span>,</span><br><span class="line">    reason         <span class="type">int</span> comment <span class="string">&#x27;取消订单原因（1 - 选择了其他交通方式、2 - 与司机达成一致，取消订单、3 - 投诉司机没来接我、4 - 已不需要用车、5 - 无理由取消订单）&#x27;</span>,</span><br><span class="line">    cancel_time    string comment <span class="string">&#x27;取消时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- ods创建订单表支付表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_pay_order</span><br><span class="line">(</span><br><span class="line">    id                         string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">    orderId                    string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    lng                        string comment <span class="string">&#x27;目的地的经度（支付地址）&#x27;</span>,</span><br><span class="line">    lat                        string comment <span class="string">&#x27;目的地的纬度（支付地址）&#x27;</span>,</span><br><span class="line">    province                   string comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    city                       string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    total_money                <span class="keyword">double</span> comment <span class="string">&#x27;车费总价&#x27;</span>,</span><br><span class="line">    real_pay_money             <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">    passenger_additional_money <span class="keyword">double</span> comment <span class="string">&#x27;乘客额外加价&#x27;</span>,</span><br><span class="line">    base_money                 <span class="keyword">double</span> comment <span class="string">&#x27;车费合计&#x27;</span>,</span><br><span class="line">    has_coupon                 <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">    coupon_total               <span class="keyword">double</span> comment <span class="string">&#x27;优惠券合计&#x27;</span>,</span><br><span class="line">    pay_way                    <span class="type">int</span> comment <span class="string">&#x27;支付方式（0 - 微信支付、1 - 支付宝支付、3 - QQ钱包支付、4 - 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">    mileage                    <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">    pay_time                   string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- ods创建用户评价表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_evaluate</span><br><span class="line">(</span><br><span class="line">    id                  string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">    orderId             string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    passenger_telephone string comment <span class="string">&#x27;用户电话&#x27;</span>,</span><br><span class="line">    passenger_province  string comment <span class="string">&#x27;用户所在省份&#x27;</span>,</span><br><span class="line">    passenger_city      string comment <span class="string">&#x27;用户所在城市&#x27;</span>,</span><br><span class="line">    eva_level           <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">    eva_time            string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建数据仓库 导入数据</span></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/cancel_order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_cancel_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/pay.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_pay_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/evaluate.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_evaluate <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> dw_didi.t_user_pay_order;</span><br><span class="line"><span class="comment">-- 3.在dw层进行数据预处理use dw_didi;</span></span><br><span class="line"><span class="comment">-- 创建宽表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_order_wide</span><br><span class="line">(</span><br><span class="line">    orderId          string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone        string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng              string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat              string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province         string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city             string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money         <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender           string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession       string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range        string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip              <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe        <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    subscribe_name   string comment <span class="string">&#x27;是否预约名称&#x27;</span>,</span><br><span class="line">    sub_time         string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent         <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    is_agent_name    string comment <span class="string">&#x27;是否代缴名称&#x27;</span>,</span><br><span class="line">    agent_telephone  string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time       string comment <span class="string">&#x27;订单时间&#x27;</span>,</span><br><span class="line">    order_date       string comment <span class="string">&#x27;订单时间，yyyy-MM-dd&#x27;</span>,</span><br><span class="line">    order_year       string comment <span class="string">&#x27;年&#x27;</span>,</span><br><span class="line">    order_month      string comment <span class="string">&#x27;月&#x27;</span>,</span><br><span class="line">    order_day        string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    order_hour       string comment <span class="string">&#x27;小时&#x27;</span>,</span><br><span class="line">    order_time_range string comment <span class="string">&#x27;时间段&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- 预处理sql语句 用户订单处理</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_order_wide <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> orderid,</span><br><span class="line">       telephone,</span><br><span class="line">       lng,</span><br><span class="line">       lat,</span><br><span class="line">       province,</span><br><span class="line">       city,</span><br><span class="line">       es_money,</span><br><span class="line">       gender,</span><br><span class="line">       profession,</span><br><span class="line">       age_range,</span><br><span class="line">       tip,</span><br><span class="line">       subscribe,</span><br><span class="line">       if(nvl(subscribe, <span class="number">0</span>) <span class="operator">=</span> <span class="number">0</span>, <span class="string">&#x27;非预约&#x27;</span>, <span class="string">&#x27;预约&#x27;</span>)                                                 <span class="keyword">as</span> subscribe_name,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;非预约&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">               <span class="keyword">then</span> <span class="string">&#x27;预约&#x27;</span> <span class="keyword">end</span>                                                                     <span class="keyword">as</span> subscribe_name,</span><br><span class="line">       date_format(sub_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                                                         <span class="keyword">as</span> sub_time,</span><br><span class="line">       is_agent,</span><br><span class="line">       <span class="keyword">case</span> <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;本人&#x27;</span> <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;代叫&#x27;</span> <span class="keyword">end</span> <span class="keyword">as</span> is_agent_name,</span><br><span class="line">       agent_telephone,</span><br><span class="line">       substr(order_time, <span class="number">1</span>, <span class="number">4</span>)                                                                    <span class="keyword">as</span> <span class="keyword">year</span>,</span><br><span class="line">       date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)                               <span class="keyword">as</span> order_time,</span><br><span class="line">       date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                                                       <span class="keyword">as</span> order_data,</span><br><span class="line">       <span class="keyword">year</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                                                 <span class="keyword">as</span> order_year,</span><br><span class="line">       <span class="keyword">month</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                                                <span class="keyword">as</span> order_month,</span><br><span class="line">       <span class="keyword">day</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>))                          <span class="keyword">as</span> order_day,</span><br><span class="line">       <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>))                         <span class="keyword">as</span> order_hour,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">5</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">8</span> <span class="keyword">then</span> <span class="string">&#x27;早上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">8</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">11</span> <span class="keyword">then</span> <span class="string">&#x27;上午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">11</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">13</span> <span class="keyword">then</span> <span class="string">&#x27;中午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">13</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">17</span> <span class="keyword">then</span> <span class="string">&#x27;下午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">17</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">19</span> <span class="keyword">then</span> <span class="string">&#x27;晚上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">19</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">20</span> <span class="keyword">then</span> <span class="string">&#x27;半夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">20</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">24</span> <span class="keyword">then</span> <span class="string">&#x27;深夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span> <span class="keyword">end</span>,</span><br><span class="line">       date_format(order_time, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_orderwhere length(order_time) <span class="operator">&gt;=</span> <span class="number">8</span>  <span class="keyword">and</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_cancel_order</span><br><span class="line">(</span><br><span class="line">    orderId     string,</span><br><span class="line">    Profession  string,</span><br><span class="line">    age_range   string,</span><br><span class="line">    Reason      string,</span><br><span class="line">    cancel_time string</span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_cancel_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> orderId, profession, age_range, reason, cancel_timefrom ods_didi.t_user_cancel_orderwhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_pay_order</span><br><span class="line">(</span><br><span class="line">    id             string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">    orderId        string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    real_pay_money <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">    has_coupon     <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">    pay_way        <span class="type">int</span> comment <span class="string">&#x27;支付方式（0-微信支付、1-支付宝支付、3-QQ钱包支付、4- 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">    mileage        <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">    pay_time       string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_pay_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       orderId,</span><br><span class="line">       real_pay_money,</span><br><span class="line">       has_coupon,</span><br><span class="line">       pay_way,</span><br><span class="line">       mileage,</span><br><span class="line">       pay_timefrom ods_didi.t_user_pay_orderwhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_evaluate</span><br><span class="line">(</span><br><span class="line">    id        string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">    orderId   string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    eva_level <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">    eva_time  string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_evaluate <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id, orderId, eva_level, eva_timefrom ods_didi.t_user_evaluatewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">-- 4.数据处理</span></span><br><span class="line"><span class="comment">-- 4.1 总订单笔数分析</span></span><br><span class="line"><span class="comment">-- 4.1.1计算4.12的总订单笔数分析</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> `时间`, <span class="built_in">count</span>(orderid) `订单总笔数`</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_total</span><br><span class="line">(</span><br><span class="line">    date_val string comment <span class="string">&#x27;日期(yyyy-MM-dd)&#x27;</span>,</span><br><span class="line">    count    <span class="type">int</span> comment <span class="string">&#x27;订单笔数&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;按月分区yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> app_didi.t_order_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> `时间`, <span class="built_in">count</span>(orderid) <span class="keyword">as</span> `订单时间`</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> app_didi.t_order_total;</span><br><span class="line"><span class="comment">-- 4.2 预约订单/非预约订单占比分析-- sum,avg,max,min-- 预约单/总单*100%</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_totalfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">       subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">       <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> subscribe_name;</span><br><span class="line"><span class="comment">--左连接</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date) <span class="keyword">as</span> `日期`, subscribe_name <span class="keyword">as</span> `是否预约`, <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t1</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_total <span class="keyword">from</span> dw_didi.t_user_order_wide <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">-- 隐式内连接</span></span><br><span class="line"><span class="keyword">select</span> `日期`, `是否预约`, concat(round(cnt <span class="operator">/</span> cnt_total <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date) <span class="keyword">as</span> `日期`, subscribe_name <span class="keyword">as</span> `是否预约`, <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t1,</span><br><span class="line">     (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_total <span class="keyword">from</span> dw_didi.t_user_order_wide <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">--开窗函数</span></span><br><span class="line"><span class="keyword">select</span> order_date     <span class="keyword">as</span>                                        `日期`,</span><br><span class="line">       subscribe_name <span class="keyword">as</span>                                        `是否预约`,</span><br><span class="line">       <span class="built_in">count</span>(subscribe_name) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subscribe_name) cnt,</span><br><span class="line">       <span class="built_in">count</span>() <span class="keyword">over</span> ()                                          cnt_totalfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">-- group by subscribe_name;</span></span><br><span class="line"><span class="comment">--开窗函数2</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(`日期`) <span class="keyword">as</span> `日期`, `是否预约`, concat(round(<span class="built_in">max</span>(cnt) <span class="operator">/</span> <span class="built_in">max</span>(cnt_total) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> order_date     <span class="keyword">as</span>                                        `日期`,</span><br><span class="line">             subscribe_name <span class="keyword">as</span>                                        `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subscribe_name) cnt,</span><br><span class="line">             <span class="built_in">count</span>() <span class="keyword">over</span> ()                                          cnt_total</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) tgroup <span class="keyword">by</span> `是否预约`;</span><br><span class="line"><span class="comment">--方法三</span></span><br><span class="line"><span class="keyword">select</span> `日期`, `是否预约`, concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date) <span class="keyword">as</span> `日期`, subscribe_name <span class="keyword">as</span> `是否预约`, <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_subscribe_percent</span><br><span class="line">(</span><br><span class="line">    date_val       string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    subscribe_name string comment <span class="string">&#x27;是否预约&#x27;</span>,</span><br><span class="line">    percent_val    string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> () <span class="operator">*</span></span><br><span class="line">       <span class="number">100</span><span class="keyword">from</span>(<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`, subscribe_name <span class="keyword">as</span> `是否预约`, <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt      <span class="keyword">from</span> dw_didi.t_user_order_wide      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_subscribe_percent <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> `日期`, `是否预约`, concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date) <span class="keyword">as</span> `日期`, subscribe_name <span class="keyword">as</span> `是否预约`, <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"><span class="comment">-- 4.3不同时段订单的个数</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_timerange_total</span><br><span class="line">(</span><br><span class="line">    datetime  string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    timerange string comment <span class="string">&#x27;时间段&#x27;</span>,</span><br><span class="line">    count     <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--sql</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt), order_time_range, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> order_time_range;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_timerange_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt), order_time_range, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> order_time_range;</span><br><span class="line"><span class="comment">--4.4不同年龄段、时段订单个数</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       age_range,</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_range, order_time_range;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_age_and_time_range_total</span><br><span class="line">(</span><br><span class="line">    datetime         string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    age_range        string comment <span class="string">&#x27;年龄段&#x27;</span>,</span><br><span class="line">    order_time_range string comment <span class="string">&#x27;时段&#x27;</span>,</span><br><span class="line">    count            <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_age_and_time_range_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       age_range,</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_range, order_time_range;</span><br><span class="line"><span class="comment">--4.4不同地域订单个数</span></span><br><span class="line"><span class="keyword">select</span> province, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> province;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_province_total</span><br><span class="line">(</span><br><span class="line">    datetime string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    province string comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    count    <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_province_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>, province, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cntfrom dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> province;</span><br><span class="line"><span class="comment">-- 4.5求订单客户职业排名top5</span></span><br><span class="line"><span class="comment">-- 第一步 ：按职业分组求客户数量</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt), profession, <span class="built_in">count</span>(orderId)</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_widewhere dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> profession;</span><br><span class="line"><span class="comment">-- 第二部 排名</span></span><br><span class="line"><span class="keyword">select</span> dt1, profession, cnt, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span> )</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> dt1, profession, <span class="built_in">count</span>(orderId) cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> profession) t;</span><br><span class="line"><span class="comment">-- 取前五</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> dt1, profession, cnt, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> dt1, profession, <span class="built_in">count</span>(orderId) cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession) t1) t2where rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="built_in">max</span>(dt) dt1, profession, <span class="built_in">count</span>(orderId) cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession),</span><br><span class="line">     t2 <span class="keyword">as</span> (<span class="keyword">select</span> dt1, profession, cnt, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk <span class="keyword">from</span> t1)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> t2where rk<span class="operator">&lt;=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.profession, t.cnt, <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession) t) ttwhere tt.rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_profession_total_topn</span><br><span class="line">(</span><br><span class="line">    profession string comment <span class="string">&#x27;职业&#x27;</span>,</span><br><span class="line">    Order_cnt  <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk         <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_profession_total_topn <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.profession, t.cnt, <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession) t) ttwhere tt.rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">--4.6用户订单取消占比</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>                                                date_val,</span><br><span class="line">       concat(round(t1.total_cnt <span class="operator">/</span> t2.total_cnt <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> cancel_order_percentfrom (<span class="keyword">select</span> <span class="built_in">count</span>(orderid) <span class="keyword">as</span> total_cnt      <span class="keyword">from</span> ods_didi.t_user_cancel_order      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t1        , (<span class="keyword">select</span> <span class="built_in">count</span>(orderid) <span class="keyword">as</span> total_cnt</span><br><span class="line">                                                                                                                                                                                                                  <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">                                                                                                                                                                                                                  <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">--创建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_order_percent</span><br><span class="line">(</span><br><span class="line">    datetime             string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    cancel_order_percent string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_cancel_order_percent <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>                                                date_val,</span><br><span class="line">       concat(round(t1.total_cnt <span class="operator">/</span> t2.total_cnt <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> percent_valfrom (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) total_cnt <span class="keyword">from</span> ods_didi.t_user_cancel_order <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t1        , (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) total_cnt</span><br><span class="line">                                                                                                                                                                                      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">                                                                                                                                                                                      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">-- 4.8统计用户取消订单原因top1</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (<span class="keyword">select</span> reason, profession, <span class="built_in">count</span>(reason) <span class="keyword">over</span> () cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_cancel_order</span><br><span class="line">            <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>),</span><br><span class="line">     t2 <span class="keyword">as</span> (<span class="keyword">select</span> reason, profession, cnt, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rk <span class="keyword">from</span> t1)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> t2where rk<span class="operator">&lt;=</span><span class="number">5</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_cancel_reason <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.profession, t.cnt, <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_cancel_order</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession) t) ttwhere tt.rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_reason</span><br><span class="line">(</span><br><span class="line">    profession string comment <span class="string">&#x27;职业&#x27;</span>,</span><br><span class="line">    cancel_cnt <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk         <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--统计每个省订单量最高的城市top3</span></span><br><span class="line"><span class="keyword">select</span> city, <span class="built_in">count</span>(city)</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_widewhere length(city) <span class="operator">&gt;</span> <span class="number">0</span><span class="keyword">group</span> <span class="keyword">by</span>  city;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_city <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.city, t.cnt, <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> city, <span class="built_in">count</span>(city) <span class="keyword">as</span> cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">where</span> length(city) <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> city) t) ttwhere tt.rk <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_city</span><br><span class="line">(</span><br><span class="line">    city      string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    order_cnt <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk        <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--统计订单支付中使用优惠券的百分比</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_dicount</span><br><span class="line">(</span><br><span class="line">    isdicount string comment <span class="string">&#x27;是否使用优惠券&#x27;</span>,</span><br><span class="line">    order_cnt string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_dicount <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> `是否使用优惠券`, concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> has_coupon <span class="keyword">as</span> `是否使用优惠券`, <span class="built_in">count</span>(has_coupon) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_pay_order</span><br><span class="line">      <span class="keyword">where</span> has_coupon <span class="operator">!=</span> <span class="number">17</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> has_coupon) t;</span><br><span class="line"><span class="comment">--统计用户五星级好评的百分比</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_five_start</span><br><span class="line">(</span><br><span class="line">    fivestart string comment <span class="string">&#x27;是否是5&#x27;</span>,</span><br><span class="line">    order_cnt string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_five_start <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> `是否是<span class="number">5</span>`, concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> eva_level <span class="keyword">as</span> `是否是<span class="number">5</span>`, <span class="built_in">count</span>(eva_level) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_evaluate</span><br><span class="line">      <span class="keyword">where</span> length(eva_level) <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> eva_level) t;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database app_edu_chat;</span><br><span class="line">use app_edu_chat;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_year</span><br><span class="line">(</span><br><span class="line">    date_year       <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day   <span class="type">varchar</span>(<span class="number">20</span>) comment  <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel  <span class="type">varchar</span>(<span class="number">20</span>) comment  <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">);</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_year \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_year/dt=2019</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_quater</span><br><span class="line">(</span><br><span class="line">    date_year   <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_quater <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel   <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_quater \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_quater/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.total_month</span><br><span class="line">(</span><br><span class="line">    date_year  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day   <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel  <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table total_month \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/total_month/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.area_day</span><br><span class="line">(</span><br><span class="line">    date_year <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    province  <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    total_pel <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table area_day \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/area_day/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.click_tender</span><br><span class="line">(</span><br><span class="line">    date_year     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    province      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_      <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">) ;</span><br><span class="line">sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table click_tender \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/click_tender/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.vis_tender</span><br><span class="line">(</span><br><span class="line">    date_year      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_       <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table vis_tender \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/vis_tender/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.vis_per_hour</span><br><span class="line">(</span><br><span class="line"></span><br><span class="line">    date_hour <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    con_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table vis_per_hour \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/vis_per_hour/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.dif_channel</span><br><span class="line">(</span><br><span class="line">    chennel_c       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    visiting <span class="type">int</span>,</span><br><span class="line">    percent_        <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table dif_channel \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/dif_channel/dt=2019</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.dif_source</span><br><span class="line">(</span><br><span class="line">    source_c           <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    visit_count <span class="type">int</span>,</span><br><span class="line">    percent_           <span class="type">varchar</span>(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table dif_source \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/dif_source/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu_chat.top_web</span><br><span class="line">(</span><br><span class="line">    date_year      <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_month     <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    date_day       <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    brouse_name    <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    vis_cnt <span class="type">int</span></span><br><span class="line">)</span><br><span class="line">    sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_edu_chat \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table top_web \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_edu.db/top_web/dt=2019</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database ods_edu;</span><br><span class="line">use ods_edu;</span><br><span class="line"><span class="comment">-- create table if not exists</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> database dw_edu;</span><br><span class="line"><span class="keyword">create</span> database app_edu;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_edu.t_edu_chat</span><br><span class="line">(</span><br><span class="line">    id                           <span class="type">int</span> comment <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    create_date_time             <span class="type">timestamp</span> comment <span class="string">&#x27;数据创建时间&#x27;</span>,</span><br><span class="line">    sid                          string comment <span class="string">&#x27;访客id&#x27;</span>,</span><br><span class="line">    create_time                  <span class="type">timestamp</span> comment <span class="string">&#x27;会话创建时间&#x27;</span>,</span><br><span class="line">    seo_source                   string comment <span class="string">&#x27;搜索来源&#x27;</span>,</span><br><span class="line">    seo_keywords                 string comment <span class="string">&#x27;关键字&#x27;</span>,</span><br><span class="line">    ip                           string comment <span class="string">&#x27;IP地址&#x27;</span>,</span><br><span class="line">    area                         string comment <span class="string">&#x27;地域&#x27;</span>,</span><br><span class="line">    country                      string comment <span class="string">&#x27;所在国家&#x27;</span>,</span><br><span class="line">    province                     string comment <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">    city                         string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    origin_channel               string comment <span class="string">&#x27;投放渠道&#x27;</span>,</span><br><span class="line">    `<span class="keyword">user</span>`                       string comment <span class="string">&#x27;所属坐席&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    manual_time                  <span class="type">timestamp</span> comment <span class="string">&#x27;人工开始时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    begin_time                   <span class="type">timestamp</span> comment <span class="string">&#x27;坐席领取时间 &#x27;</span>,</span><br><span class="line"></span><br><span class="line">    end_time                     <span class="type">timestamp</span> comment <span class="string">&#x27;会话结束时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    last_customer_msg_time_stamp <span class="type">timestamp</span> comment <span class="string">&#x27;客户最后一条消息的时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    last_agent_msg_time_stamp    <span class="type">timestamp</span> comment <span class="string">&#x27;坐席最后一下回复的时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    reply_msg_count              <span class="type">int</span> comment <span class="string">&#x27;客服回复消息数&#x27;</span>,</span><br><span class="line">    msg_count                    <span class="type">int</span> comment <span class="string">&#x27;客户发送消息数&#x27;</span>,</span><br><span class="line">    browser_name                 string comment <span class="string">&#x27;浏览器名称&#x27;</span>,</span><br><span class="line">    os_info                      string comment <span class="string">&#x27;系统名称&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_edu.t_edu_chat <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       create_date_time,</span><br><span class="line">       sid,</span><br><span class="line">       create_time,</span><br><span class="line"></span><br><span class="line">       seo_source comment,</span><br><span class="line">       seo_keywords,</span><br><span class="line">       ip,</span><br><span class="line">       area,</span><br><span class="line">       country,</span><br><span class="line">       province,</span><br><span class="line">       city,</span><br><span class="line">       origin_channel,</span><br><span class="line">       `<span class="keyword">user</span>`,</span><br><span class="line">       manual_time,</span><br><span class="line"></span><br><span class="line">       begin_time,</span><br><span class="line"></span><br><span class="line">       end_time,</span><br><span class="line"></span><br><span class="line">       last_customer_msg_time_stamp,</span><br><span class="line"></span><br><span class="line">       last_agent_msg_time_stamp,</span><br><span class="line"></span><br><span class="line">       reply_msg_count,</span><br><span class="line">       msg_count,</span><br><span class="line">       browser_name,</span><br><span class="line">       os_info</span><br><span class="line"><span class="keyword">from</span> web_chat_ems_2019_07;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--1.总访问客户量</span></span><br><span class="line"><span class="comment">-- 1.1年日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_year</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_year <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2020&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">--1.2季度日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_quater</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_quater string comment <span class="string">&#x27;季度&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_quater <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)    <span class="keyword">AS</span> `年份`,</span><br><span class="line">       QUARTER(create_time) <span class="keyword">AS</span> `季度`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)     <span class="keyword">AS</span> `日期`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)  <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> QUARTER(create_time) <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--1.3月日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.total_month</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string comment <span class="string">&#x27;月份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.total_month <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">-- 2 	地区独立访客热力图</span></span><br><span class="line"><span class="comment">-- 2.1.1 地区日</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.area_day</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_day string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    province string ,</span><br><span class="line">    total_pel   string comment <span class="string">&#x27;访问客户量&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.area_day <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日`,</span><br><span class="line">       province            <span class="keyword">AS</span> `省份`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> create_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">YEAR</span>(create_time) <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2020&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"><span class="comment">-- 2.2 地区月</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--2.2季度日</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)    <span class="keyword">AS</span> `年份`,</span><br><span class="line">       QUARTER(create_time) <span class="keyword">AS</span> `季度`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)     <span class="keyword">AS</span> `日期`,</span><br><span class="line">       province             <span class="keyword">AS</span> `省份`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)  <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> QUARTER(create_time) <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), QUARTER(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"></span><br><span class="line"><span class="comment">--2.3 month</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">       <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">       <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">       province,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="string">&#x27;2019&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- SELECT province, COUNT(DISTINCT CASE WHEN msg_count &gt; 0 THEN sid END) AS `咨询人数`</span></span><br><span class="line"><span class="comment">-- FROM dw_edu.t_edu_chat</span></span><br><span class="line"><span class="comment">-- GROUP BY province;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.	访客咨询率趋势</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.click_tender</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    province string ,</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.click_tender <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">    <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">    <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">    province, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="keyword">AS</span> `咨询人数`,</span><br><span class="line">       concat(round(<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="operator">/</span> total.total_consultations <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> `百分比`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line">         <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="keyword">AS</span> total_consultations <span class="keyword">FROM</span> dw_edu.t_edu_chat) <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time), province, total.total_consultations;</span><br><span class="line"></span><br><span class="line"><span class="comment">--4.	客户访问量和访客咨询率双轴趋势</span></span><br><span class="line"><span class="comment">-- concat(round( COUNT(DISTINCT CASE WHEN msg_count &gt; 0 THEN sid END) / COUNT(DISTINCT sid) * 100, 2), &#x27;%&#x27;) as `百分比`</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.vis_tender</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    con_cnt <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.vis_tender <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span>     <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">           <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">           <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `客户访问量`,</span><br><span class="line">           concat(round( <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> msg_count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> sid <span class="keyword">END</span>) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)  <span class="keyword">AS</span> `咨询率`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="comment">-- WHERE create_time BETWEEN &#x27;2019-01-01&#x27; AND &#x27;2020&#x27; -- 替换为实际的日期范围</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(create_time), <span class="keyword">MONTH</span>(create_time), <span class="keyword">DAY</span>(create_time);</span><br><span class="line"><span class="comment">-- 5.	时间段访问客户量趋势</span></span><br><span class="line"><span class="comment">-- 指定时间段的起始日期和结束日期</span></span><br><span class="line"><span class="comment">-- DECLARE @start_date DATE = &#x27;开始日期&#x27;;</span></span><br><span class="line"><span class="comment">-- DECLARE @end_date DATE = &#x27;结束日期&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询指定时间段内每个小时的访问客户量</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.vis_per_hour</span><br><span class="line">(</span><br><span class="line"></span><br><span class="line">    date_hour string,</span><br><span class="line">    con_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.vis_per_hour <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">HOUR</span>(create_time) <span class="keyword">AS</span> `小时`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="comment">-- WHERE create_date_time &gt;= @start_date AND create_date_time &lt;= @end_date</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">HOUR</span>(create_time);</span><br><span class="line"><span class="comment">-- 6.</span></span><br><span class="line"><span class="comment">-- 查询指定时间段内不同来源渠道和小时的访问客户量</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.dif_channel</span><br><span class="line">(</span><br><span class="line">    chennel_c string,</span><br><span class="line">    visiting <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.dif_channel <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> origin_channel <span class="keyword">AS</span> `来源渠道`,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> `访问客户量`,</span><br><span class="line">       concat(round(        <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> (</span><br><span class="line">           <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)</span><br><span class="line">           <span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"></span><br><span class="line">       ) , <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)   <span class="keyword">AS</span> `占比`</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> origin_channel</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> origin_channel;</span><br><span class="line"><span class="comment">-- 7.</span></span><br><span class="line"><span class="comment">-- 指定时间段的起始日期和结束日期</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.dif_source</span><br><span class="line">(</span><br><span class="line">    source_c string,</span><br><span class="line">visit_count <span class="type">int</span>,</span><br><span class="line">    percent_ string</span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.dif_source <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    seo_source,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="keyword">AS</span> visitor_count,</span><br><span class="line">    concat(round(    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> sid)</span><br><span class="line">        <span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"></span><br><span class="line">    )  , <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>)   <span class="keyword">AS</span> visitor_ratio</span><br><span class="line"><span class="keyword">FROM</span> dw_edu.t_edu_chat</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> seo_source;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 8.</span></span><br><span class="line"><span class="comment">-- 查询访问客户量最多的页面排行榜</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_edu.top_web</span><br><span class="line">(</span><br><span class="line">    date_year       string comment <span class="string">&#x27;年份&#x27;</span>,</span><br><span class="line">    date_month string ,</span><br><span class="line">    date_day string,</span><br><span class="line">    brouse_name string,</span><br><span class="line">    vis_cnt <span class="type">int</span></span><br><span class="line"></span><br><span class="line">) partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2019&#x27;</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_edu.top_web <span class="keyword">partition</span> (dt  <span class="operator">=</span><span class="string">&#x27;2019&#x27;</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(create_time)   <span class="keyword">AS</span> `年份`,</span><br><span class="line">           <span class="keyword">MONTH</span>(create_time)  <span class="keyword">AS</span> `月份`,</span><br><span class="line">           <span class="keyword">DAY</span>(create_time)    <span class="keyword">AS</span> `日期`,</span><br><span class="line">    browser_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">AS</span> visitor_count</span><br><span class="line"><span class="keyword">FROM</span> ods_edu.web_chat_ems_2019_07</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> browser_name,<span class="keyword">YEAR</span>(create_time),<span class="keyword">MONTH</span>(create_time),<span class="keyword">DAY</span>(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> visitor_count <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/07/03/%E4%B8%89%E3%80%81%E5%9F%BA%E6%9C%ACsql/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/07/03/%E4%B8%89%E3%80%81%E5%9F%BA%E6%9C%ACsql/" class="post-title-link" itemprop="url">三、基本sql</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-03 10:24:09" itemprop="dateCreated datePublished" datetime="2023-07-03T10:24:09+08:00">2023-07-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 15:14:06" itemprop="dateModified" datetime="2023-07-05T15:14:06+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="一、数据库创建与删除"><a href="#一、数据库创建与删除" class="headerlink" title="一、数据库创建与删除"></a>一、数据库创建与删除</h3><h5 id="1-强制删除数据库"><a href="#1-强制删除数据库" class="headerlink" title="1.强制删除数据库"></a>1.强制删除数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database itcast  cascade;</span><br></pre></td></tr></table></figure><h5 id="2-创建数据库"><a href="#2-创建数据库" class="headerlink" title="2.创建数据库"></a>2.创建数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> myhive;</span><br></pre></td></tr></table></figure><h5 id="3-切换使用数据库"><a href="#3-切换使用数据库" class="headerlink" title="3. 切换使用数据库"></a>3. 切换使用数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use  myhive;</span><br></pre></td></tr></table></figure><h5 id="4-查看数据库详细信息"><a href="#4-查看数据库详细信息" class="headerlink" title="4. 查看数据库详细信息"></a>4. 查看数据库详细信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span>  database  myhive;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/57.png" alt="1688351390598"></p><h5 id="5-删除数据库"><a href="#5-删除数据库" class="headerlink" title="5.删除数据库"></a>5.删除数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span>  database  myhive;</span><br></pre></td></tr></table></figure><h5 id="6-查询当前数据库"><a href="#6-查询当前数据库" class="headerlink" title="6.查询当前数据库"></a>6.查询当前数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> current_database();</span><br></pre></td></tr></table></figure><h3 id="二、数据库表"><a href="#二、数据库表" class="headerlink" title="二、数据库表"></a>二、数据库表</h3><h5 id="1-删除表"><a href="#1-删除表" class="headerlink" title="1.删除表"></a>1.删除表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> biao ;</span><br></pre></td></tr></table></figure><h5 id="2-创建表"><a href="#2-创建表" class="headerlink" title="2.创建表"></a>2.创建表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_archer(  id <span class="type">int</span> comment &quot;ID&quot;,</span><br><span class="line">                        name string comment &quot;英雄名称&quot;,</span><br><span class="line">                        hp_max <span class="type">int</span> comment &quot;最大生命&quot;,</span><br><span class="line">                         mp_max <span class="type">int</span> comment &quot;最大法力&quot;,</span><br><span class="line">                         attack_max <span class="type">int</span> comment &quot;最高物攻&quot;,</span><br><span class="line">                          defense_max <span class="type">int</span> comment &quot;最大物防&quot;,</span><br><span class="line">                            attack_range string comment &quot;攻击范围&quot;,</span><br><span class="line">                             role_main string comment &quot;主要定位&quot;,</span><br><span class="line">                             role_assist string comment &quot;次要定位&quot;</span><br><span class="line">) comment &quot;王者荣耀射手信息&quot;  <span class="type">row</span> format delimited</span><br><span class="line">fields terminated <span class="keyword">by</span> &quot;\t&quot;;</span><br></pre></td></tr></table></figure><h5 id="3-Hive建表时候的字段类型"><a href="#3-Hive建表时候的字段类型" class="headerlink" title="3.Hive建表时候的字段类型"></a>3.Hive建表时候的字段类型</h5><table><thead><tr><th><strong>分类</strong></th><th><strong>类型</strong></th><th><strong>描述</strong></th><th><strong>字面量示例</strong></th></tr></thead><tbody><tr><td>原始类型</td><td>BOOLEAN</td><td>true&#x2F;false</td><td>TRUE</td></tr><tr><td></td><td>TINYINT</td><td>1字节的有符号整数 -128~127</td><td>1Y</td></tr><tr><td></td><td>SMALLINT</td><td>2个字节的有符号整数，-32768~32767</td><td>1S</td></tr><tr><td></td><td>INT</td><td>4个字节的带符号整数</td><td>1</td></tr><tr><td></td><td>BIGINT</td><td>8字节带符号整数</td><td>1L</td></tr><tr><td></td><td>FLOAT</td><td>4字节单精度浮点数1.0</td><td></td></tr><tr><td></td><td>DOUBLE</td><td>8字节双精度浮点数</td><td>1.0</td></tr><tr><td></td><td>DEICIMAL</td><td>任意精度的带符号小数</td><td>1.0</td></tr><tr><td></td><td>STRING</td><td>字符串，变长</td><td>“a”,’b’</td></tr><tr><td></td><td>VARCHAR</td><td>变长字符串</td><td>“a”,’b’</td></tr><tr><td></td><td>CHAR</td><td>固定长度字符串</td><td>“a”,’b’</td></tr><tr><td></td><td>BINARY</td><td>字节数组</td><td>无法表示</td></tr><tr><td></td><td>TIMESTAMP</td><td>时间戳，毫秒值精度</td><td>122327493795</td></tr><tr><td></td><td>DATE</td><td>日期</td><td>‘2016-03-29’</td></tr><tr><td></td><td><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types#LanguageManualTypes-Intervals">INTERVAL</a></td><td>时间频率间隔</td><td></td></tr><tr><td>复杂类型</td><td>ARRAY</td><td>有序的的同类型的集合</td><td>array(1,2)</td></tr><tr><td></td><td>MAP</td><td>key-value,key必须为原始类型，value可以任意类型</td><td>map(‘a’,1,’b’,2)</td></tr><tr><td></td><td>STRUCT</td><td>字段集合,类型可以不同</td><td>struct(‘1’,1,1.0), named_stract(‘col1’,’1’,’col2’,1,’clo3’,1.0)</td></tr><tr><td></td><td>UNION</td><td>在有限取值范围内的一个值</td><td>create_union(1,’a’,63)</td></tr></tbody></table><h5 id="4-创建内部表"><a href="#4-创建内部表" class="headerlink" title="4.创建内部表"></a>4.创建内部表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> student_exter(</span><br><span class="line">sid string</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h5 id="5-根据查询结果创建表"><a href="#5-根据查询结果创建表" class="headerlink" title="5.根据查询结果创建表"></a>5.根据查询结果创建表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"><span class="keyword">select</span> sid,sname,sbirth,ssex <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure><h5 id="6-去重结果"><a href="#6-去重结果" class="headerlink" title="6.去重结果"></a>6.去重结果</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> ssex</span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> ssex,sname,sbirth</span><br><span class="line"><span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure><h5 id="7-根据已经存在的表结构创建表"><a href="#7-根据已经存在的表结构创建表" class="headerlink" title="7.根据已经存在的表结构创建表"></a>7.根据已经存在的表结构创建表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu4 <span class="keyword">like</span> stu2;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu4;</span><br><span class="line">注意: 只拷贝指定表的结构, 不拷贝表的数据 </span><br></pre></td></tr></table></figure><h5 id="8-查询表的类型"><a href="#8-查询表的类型" class="headerlink" title="8.查询表的类型"></a>8.查询表的类型</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> formatted  stu2;</span><br></pre></td></tr></table></figure><p>显示表的简要信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span>  stu2;</span><br></pre></td></tr></table></figure><h5 id="9-数据装载载命令Load"><a href="#9-数据装载载命令Load" class="headerlink" title="9.数据装载载命令Load"></a>9.数据装载载命令Load</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data [<span class="keyword">local</span>] inpath <span class="string">&#x27;/export/data/hive_data/student.txt&#x27;</span> [overwrite] <span class="keyword">into</span> <span class="keyword">table</span> student [<span class="keyword">partition</span> (partcol1<span class="operator">=</span>val1,…)];</span><br></pre></td></tr></table></figure><p>1、load data:表示加载数据</p><p>2、local: 表示从本地加载数据到hive表；否则从HDFS加载数据到hive表</p><p>3、inpath:表示加载数据的路径</p><p>4、overwrite:表示覆盖表中已有数据，否则表示追加</p><p>5、into table:表示加载到哪张表</p><p>6、student:表示具体的表</p><p>7、partition:表示上传到指定分区</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ssex</span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">all</span> ssex</span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去重结果</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> ssex</span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> ssex,sname,sbirth</span><br><span class="line"><span class="keyword">from</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">where</span> <span class="number">1</span><span class="operator">&gt;</span><span class="number">2</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">where</span> sname<span class="operator">=</span>&quot;李勇&quot;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">where</span>  length(sname)<span class="operator">&gt;</span><span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> sid</span><br><span class="line"><span class="keyword">from</span> student</span><br><span class="line"><span class="keyword">where</span> (sid)<span class="operator">&gt;</span><span class="number">95005</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--4、聚合操作</span></span><br><span class="line"><span class="comment">--统计美国总共有多少个县county</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(sid) <span class="keyword">from</span> student;</span><br><span class="line"><span class="comment">--统计美国加州有多少个县</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(sid) <span class="keyword">from</span> student <span class="keyword">where</span> sname <span class="operator">=</span> &quot;李峰&quot;;</span><br><span class="line"><span class="comment">--统计德州总死亡病例数</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(sid) <span class="keyword">from</span> student <span class="keyword">where</span> sname <span class="operator">=</span> &quot;李峰&quot;;</span><br><span class="line"><span class="comment">--统计出美国最高确诊病例数是哪个县  select max(cases) from t_usa_covid19;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- --5、GROUP BY</span></span><br><span class="line"><span class="comment">-- --根据state州进行分组 统计每个州有多少个县county</span></span><br><span class="line"><span class="comment">-- select count(county) from student where count_date = &quot;2021-01-28&quot; group by state;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- --想看一下统计的结果是属于哪一个州的</span></span><br><span class="line"><span class="comment">-- select state,count(county) from student where count_date = &quot;2021-01-28&quot; group by state;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- --再想看一下每个县的死亡病例数，我们猜想很简单呀	把deaths字段加上返回	真实情况如何呢？</span></span><br><span class="line"><span class="comment">-- select state,count(county),deaths fromstudent where count_date = &quot;2021-01-28&quot; group by state;</span></span><br><span class="line"><span class="comment">-- --很尴尬 sql报错了org.apache.hadoop.hive.ql.parse.SemanticException:Line 1:27 Expression not in GROUP BY key &#x27;deaths&#x27;</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- --为什么会报错？？group by的语法限制</span></span><br><span class="line"><span class="comment">-- --结论：出现在GROUP BY中select_expr的字段：要么是GROUP BY分组的字段；要么是被聚合函数应用的字段。</span></span><br><span class="line"><span class="comment">-- --deaths不是分组字段 报错</span></span><br><span class="line"><span class="comment">-- --state是分组字段 可以直接出现在select_expr中</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- --被聚合函数应用</span></span><br><span class="line"><span class="comment">-- select state,count(county),sum(deaths) from t_usa_covid19 where count_date = &quot;2021-01-28&quot; group by state;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">------------String Functions 字符串函数------------</span></span><br><span class="line"><span class="keyword">select</span> length(&quot;itcast&quot;);</span><br><span class="line"><span class="keyword">select</span> reverse(&quot;itcast&quot;);</span><br><span class="line"><span class="keyword">select</span> concat(&quot;angela&quot;,&quot;baby&quot;);</span><br><span class="line"><span class="comment">--带分隔符字符串连接函数：concat_ws(separator, [string | array(string)]+)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> concat_ws(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;www&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;itcast&#x27;</span>, <span class="string">&#x27;cn&#x27;</span>));</span><br><span class="line"><span class="comment">--字符串截取函数：substr(str, pos[, len]) 或者 substring(str, pos[, len])</span></span><br><span class="line"><span class="keyword">select</span> substr(&quot;angelababy&quot;,<span class="number">-2</span>); <span class="comment">--pos是从1开始的索引，如果为负数则倒着数</span></span><br><span class="line"><span class="keyword">select</span> substr(&quot;angelababy&quot;,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">--分割字符串函数: split(str, regex)</span></span><br><span class="line"><span class="operator">-</span><span class="keyword">select</span> split(<span class="string">&#x27;apache hive&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">----------- Date Functions 日期函数 -----------------</span></span><br><span class="line"><span class="comment">--获取当前日期: current_date</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">current_date</span>();</span><br><span class="line"><span class="comment">--获取当前UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">select</span> unix_timestamp();</span><br><span class="line"><span class="comment">--日期转UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">select</span> unix_timestamp(&quot;2011-12-07 13:01:03&quot;);</span><br><span class="line"><span class="comment">--指定格式日期转UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">select</span> unix_timestamp(<span class="string">&#x27;20111207 13:01:03&#x27;</span>,<span class="string">&#x27;yyyyMMdd HH:mm:ss&#x27;</span>);</span><br><span class="line"><span class="comment">--UNIX时间戳转日期函数: from_unixtime</span></span><br><span class="line"><span class="keyword">select</span> from_unixtime(<span class="number">1618238391</span>);</span><br><span class="line"><span class="keyword">select</span> from_unixtime(<span class="number">0</span>, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>);</span><br><span class="line"><span class="comment">--日期比较函数: datediff 日期格式要求&#x27;yyyy-MM-dd HH:mm:ss&#x27; or &#x27;yyyy-MM-dd&#x27;</span></span><br><span class="line"><span class="keyword">select</span> datediff(<span class="string">&#x27;2012-12-08&#x27;</span>,<span class="string">&#x27;2012-05-09&#x27;</span>);</span><br><span class="line"><span class="comment">--日期增加函数: date_add</span></span><br><span class="line"><span class="keyword">select</span> date_add(<span class="string">&#x27;2012-02-28&#x27;</span>,<span class="number">10</span>);</span><br><span class="line"><span class="comment">--日期减少函数: date_sub</span></span><br><span class="line"><span class="keyword">select</span> date_sub(<span class="string">&#x27;2012-01-1&#x27;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">----Mathematical Functions 数学函数-------------</span></span><br><span class="line"><span class="comment">--取整函数: round  返回double类型的整数值部分 （遵循四舍五入）</span></span><br><span class="line"><span class="keyword">select</span> round(<span class="number">3.1415926</span>);</span><br><span class="line"><span class="comment">--指定精度取整函数: round(double a, int d) 返回指定精度d的double类型</span></span><br><span class="line"><span class="keyword">select</span> round(<span class="number">3.1415926</span>,<span class="number">4</span>);</span><br><span class="line"><span class="comment">--取随机数函数: rand 每次执行都不一样 返回一个0到1范围内的随机数</span></span><br><span class="line"><span class="keyword">select</span> rand();</span><br><span class="line"><span class="comment">--指定种子取随机数函数: rand(int seed) 得到一个稳定的随机数序列</span></span><br><span class="line"><span class="keyword">select</span> rand(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-----Conditional Functions 条件函数------------------</span></span><br><span class="line"><span class="comment">--使用之前课程创建好的student表数据</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student limit <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--if条件判断: if(boolean testCondition, T valueTrue, T valueFalseOrNull)</span></span><br><span class="line"><span class="keyword">select</span> if(<span class="number">1</span><span class="operator">=</span><span class="number">2</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br><span class="line"><span class="keyword">select</span> if(sex <span class="operator">=</span><span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;W&#x27;</span>) <span class="keyword">from</span> student limit <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--空值转换函数: nvl(T value, T default_value)</span></span><br><span class="line"><span class="keyword">select</span> nvl(&quot;allen&quot;,&quot;itcast&quot;);</span><br><span class="line"><span class="keyword">select</span> nvl(<span class="keyword">null</span>,&quot;itcast&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">--条件转换函数: CASE a WHEN b THEN c [WHEN d THEN e]* [ELSE f] END</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">case</span> <span class="number">100</span> <span class="keyword">when</span> <span class="number">50</span> <span class="keyword">then</span> <span class="string">&#x27;tom&#x27;</span> <span class="keyword">when</span> <span class="number">100</span> <span class="keyword">then</span> <span class="string">&#x27;mary&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;tim&#x27;</span> <span class="keyword">end</span>;  <span class="keyword">select</span> <span class="keyword">case</span> sex <span class="keyword">when</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;male&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;female&#x27;</span> <span class="keyword">end</span> <span class="keyword">from</span> student limit <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_access (</span><br><span class="line">     group_id string,</span><br><span class="line">     createtime string, <span class="comment">--day</span></span><br><span class="line">     pv <span class="type">int</span></span><br><span class="line">)<span class="type">row</span> format DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/hivedata/group_access.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> user_access;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> group_id, createtime, pv,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn1,</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">as</span> rn2,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">as</span> rn3 <span class="keyword">from</span> user_access;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> group_id, createtime, pv,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn1,</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">as</span> rn2,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> createtime <span class="keyword">order</span> <span class="keyword">by</span> pv <span class="keyword">desc</span>) <span class="keyword">as</span> rn3 <span class="keyword">from</span> user_access;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>sqoop import<br>–connect jdbc:mysql:&#x2F;&#x2F;node1:3306&#x2F;<br>–username root<br>–password 123456<br>–table web_chat_ems_2019_07<br>–warehouse-dir &#x2F;user&#x2F;hive&#x2F;warehouse –hive-database ods_edu<br>–hive-import<br>–hive-table web_chat_ems_2019_07</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/07/01/2023.7.1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/07/01/2023.7.1/" class="post-title-link" itemprop="url">四、一些sql操作</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-01 16:36:24" itemprop="dateCreated datePublished" datetime="2023-07-01T16:36:24+08:00">2023-07-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 15:14:54" itemprop="dateModified" datetime="2023-07-05T15:14:54+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>静态分区</p><p><img src="/images/loading.gif" data-original="/images/heima/36.png" alt="1688174613774"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 静态分区</span><br><span class="line">#添加 </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_user_order_wide <span class="keyword">add</span> <span class="keyword">partition</span>(dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">#删除</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_user_order_wide <span class="keyword">drop</span> <span class="keyword">partition</span>(dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/37.png" alt="1688174904462"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--动态分区</span></span><br><span class="line">load dat <span class="keyword">local</span> inpath <span class="string">&#x27;&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> t_user_order_wide <span class="keyword">partition</span>();</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/38.png" alt="1688175021930"></p><p><img src="/images/loading.gif" data-original="/images/heima/39.png" alt="1688175061960"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 追加</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> student2</span><br><span class="line"><span class="keyword">select</span> sid,</span><br><span class="line">name,</span><br><span class="line">if(sage<span class="operator">&gt;=</span><span class="number">19</span>,<span class="string">&#x27;一班&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--复写</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> student2</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">sid ,</span><br><span class="line">sname,</span><br><span class="line">if(sage<span class="operator">&gt;=</span><span class="number">19</span>,<span class="string">&#x27;一班&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure><p>例子</p><p><img src="/images/loading.gif" data-original="/images/heima/40.png" alt="1688176266372"></p><p><img src="/images/loading.gif" data-original="/images/heima/41.png" alt="1688176315289"></p><p><img src="/images/loading.gif" data-original="/images/heima/42.png" alt="1688176460796"></p><p><img src="/images/loading.gif" data-original="/images/heima/43.png" alt="1688176541640"></p><p><img src="/images/loading.gif" data-original="/images/heima/44.png" alt="1688176559583"></p><p>删除数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> score3;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/45.png" alt="1688176710299"></p><p><img src="/images/loading.gif" data-original="/images/heima/46.png" alt="1688176812655"></p><p><img src="/images/loading.gif" data-original="/images/heima/47.png" alt="1688177060783"></p><p><img src="/images/loading.gif" data-original="/images/heima/48.png" alt="1688177088582">复制表结构</p><p><img src="/images/loading.gif" data-original="/images/heima/49.png" alt="1688177517555"></p><p>分桶</p><p><img src="/images/loading.gif" data-original="/images/heima/50.png" alt="1688177665812"></p><p><img src="/images/loading.gif" data-original="/images/heima/51.png" alt="1688180101660"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.数据仓库构建</span></span><br><span class="line"><span class="comment">-- 1.1创建ods库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi;</span><br><span class="line"><span class="comment">-- 1.2创建dw数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi;</span><br><span class="line"><span class="comment">-- 1.3创建app数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi;</span><br><span class="line"></span><br><span class="line">use ods_didi;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.在ods层创建表</span></span><br><span class="line"><span class="comment">-- 2.1创建订单结构表</span></span><br><span class="line"><span class="comment">-- 创建用户订单表结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_order</span><br><span class="line">(</span><br><span class="line">    orderId         string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone       string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng             string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat             string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province        string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city            string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money        <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender          string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession      string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range       string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip             <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe       <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    sub_time        string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent        <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    agent_telephone string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time      string comment <span class="string">&#x27;订单时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ods创建取消订单表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_cancel_order</span><br><span class="line">(</span><br><span class="line">    orderId        string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    cstm_telephone string comment <span class="string">&#x27;客户联系电话&#x27;</span>,</span><br><span class="line">    lng            string comment <span class="string">&#x27;取消订单的经度&#x27;</span>,</span><br><span class="line">    lat            string comment <span class="string">&#x27;取消订单的纬度&#x27;</span>,</span><br><span class="line">    province       string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city           string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_distance    <span class="keyword">double</span> comment <span class="string">&#x27;预估距离&#x27;</span>,</span><br><span class="line">    gender         string comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    profession     string comment <span class="string">&#x27;行业&#x27;</span>,</span><br><span class="line">    age_range      string comment <span class="string">&#x27;年龄段&#x27;</span>,</span><br><span class="line">    reason         <span class="type">int</span> comment <span class="string">&#x27;取消订单原因（1 - 选择了其他交通方式、2 - 与司机达成一致，取消订单、3 - 投诉司机没来接我、4 - 已不需要用车、5 - 无理由取消订单）&#x27;</span>,</span><br><span class="line">    cancel_time    string comment <span class="string">&#x27;取消时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ods创建订单表支付表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_pay_order</span><br><span class="line">(</span><br><span class="line">    id                         string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">    orderId                    string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    lng                        string comment <span class="string">&#x27;目的地的经度（支付地址）&#x27;</span>,</span><br><span class="line">    lat                        string comment <span class="string">&#x27;目的地的纬度（支付地址）&#x27;</span>,</span><br><span class="line">    province                   string comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    city                       string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    total_money                <span class="keyword">double</span> comment <span class="string">&#x27;车费总价&#x27;</span>,</span><br><span class="line">    real_pay_money             <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">    passenger_additional_money <span class="keyword">double</span> comment <span class="string">&#x27;乘客额外加价&#x27;</span>,</span><br><span class="line">    base_money                 <span class="keyword">double</span> comment <span class="string">&#x27;车费合计&#x27;</span>,</span><br><span class="line">    has_coupon                 <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">    coupon_total               <span class="keyword">double</span> comment <span class="string">&#x27;优惠券合计&#x27;</span>,</span><br><span class="line">    pay_way                    <span class="type">int</span> comment <span class="string">&#x27;支付方式（0 - 微信支付、1 - 支付宝支付、3 - QQ钱包支付、4 - 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">    mileage                    <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">    pay_time                   string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- ods创建用户评价表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_evaluate</span><br><span class="line">(</span><br><span class="line">    id                  string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">    orderId             string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    passenger_telephone string comment <span class="string">&#x27;用户电话&#x27;</span>,</span><br><span class="line">    passenger_province  string comment <span class="string">&#x27;用户所在省份&#x27;</span>,</span><br><span class="line">    passenger_city      string comment <span class="string">&#x27;用户所在城市&#x27;</span>,</span><br><span class="line">    eva_level           <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">    eva_time            string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建数据仓库 导入数据</span></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/cancel_order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_cancel_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/pay.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_pay_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/evaluate.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_evaluate <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"><span class="comment">-- truncate table dw_didi.t_user_pay_order;</span></span><br><span class="line"><span class="comment">-- 3.在dw层进行数据预处理</span></span><br><span class="line">use dw_didi;</span><br><span class="line"><span class="comment">-- 创建宽表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_order_wide</span><br><span class="line">(</span><br><span class="line">    orderId          string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone        string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng              string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat              string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province         string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city             string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money         <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender           string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession       string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range        string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip              <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe        <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    subscribe_name   string comment <span class="string">&#x27;是否预约名称&#x27;</span>,</span><br><span class="line">    sub_time         string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent         <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    is_agent_name    string comment <span class="string">&#x27;是否代缴名称&#x27;</span>,</span><br><span class="line">    agent_telephone  string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time       string comment <span class="string">&#x27;订单时间&#x27;</span>,</span><br><span class="line">    order_date       string comment <span class="string">&#x27;订单时间，yyyy-MM-dd&#x27;</span>,</span><br><span class="line">    order_year       string comment <span class="string">&#x27;年&#x27;</span>,</span><br><span class="line">    order_month      string comment <span class="string">&#x27;月&#x27;</span>,</span><br><span class="line">    order_day        string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    order_hour       string comment <span class="string">&#x27;小时&#x27;</span>,</span><br><span class="line">    order_time_range string comment <span class="string">&#x27;时间段&#x27;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预处理sql语句 用户订单处理</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_order_wide <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> orderid,</span><br><span class="line">       telephone,</span><br><span class="line">       lng,</span><br><span class="line">       lat,</span><br><span class="line">       province,</span><br><span class="line">       city,</span><br><span class="line">       es_money,</span><br><span class="line">       gender,</span><br><span class="line">       profession,</span><br><span class="line">       age_range,</span><br><span class="line">       tip,</span><br><span class="line">       subscribe,</span><br><span class="line"><span class="comment">--        if(nvl(subscribe, 0) = 0, &#x27;非预约&#x27;, &#x27;预约&#x27;)                   as subscribe_name,</span></span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;非预约&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;预约&#x27;</span></span><br><span class="line">           <span class="keyword">end</span>                                                             <span class="keyword">as</span> subscribe_name,</span><br><span class="line">       date_format(sub_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                                 <span class="keyword">as</span> sub_time,</span><br><span class="line">       is_agent,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;本人&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;代叫&#x27;</span></span><br><span class="line">           <span class="keyword">end</span>                                                             <span class="keyword">as</span> is_agent_name,</span><br><span class="line">       agent_telephone,</span><br><span class="line"><span class="comment">--        substr(order_time, 1, 4)                                      as year,</span></span><br><span class="line">       date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)       <span class="keyword">as</span> order_time,</span><br><span class="line">       date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                               <span class="keyword">as</span> order_data,</span><br><span class="line">       <span class="keyword">year</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                         <span class="keyword">as</span> order_year,</span><br><span class="line">       <span class="keyword">month</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                        <span class="keyword">as</span> order_month,</span><br><span class="line">       <span class="keyword">day</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>))  <span class="keyword">as</span> order_day,</span><br><span class="line">       <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="keyword">as</span> order_hour,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">5</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">8</span> <span class="keyword">then</span> <span class="string">&#x27;早上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">8</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">11</span> <span class="keyword">then</span> <span class="string">&#x27;上午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">11</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">13</span> <span class="keyword">then</span> <span class="string">&#x27;中午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">13</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">17</span> <span class="keyword">then</span> <span class="string">&#x27;下午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">17</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">19</span> <span class="keyword">then</span> <span class="string">&#x27;晚上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">19</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">20</span> <span class="keyword">then</span> <span class="string">&#x27;半夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">20</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">24</span> <span class="keyword">then</span> <span class="string">&#x27;深夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span></span><br><span class="line">           <span class="keyword">end</span></span><br><span class="line"><span class="comment">--        date_format(order_time, &#x27;yyyy-MM-dd HH:mm:ss&#x27;),</span></span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_order</span><br><span class="line"><span class="keyword">where</span> length(order_time) <span class="operator">&gt;=</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">and</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_cancel_order</span><br><span class="line">(</span><br><span class="line">    orderId     string,</span><br><span class="line">    Profession  string,</span><br><span class="line">    age_range   string,</span><br><span class="line">    Reason      string,</span><br><span class="line">    cancel_time string</span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_cancel_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> orderId,</span><br><span class="line">       profession,</span><br><span class="line">       age_range,</span><br><span class="line">       reason,</span><br><span class="line">       cancel_time</span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_cancel_order</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_pay_order</span><br><span class="line">(</span><br><span class="line">    id             string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">    orderId        string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    real_pay_money <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">    has_coupon     <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">    pay_way        <span class="type">int</span> comment <span class="string">&#x27;支付方式（0-微信支付、1-支付宝支付、3-QQ钱包支付、4- 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">    mileage        <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">    pay_time       string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_pay_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       orderId,</span><br><span class="line">       real_pay_money,</span><br><span class="line">       has_coupon,</span><br><span class="line">       pay_way,</span><br><span class="line">       mileage,</span><br><span class="line">       pay_time</span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_pay_order</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_evaluate</span><br><span class="line">(</span><br><span class="line">    id        string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">    orderId   string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    eva_level <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">    eva_time  string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_evaluate <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       orderId,</span><br><span class="line">       eva_level,</span><br><span class="line">       eva_time</span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_evaluate</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">-- 4.数据处理</span></span><br><span class="line"><span class="comment">-- 4.1 总订单笔数分析</span></span><br><span class="line"><span class="comment">-- 4.1.1计算4.12的总订单笔数分析</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span>     `时间`,</span><br><span class="line">       <span class="built_in">count</span>(orderid) `订单总笔数`</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_total</span><br><span class="line">(</span><br><span class="line">    date_val string comment <span class="string">&#x27;日期(yyyy-MM-dd)&#x27;</span>,</span><br><span class="line">    count    <span class="type">int</span> comment <span class="string">&#x27;订单笔数&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;按月分区yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> app_didi.t_order_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt)        <span class="keyword">as</span> `时间`,</span><br><span class="line">       <span class="built_in">count</span>(orderid) <span class="keyword">as</span> `订单时间`</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">-- truncate table app_didi.t_order_total;</span></span><br><span class="line"><span class="comment">-- 4.2 预约订单/非预约订单占比分析</span></span><br><span class="line"><span class="comment">-- sum,avg,max,min</span></span><br><span class="line"><span class="comment">-- 预约单/总单*100%</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_total</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">       subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">       <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> subscribe_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">--左连接</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">             subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t1</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_total</span><br><span class="line">                    <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">                    <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">-- 隐式内连接</span></span><br><span class="line"><span class="keyword">select</span> `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       concat(round(cnt <span class="operator">/</span> cnt_total <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">             subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t1,</span><br><span class="line">     (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt_total</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">--开窗函数</span></span><br><span class="line"><span class="keyword">select</span> order_date     <span class="keyword">as</span>                                        `日期`,</span><br><span class="line">       subscribe_name <span class="keyword">as</span>                                        `是否预约`,</span><br><span class="line">       <span class="built_in">count</span>(subscribe_name) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subscribe_name) cnt,</span><br><span class="line">       <span class="built_in">count</span>() <span class="keyword">over</span> ()                                          cnt_total</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"><span class="comment">-- group by subscribe_name;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--开窗函数2</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(`日期`) <span class="keyword">as</span>                                         `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       concat(round(<span class="built_in">max</span>(cnt) <span class="operator">/</span> <span class="built_in">max</span>(cnt_total) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> order_date     <span class="keyword">as</span>                                        `日期`,</span><br><span class="line">             subscribe_name <span class="keyword">as</span>                                        `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subscribe_name) cnt,</span><br><span class="line">             <span class="built_in">count</span>() <span class="keyword">over</span> ()                                          cnt_total</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> `是否预约`;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--方法三</span></span><br><span class="line"><span class="keyword">select</span> `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">             subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_subscribe_percent</span><br><span class="line">(</span><br><span class="line">    date_val       string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    subscribe_name string comment <span class="string">&#x27;是否预约&#x27;</span>,</span><br><span class="line">    percent_val    string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> () <span class="operator">*</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">             subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_subscribe_percent <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> `日期`,</span><br><span class="line">       `是否预约`,</span><br><span class="line">       concat(round((cnt <span class="operator">/</span> <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> ()) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) `百分比`</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(order_date)       <span class="keyword">as</span> `日期`,</span><br><span class="line">             subscribe_name        <span class="keyword">as</span> `是否预约`,</span><br><span class="line">             <span class="built_in">count</span>(subscribe_name) <span class="keyword">as</span> cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> subscribe_name) t;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4.3不同时段订单的个数</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_timerange_total</span><br><span class="line">(</span><br><span class="line">    datetime  string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    timerange string comment <span class="string">&#x27;时间段&#x27;</span>,</span><br><span class="line">    count     <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">;</span><br><span class="line"><span class="comment">--sql</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> order_time_range;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_timerange_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> order_time_range</span><br><span class="line">;</span><br><span class="line"><span class="comment">--4.4不同年龄段、时段订单个数</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       age_range,</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_range,</span><br><span class="line">         order_time_range</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_age_and_time_range_total</span><br><span class="line">(</span><br><span class="line">    datetime         string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    age_range        string comment <span class="string">&#x27;年龄段&#x27;</span>,</span><br><span class="line">    order_time_range string comment <span class="string">&#x27;时段&#x27;</span>,</span><br><span class="line">    count            <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_age_and_time_range_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       age_range,</span><br><span class="line">       order_time_range,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_range, order_time_range;</span><br><span class="line"><span class="comment">--4.4不同地域订单个数</span></span><br><span class="line"><span class="keyword">select</span> province, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> province;</span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_province_total</span><br><span class="line">(</span><br><span class="line">    datetime string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    province string comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    count    <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_province_total <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>,</span><br><span class="line">       province,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> order_cnt</span><br><span class="line"><span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line"><span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> province</span><br><span class="line">;</span><br><span class="line"><span class="comment">-- 4.5求订单客户职业排名top5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第一步 ：按职业分组求客户数量</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(dt),</span><br><span class="line">       profession,</span><br><span class="line">       <span class="built_in">count</span>(orderId)</span><br><span class="line"><span class="keyword">from</span> t_user_order_wide</span><br><span class="line"><span class="keyword">where</span>  dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>  profession;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二部 排名</span></span><br><span class="line"><span class="keyword">select</span> dt1,</span><br><span class="line">       profession,</span><br><span class="line">       cnt,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span>  cnt <span class="keyword">desc</span> )</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> dt1,</span><br><span class="line">             profession,</span><br><span class="line">             <span class="built_in">count</span>(orderId) cnt</span><br><span class="line">      <span class="keyword">from</span> t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span>  dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span>  profession) t</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"><span class="comment">-- 取前五</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span> dt1,</span><br><span class="line">                profession,</span><br><span class="line">                cnt,</span><br><span class="line">                <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span>  cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">         <span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">max</span>(dt) <span class="keyword">as</span> dt1,</span><br><span class="line">                      profession,</span><br><span class="line">                      <span class="built_in">count</span>(orderId) cnt</span><br><span class="line">               <span class="keyword">from</span> t_user_order_wide</span><br><span class="line">               <span class="keyword">where</span>  dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line">               <span class="keyword">group</span> <span class="keyword">by</span>  profession) t1</span><br><span class="line"></span><br><span class="line">     )t2</span><br><span class="line"><span class="keyword">where</span> rk<span class="operator">&lt;=</span><span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--with as</span></span><br><span class="line"><span class="keyword">with</span> <span class="keyword">as</span> 表<span class="number">1</span>别名 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span> ……</span><br><span class="line"><span class="keyword">from</span> ofs)</span><br><span class="line">),</span><br><span class="line">表<span class="number">2</span>别名 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span>……</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.profession,</span><br><span class="line">             t.cnt,</span><br><span class="line">             <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> profession,</span><br><span class="line">                   <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt</span><br><span class="line">            <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> profession) t) tt</span><br><span class="line"><span class="keyword">where</span> tt.rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_profession_total_topn</span><br><span class="line">(</span><br><span class="line">    profession string comment <span class="string">&#x27;职业&#x27;</span>,</span><br><span class="line">    Order_cnt  <span class="type">int</span> comment <span class="string">&#x27;订单数量&#x27;</span>,</span><br><span class="line">    rk         <span class="type">int</span> comment <span class="string">&#x27;排名&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_profession_total_topn <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> t.profession,</span><br><span class="line">             t.cnt,</span><br><span class="line">             <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.cnt <span class="keyword">desc</span> ) <span class="keyword">as</span> rk</span><br><span class="line">      <span class="keyword">from</span> (<span class="keyword">select</span> profession, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> dw_didi.t_user_order_wide <span class="keyword">group</span> <span class="keyword">by</span> profession) t) tt</span><br><span class="line"><span class="keyword">where</span> tt.rk <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--4.6用户订单取消占比</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>                                                date_val,</span><br><span class="line">       concat(round(t1.total_cnt <span class="operator">/</span> t2.total_cnt <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> cancel_order_percent</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">count</span>(orderid) <span class="keyword">as</span> total_cnt</span><br><span class="line">      <span class="keyword">from</span> ods_didi.t_user_cancel_order</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t1</span><br><span class="line">        ,</span><br><span class="line">     (<span class="keyword">select</span> <span class="built_in">count</span>(orderid) <span class="keyword">as</span> total_cnt</span><br><span class="line">      <span class="keyword">from</span> dw_didi.t_user_order_wide</span><br><span class="line">      <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2;</span><br><span class="line"><span class="comment">--创建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi.t_order_cancel_order_percent</span><br><span class="line">(</span><br><span class="line">    datetime             string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    cancel_order_percent string comment <span class="string">&#x27;百分比&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (<span class="keyword">month</span> string comment <span class="string">&#x27;年月，yyyy-MM&#x27;</span>)</span><br><span class="line">    <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">--加载数据</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> app_didi.t_order_cancel_order_percent <span class="keyword">partition</span> (<span class="keyword">month</span> <span class="operator">=</span> <span class="string">&#x27;2020-04&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;2020-04-12&#x27;</span>                                                date_val</span><br><span class="line">        ,</span><br><span class="line">       concat(round(t1.total_cnt <span class="operator">/</span> t2.total_cnt <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> percent_val</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) total_cnt <span class="keyword">from</span> ods_didi.t_user_cancel_order <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t1</span><br><span class="line">        ,</span><br><span class="line">     (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) total_cnt <span class="keyword">from</span> dw_didi.t_user_order_wide <span class="keyword">where</span> dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>) t2</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>with写法</p><p><img src="/images/loading.gif" data-original="/images/heima/52.png" alt="1688264309178"></p><p><img src="/images/loading.gif" data-original="/images/heima/53.png" alt="1688264355732"></p><p><img src="/images/loading.gif" data-original="/images/heima/54.png" alt="1688264376271"></p><p><img src="/images/loading.gif" data-original="/images/heima/55.png" alt="1688268664039"></p><p>sqoop list-databases –connect jdbc:mysql:&#x2F;&#x2F;192.168.52.161:3306&#x2F; –username root –password 123456</p><p><img src="/images/loading.gif" data-original="/images/heima/56.png" alt="1688282351357"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;node1&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br><span class="line">flush privileges;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create database if not exists app_didi;</span><br><span class="line"> create table if not exists app_didi.t_order_total(</span><br><span class="line">    order_date date,</span><br><span class="line">     count int</span><br><span class="line"> );</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table if  not exists app_didi.t_order_subscribe_total(</span><br><span class="line">    order_date date ,</span><br><span class="line">    subscribe_name varchar(20),</span><br><span class="line">     count int</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_total \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_total/month=2020-04</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/export/server/sqoop-1.4.6/bin/sqoop export \</span><br><span class="line">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span><br><span class="line">--username root \</span><br><span class="line">--password 123456 \</span><br><span class="line">--table t_order_subscribe_total \</span><br><span class="line">--export-dir /user/hive/warehouse/app_didi.db/t_order_subscribe_total/month=2020-04 </span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#导出不同时段订单统计表</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_timerange_total \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_timerange_total/month=2020-04</span></span><br><span class="line"> </span><br><span class="line">#导出不同地域订单统计表</span><br><span class="line"><span class="operator">/</span>export<span class="operator">/</span>server<span class="operator">/</span>sqoop<span class="number">-1.4</span><span class="number">.6</span><span class="operator">/</span>bin<span class="operator">/</span>sqoop export \</span><br><span class="line"><span class="comment">--connect jdbc:mysql://192.168.52.161:3306/app_didi \</span></span><br><span class="line"><span class="comment">--username root \</span></span><br><span class="line"><span class="comment">--password 123456 \</span></span><br><span class="line"><span class="comment">--table t_order_province_total  \</span></span><br><span class="line"><span class="comment">--export-dir /user/hive/warehouse/app_didi.db/t_order_province_total/month=2020-04</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/07/01/%E4%BA%8C%E3%80%81%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%88copy%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/07/01/%E4%BA%8C%E3%80%81%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%88copy%EF%BC%89/" class="post-title-link" itemprop="url">二、常用命令（copy）</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-01 09:08:07" itemprop="dateCreated datePublished" datetime="2023-07-01T09:08:07+08:00">2023-07-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-03 10:26:35" itemprop="dateModified" datetime="2023-07-03T10:26:35+08:00">2023-07-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><ul><li>上传到hdfs</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -put archer.txt /user/hive/warehouse/test.db/t_archer</span><br></pre></td></tr></table></figure><ul><li>关机</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br></pre></td></tr></table></figure><ul><li>重启</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot   </span><br></pre></td></tr></table></figure><ul><li>查看进程</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps </span><br></pre></td></tr></table></figure><ul><li>mysql 活着管道</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef| grep mysql</span><br></pre></td></tr></table></figure><ul><li>jps全称</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java process connect</span><br></pre></td></tr></table></figure><ul><li>查看进程</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps  java process server</span><br></pre></td></tr></table></figure><ul><li>启动进程脚本（根目录cd ~）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onekey/my-start-all.sh</span><br></pre></td></tr></table></figure><ul><li>关闭进程脚本</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onekey/my-stop-all.sh关闭进程脚本</span><br></pre></td></tr></table></figure><ul><li>查看 网关linux</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure><ul><li>网关 windows</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig </span><br></pre></td></tr></table></figure><ul><li>进入mysql</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure><ul><li>查看端口</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isof -f 10000</span><br></pre></td></tr></table></figure><ul><li>杀死端口</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 xxxx</span><br></pre></td></tr></table></figure><ul><li>查看详细端口运行</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps -m</span><br></pre></td></tr></table></figure><ul><li>查看指定端口</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i:10000</span><br></pre></td></tr></table></figure><ul><li>展开列表</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alt +enter ctrl+enter</span><br></pre></td></tr></table></figure><ul><li>格式化</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crtl+alt+L</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/06/30/didi%E5%87%BA%E8%A1%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/06/30/didi%E5%87%BA%E8%A1%8C/" class="post-title-link" itemprop="url">未命名</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-06-30 16:55:19 / 修改时间：17:07:35" itemprop="dateCreated datePublished" datetime="2023-06-30T16:55:19+08:00">2023-06-30</time></span></div></header><div class="post-body" itemprop="articleBody"><hr><h2 id="滴滴出行"><a href="#滴滴出行" class="headerlink" title="滴滴出行"></a>滴滴出行</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.数据仓库构建</span></span><br><span class="line"><span class="comment">-- 1.1创建ods库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi;</span><br><span class="line"><span class="comment">-- 1.2创建dw数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi;</span><br><span class="line"><span class="comment">-- 1.3创建app数据库</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> app_didi;</span><br><span class="line"></span><br><span class="line">use ods_didi;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.在ods层创建表</span></span><br><span class="line"><span class="comment">-- 2.1创建订单结构表</span></span><br><span class="line"><span class="comment">-- 创建用户订单表结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_order</span><br><span class="line">(</span><br><span class="line">    orderId         string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone       string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng             string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat             string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province        string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city            string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money        <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender          string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession      string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range       string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip             <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe       <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    sub_time        string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent        <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    agent_telephone string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time      string comment <span class="string">&#x27;订单时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ods创建取消订单表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_cancel_order</span><br><span class="line">(</span><br><span class="line">    orderId        string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    cstm_telephone string comment <span class="string">&#x27;客户联系电话&#x27;</span>,</span><br><span class="line">    lng            string comment <span class="string">&#x27;取消订单的经度&#x27;</span>,</span><br><span class="line">    lat            string comment <span class="string">&#x27;取消订单的纬度&#x27;</span>,</span><br><span class="line">    province       string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city           string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_distance    <span class="keyword">double</span> comment <span class="string">&#x27;预估距离&#x27;</span>,</span><br><span class="line">    gender         string comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    profession     string comment <span class="string">&#x27;行业&#x27;</span>,</span><br><span class="line">    age_range      string comment <span class="string">&#x27;年龄段&#x27;</span>,</span><br><span class="line">    reason         <span class="type">int</span> comment <span class="string">&#x27;取消订单原因（1 - 选择了其他交通方式、2 - 与司机达成一致，取消订单、3 - 投诉司机没来接我、4 - 已不需要用车、5 - 无理由取消订单）&#x27;</span>,</span><br><span class="line">    cancel_time    string comment <span class="string">&#x27;取消时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ods创建订单表支付表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_pay_order</span><br><span class="line">(</span><br><span class="line">    id                         string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">    orderId                    string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    lng                        string comment <span class="string">&#x27;目的地的经度（支付地址）&#x27;</span>,</span><br><span class="line">    lat                        string comment <span class="string">&#x27;目的地的纬度（支付地址）&#x27;</span>,</span><br><span class="line">    province                   string comment <span class="string">&#x27;省份&#x27;</span>,</span><br><span class="line">    city                       string comment <span class="string">&#x27;城市&#x27;</span>,</span><br><span class="line">    total_money                <span class="keyword">double</span> comment <span class="string">&#x27;车费总价&#x27;</span>,</span><br><span class="line">    real_pay_money             <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">    passenger_additional_money <span class="keyword">double</span> comment <span class="string">&#x27;乘客额外加价&#x27;</span>,</span><br><span class="line">    base_money                 <span class="keyword">double</span> comment <span class="string">&#x27;车费合计&#x27;</span>,</span><br><span class="line">    has_coupon                 <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">    coupon_total               <span class="keyword">double</span> comment <span class="string">&#x27;优惠券合计&#x27;</span>,</span><br><span class="line">    pay_way                    <span class="type">int</span> comment <span class="string">&#x27;支付方式（0 - 微信支付、1 - 支付宝支付、3 - QQ钱包支付、4 - 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">    mileage                    <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">    pay_time                   string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- ods创建用户评价表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> ods_didi.t_user_evaluate</span><br><span class="line">(</span><br><span class="line">    id                  string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">    orderId             string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    passenger_telephone string comment <span class="string">&#x27;用户电话&#x27;</span>,</span><br><span class="line">    passenger_province  string comment <span class="string">&#x27;用户所在省份&#x27;</span>,</span><br><span class="line">    passenger_city      string comment <span class="string">&#x27;用户所在城市&#x27;</span>,</span><br><span class="line">    eva_level           <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">    eva_time            string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建数据仓库 导入数据</span></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/cancel_order.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_cancel_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/pay.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_pay_order <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/export/data/didi/evaluate.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> ods_didi.t_user_evaluate <span class="keyword">partition</span> (dt <span class="operator">=</span> <span class="string">&#x27;2020-04-12&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.在dw层进行数据预处理</span></span><br><span class="line">use dw_didi;</span><br><span class="line"><span class="comment">-- 创建宽表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_order_wide</span><br><span class="line">(</span><br><span class="line">    orderId          string comment <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">    telephone        string comment <span class="string">&#x27;打车用户手机&#x27;</span>,</span><br><span class="line">    lng              string comment <span class="string">&#x27;用户发起打车的经度&#x27;</span>,</span><br><span class="line">    lat              string comment <span class="string">&#x27;用户发起打车的纬度&#x27;</span>,</span><br><span class="line">    province         string comment <span class="string">&#x27;所在省份&#x27;</span>,</span><br><span class="line">    city             string comment <span class="string">&#x27;所在城市&#x27;</span>,</span><br><span class="line">    es_money         <span class="keyword">double</span> comment <span class="string">&#x27;预估打车费用&#x27;</span>,</span><br><span class="line">    gender           string comment <span class="string">&#x27;用户信息 - 性别&#x27;</span>,</span><br><span class="line">    profession       string comment <span class="string">&#x27;用户信息 - 行业&#x27;</span>,</span><br><span class="line">    age_range        string comment <span class="string">&#x27;年龄段（70后、80后、...）&#x27;</span>,</span><br><span class="line">    tip              <span class="keyword">double</span> comment <span class="string">&#x27;小费&#x27;</span>,</span><br><span class="line">    subscribe        <span class="type">int</span> comment <span class="string">&#x27;是否预约（0 - 非预约、1 - 预约）&#x27;</span>,</span><br><span class="line">    subscribe_name   string comment <span class="string">&#x27;是否预约名称&#x27;</span>,</span><br><span class="line">    sub_time         string comment <span class="string">&#x27;预约时间&#x27;</span>,</span><br><span class="line">    is_agent         <span class="type">int</span> comment <span class="string">&#x27;是否代叫（0 - 本人、1 - 代叫）&#x27;</span>,</span><br><span class="line">    is_agent_name    string comment <span class="string">&#x27;是否代缴名称&#x27;</span>,</span><br><span class="line">    agent_telephone  string comment <span class="string">&#x27;预约人手机&#x27;</span>,</span><br><span class="line">    order_time       string comment <span class="string">&#x27;订单时间&#x27;</span>,</span><br><span class="line">    order_date       string comment <span class="string">&#x27;订单时间，yyyy-MM-dd&#x27;</span>,</span><br><span class="line">    order_year       string comment <span class="string">&#x27;年&#x27;</span>,</span><br><span class="line">    order_month      string comment <span class="string">&#x27;月&#x27;</span>,</span><br><span class="line">    order_day        string comment <span class="string">&#x27;日&#x27;</span>,</span><br><span class="line">    order_hour       string comment <span class="string">&#x27;小时&#x27;</span>,</span><br><span class="line">    order_time_range string comment <span class="string">&#x27;时间段&#x27;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预处理sql语句 用户订单处理</span></span><br><span class="line"><span class="keyword">insert</span> overwrite  <span class="keyword">table</span>  dw_didi.t_user_order_wide <span class="keyword">partition</span> (dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> orderid,</span><br><span class="line">       telephone,</span><br><span class="line">       lng,</span><br><span class="line">       lat,</span><br><span class="line">       province,</span><br><span class="line">       city,</span><br><span class="line">       es_money,</span><br><span class="line">       gender,</span><br><span class="line">       profession,</span><br><span class="line">       age_range,</span><br><span class="line">       tip,</span><br><span class="line">       subscribe,</span><br><span class="line"><span class="comment">--        if(nvl(subscribe, 0) = 0, &#x27;非预约&#x27;, &#x27;预约&#x27;)                   as subscribe_name,</span></span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;非预约&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> subscribe <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;预约&#x27;</span></span><br><span class="line">           <span class="keyword">end</span>                                                             <span class="keyword">as</span> subscribe_name,</span><br><span class="line">       date_format(sub_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                                 <span class="keyword">as</span> sub_time,</span><br><span class="line">       is_agent,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">0</span> <span class="keyword">or</span> (subscribe <span class="keyword">is</span> <span class="keyword">null</span>) <span class="keyword">then</span> <span class="string">&#x27;本人&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> is_agent <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;代叫&#x27;</span></span><br><span class="line">           <span class="keyword">end</span>                                                             <span class="keyword">as</span> is_agent_name,</span><br><span class="line">       agent_telephone,</span><br><span class="line"><span class="comment">--        substr(order_time, 1, 4)                                      as year,</span></span><br><span class="line">       date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)       <span class="keyword">as</span> order_time,</span><br><span class="line">       date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>)                               <span class="keyword">as</span> order_data,</span><br><span class="line">       <span class="keyword">year</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                         <span class="keyword">as</span> order_year,</span><br><span class="line">       <span class="keyword">month</span>(date_format(order_time, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>))                        <span class="keyword">as</span> order_month,</span><br><span class="line">       <span class="keyword">day</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>))  <span class="keyword">as</span> order_day,</span><br><span class="line">       <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="keyword">as</span> order_hour,</span><br><span class="line">       <span class="keyword">case</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">1</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">5</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">8</span> <span class="keyword">then</span> <span class="string">&#x27;早上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">8</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">11</span> <span class="keyword">then</span> <span class="string">&#x27;上午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">11</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">13</span> <span class="keyword">then</span> <span class="string">&#x27;中午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">13</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">17</span> <span class="keyword">then</span> <span class="string">&#x27;下午&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">17</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">19</span> <span class="keyword">then</span> <span class="string">&#x27;晚上&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">19</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">20</span> <span class="keyword">then</span> <span class="string">&#x27;半夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">20</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">24</span> <span class="keyword">then</span> <span class="string">&#x27;深夜&#x27;</span></span><br><span class="line">           <span class="keyword">when</span> <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">                <span class="keyword">hour</span>(date_format(concat(order_time, <span class="string">&#x27;:00&#x27;</span>), <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>)) <span class="operator">&lt;</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;凌晨&#x27;</span></span><br><span class="line">           <span class="keyword">end</span></span><br><span class="line"><span class="comment">--        date_format(order_time, &#x27;yyyy-MM-dd HH:mm:ss&#x27;),</span></span><br><span class="line"><span class="keyword">from</span> ods_didi.t_user_order</span><br><span class="line"><span class="keyword">where</span> length(order_time) <span class="operator">&gt;=</span> <span class="number">8</span></span><br><span class="line"><span class="keyword">and</span> dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_cancel_order(</span><br><span class="line">    orderId string,</span><br><span class="line">    Profession string,</span><br><span class="line">    age_range string,</span><br><span class="line">    Reason string,</span><br><span class="line">    cancel_time string</span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_cancel_order <span class="keyword">partition</span>(dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    orderId,</span><br><span class="line">    profession,</span><br><span class="line">    age_range,</span><br><span class="line">    reason,</span><br><span class="line">    cancel_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    ods_didi.t_user_cancel_order</span><br><span class="line"><span class="keyword">where</span> dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_pay_order(</span><br><span class="line">   id string comment <span class="string">&#x27;支付订单ID&#x27;</span>,</span><br><span class="line">   orderId string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">   real_pay_money <span class="keyword">double</span> comment <span class="string">&#x27;实际支付总额&#x27;</span>,</span><br><span class="line">   has_coupon <span class="type">int</span> comment <span class="string">&#x27;是否使用优惠券（0 - 不使用、1 - 使用）&#x27;</span>,</span><br><span class="line">   pay_way <span class="type">int</span> comment <span class="string">&#x27;支付方式（0-微信支付、1-支付宝支付、3-QQ钱包支付、4- 一网通银行卡支付）&#x27;</span>,</span><br><span class="line">   mileage <span class="keyword">double</span> comment <span class="string">&#x27;里程（单位公里）&#x27;</span>,</span><br><span class="line">   pay_time string comment <span class="string">&#x27;支付时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_pay_order <span class="keyword">partition</span>(dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    id  ,</span><br><span class="line">    orderId ,</span><br><span class="line">    real_pay_money ,</span><br><span class="line">    has_coupon ,</span><br><span class="line">    pay_way  ,</span><br><span class="line">    mileage ,</span><br><span class="line">    pay_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    ods_didi.t_user_pay_order</span><br><span class="line"><span class="keyword">where</span> dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dw_didi.t_user_evaluate(</span><br><span class="line">     id string comment <span class="string">&#x27;评价日志唯一ID&#x27;</span>,</span><br><span class="line">     orderId string comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">     eva_level <span class="type">int</span> comment <span class="string">&#x27;评价等级（1 - 一颗星、... 5 - 五星）&#x27;</span>,</span><br><span class="line">     eva_time string comment <span class="string">&#x27;评价时间&#x27;</span></span><br><span class="line">)</span><br><span class="line">    partitioned <span class="keyword">by</span> (dt string comment <span class="string">&#x27;时间分区&#x27;</span>)</span><br><span class="line">    <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dw_didi.t_user_evaluate <span class="keyword">partition</span>(dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    orderId,</span><br><span class="line">    eva_level,</span><br><span class="line">    eva_time</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    ods_didi.t_user_evaluate</span><br><span class="line"><span class="keyword">where</span> dt<span class="operator">=</span><span class="string">&#x27;2020-04-12&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/06/26/%E6%9A%91%E5%81%87%E9%BB%91%E9%A9%AC%E5%9F%B9%E8%AE%AD/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/06/26/%E6%9A%91%E5%81%87%E9%BB%91%E9%A9%AC%E5%9F%B9%E8%AE%AD/" class="post-title-link" itemprop="url">一、集群</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-06-26 13:54:44" itemprop="dateCreated datePublished" datetime="2023-06-26T13:54:44+08:00">2023-06-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 15:15:34" itemprop="dateModified" datetime="2023-07-05T15:15:34+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9A%91%E5%81%87%E5%AE%9E%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">暑假实训</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>root</p><p>123456</p><p>shutdown -h now 关机</p><h1 id="第一章-集群"><a href="#第一章-集群" class="headerlink" title="第一章 集群"></a>第一章 集群</h1><h2 id="1-1-安装集群"><a href="#1-1-安装集群" class="headerlink" title="1.1.      安装集群"></a>1.1. 安装集群</h2><p>将集群目录 复制 d:&#x2F;opt&#x2F;shixun2 目录中</p><p>​ <img src="/images/loading.gif" data-original="/images/heima/1.png" alt="1687748471325"></p><p>双击 node1.vmx 文件即可启动</p><p><img src="/images/loading.gif" data-original="/images/heima/2.png" alt="1687748508498"></p><p><img src="/images/loading.gif" data-original="/images/heima/3.png" alt="1687748518653"></p><p><img src="/images/loading.gif" data-original="/images/heima/4.png" alt="1687748531073"></p><p><img src="/images/loading.gif" data-original="/images/heima/5.png" alt="1687748548614"></p><h2 id="1-2-配置网卡-每天开机后都需要配置"><a href="#1-2-配置网卡-每天开机后都需要配置" class="headerlink" title="1.2.      配置网卡(每天开机后都需要配置)"></a>1.2. 配置网卡(每天开机后都需要配置)</h2><h3 id="1-2-1-配置vmware的网卡"><a href="#1-2-1-配置vmware的网卡" class="headerlink" title="1.2.1. 配置vmware的网卡"></a>1.2.1. 配置vmware的网卡</h3><p><img src="/images/loading.gif" data-original="/images/heima/6.png" alt="1687748565238"></p><h3 id="1-2-2-配置windows系统的网卡信息"><a href="#1-2-2-配置windows系统的网卡信息" class="headerlink" title="1.2.2. 配置windows系统的网卡信息"></a>1.2.2. 配置windows系统的网卡信息</h3><p><img src="/images/loading.gif" data-original="/images/heima/7.png" alt="1687748593434"></p><p><img src="/images/loading.gif" data-original="/images/heima/8.png" alt="1687748608390"></p><p><img src="/images/loading.gif" data-original="/images/heima/9.png" alt="1687748619013"></p><p><img src="/images/loading.gif" data-original="/images/heima/10.png" alt="1687748633118"></p><p><img src="/images/loading.gif" data-original="/images/heima/11.png" alt="1687748644122"></p><h3 id="1-2-3-测试是否可以连上互联网"><a href="#1-2-3-测试是否可以连上互联网" class="headerlink" title="1.2.3. 测试是否可以连上互联网?"></a>1.2.3. 测试是否可以连上互联网?</h3><p><img src="/images/loading.gif" data-original="/images/heima/12.png" alt="1687748664326"></p><h2 id="1-3-通过crt客户端操作linux"><a href="#1-3-通过crt客户端操作linux" class="headerlink" title="1.3.      通过crt客户端操作linux"></a>1.3. 通过crt客户端操作linux</h2><h3 id="1-3-1-通过在windows中是否可以连上linux系统"><a href="#1-3-1-通过在windows中是否可以连上linux系统" class="headerlink" title="1.3.1. 通过在windows中是否可以连上linux系统"></a>1.3.1. 通过在windows中是否可以连上linux系统</h3><p><img src="/images/loading.gif" data-original="/images/heima/13.png" alt="1687748674646"></p><p><img src="/images/loading.gif" data-original="/images/heima/14.png" alt="1687748687033"></p><h3 id="1-3-2-通过客户端操作linux系统"><a href="#1-3-2-通过客户端操作linux系统" class="headerlink" title="1.3.2. 通过客户端操作linux系统"></a>1.3.2. 通过客户端操作linux系统</h3><p><img src="/images/loading.gif" data-original="/images/heima/15.png" alt="1687748698441"></p><p><img src="/images/loading.gif" data-original="/images/heima/16.png" alt="1687748713608"></p><p><img src="/images/loading.gif" data-original="/images/heima/17.png" alt="1688173003549"></p><p><img src="/images/loading.gif" data-original="/images/heima/18.png" alt="1688173023806"></p><h2 id="1-4-一键启动集群"><a href="#1-4-一键启动集群" class="headerlink" title="1.4.      一键启动集群"></a>1.4. 一键启动集群</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onekey/my-start-all.sh </span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/19.png" alt="1688173047593"></p><h2 id="1-5-一键启动hive"><a href="#1-5-一键启动hive" class="headerlink" title="1.5.      一键启动hive"></a>1.5. 一键启动hive</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/server/hive-2.1.0/bin</span><br><span class="line">expect beeline.exp</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/20.png" alt="1688173083306"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/21.png" alt="1688173101979"></p><h2 id="1-6-查看进程"><a href="#1-6-查看进程" class="headerlink" title="1.6.      查看进程"></a>1.6. 查看进程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/22.png" alt="1688173114789"></p><h2 id="1-7-集群的页面访问"><a href="#1-7-集群的页面访问" class="headerlink" title="1.7.      集群的页面访问"></a>1.7. 集群的页面访问</h2><h3 id="1-7-1-IP访问"><a href="#1-7-1-IP访问" class="headerlink" title="1.7.1. IP访问"></a>1.7.1. IP访问</h3><p>一旦Hadoop集群启动并运行，可以通过web-ui进行集群查看，如下所述：</p><p>查看NameNode页面地址:</p><p><a href="#/"><strong>http:&#x2F;&#x2F;<strong><strong>192.168.52.161</strong></strong>:50070&#x2F;</strong></a></p><p>​ <img src="/images/loading.gif" data-original="/images/heima/23.png" alt="1688173127109"></p><p>查看Yarn集群页面地址:</p><p><a target="_blank" rel="noopener" href="http://node01:8088/cluster"><strong>http:&#x2F;&#x2F;<strong><strong>192.168.52.161</strong></strong>:8088&#x2F;cluster</strong></a></p><p><img src="/images/loading.gif" data-original="/images/heima/24.png" alt="1688173139364"></p><p>​</p><p>查看MapReduce历史任务页面地址:</p><p><a target="_blank" rel="noopener" href="http://node01:19888/jobhistory"><strong>http:&#x2F;&#x2F;<strong><strong>192.168.52.161</strong></strong>:19888&#x2F;jobhistory</strong></a></p><p><img src="/images/loading.gif" data-original="/images/heima/25.png" alt="1688173148887"></p><p>​</p><h3 id="1-7-2-主机名访问"><a href="#1-7-2-主机名访问" class="headerlink" title="1.7.2. 主机名访问"></a>1.7.2. 主机名访问</h3><p>请注意，以上的访问地址只能使用IP地址，如果想要使用主机名，则对Windows进行配置。</p><p>配置方式:</p><p>1、打开Windows的C:\Windows\System32\drivers\etc目录下hosts文件</p><p>2、在hosts文件中添加以下域名映射</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.52.161  node1  node1.itcast.cn</span><br><span class="line">192.168.52.162  node2  node2.itcast.cn</span><br><span class="line">192.168.52.163  node3  node3.itcast.cn</span><br></pre></td></tr></table></figure><p>配置完之后，可以将以上地址中的IP替换为主机名即可访问，如果还不能访问，则需要重启Windows电脑，比如访问NameNode，可以使用<strong><a target="_blank" rel="noopener" href="http://node1:50070/">http://node1:50070/</a></strong> 。</p><h2 id="1-8-Hadoop初体验-HDFS使用"><a href="#1-8-Hadoop初体验-HDFS使用" class="headerlink" title="1.8.      Hadoop初体验: HDFS使用"></a>1.8. Hadoop初体验: HDFS使用</h2><p><img src="/images/loading.gif" data-original="/images/heima/26.png" alt="1688173174570"></p><p>1、从Linux本地上传一个文本文件到hdfs的&#x2F;目录下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#在/export/data/目录中创建a.txt文件，并写入数据</span><br><span class="line">cd /export/data/</span><br><span class="line">touch a.txt</span><br><span class="line">echo &quot;hello&quot; &gt; a.txt </span><br><span class="line"></span><br><span class="line">#将a.txt上传到HDFS的根目录</span><br><span class="line">hadoop fs -put a.txt  /</span><br></pre></td></tr></table></figure><p>1、通过页面查看</p><p>通过NameNode页面.进入HDFS：<strong><a target="_blank" rel="noopener" href="http://node1:50070/">http://node1:50070/</a></strong></p><p><img src="/images/loading.gif" data-original="/images/heima/27.png" alt="1688173245402"></p><p>查看文件是否创建成功.</p><p><img src="/images/loading.gif" data-original="/images/heima/28.png" alt="1688173258225"></p><p>​</p><h2 id="1-9-一键关闭集群"><a href="#1-9-一键关闭集群" class="headerlink" title="1.9.      一键关闭集群"></a>1.9. 一键关闭集群</h2><h3 id="1-9-1-关闭-hdfs-和-yarn-和-historyserver"><a href="#1-9-1-关闭-hdfs-和-yarn-和-historyserver" class="headerlink" title="1.9.1. 关闭 hdfs 和 yarn 和 historyserver"></a>1.9.1. 关闭 hdfs 和 yarn 和 historyserver</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onekey/my-stop-all.sh</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/29.png" alt="1688173295113"></p><h3 id="1-9-2-关闭跟hive相关的服务"><a href="#1-9-2-关闭跟hive相关的服务" class="headerlink" title="1.9.2. 关闭跟hive相关的服务"></a>1.9.2. 关闭跟hive相关的服务</h3><p>查询进程号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/30.png" alt="1688173335397"></p><p>杀掉 RunJar 对应的进程号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 xxxx</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/31.png" alt="1688173354052"></p><h3 id="1-9-3-关闭系统"><a href="#1-9-3-关闭系统" class="headerlink" title="1.9.3. 关闭系统"></a>1.9.3. 关闭系统</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/heima/32.png" alt="1688173371537"></p><h2 id="1-10-给集群拍摄快照"><a href="#1-10-给集群拍摄快照" class="headerlink" title="1.10.   给集群拍摄快照"></a>1.10. 给集群拍摄快照</h2><p><img src="/images/loading.gif" data-original="/images/heima/33.png" alt="1688173381373"></p><p><img src="/images/loading.gif" data-original="/images/heima/34.png" alt="1688173391188"></p><p><img src="/images/loading.gif" data-original="/images/heima/35.png" alt="1688173399743"></p><p><strong>注意</strong>: <strong>一定要在关机的状态下拍摄快照!</strong></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/06/01/python%E7%94%B5%E5%BD%B1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/06/01/python%E7%94%B5%E5%BD%B1/" class="post-title-link" itemprop="url">linux安装一些软件</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-06-01 22:54:32" itemprop="dateCreated datePublished" datetime="2023-06-01T22:54:32+08:00">2023-06-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 15:15:12" itemprop="dateModified" datetime="2023-07-05T15:15:12+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/2023/" itemprop="url" rel="index"><span itemprop="name">2023</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/257.png" alt="1685630139372"></p><ol><li><p>开终端或 Anaconda Prompt。</p></li><li><p>创建一个新的环境（可选）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">codeconda create --name mypysparkenv</span><br><span class="line">conda activate mypysparkenv</span><br></pre></td></tr></table></figure></li><li><p>安装 PySpark：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeconda install -c conda-forge pyspark</span><br></pre></td></tr></table></figure></li><li><p>输入以下命令，以退出 Anaconda 环境：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy codeconda deactivate</span><br></pre></td></tr></table></figure></li></ol><p>激活</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda activate  mypysparkenv</span><br></pre></td></tr></table></figure><p>查看版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import pyspark</span><br><span class="line">&gt;&gt;&gt; print(pyspark.__version__)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install -n mypysparkenv ipykernel --update-deps --force-reinstall</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install -n mypysparkenv ipykernel --update-deps --force-reinstall</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export SPARK_HOME=/path/to/spark/installation/in/anaconda/envs/myenv/lib/pythonX.X/site-packages/pyspark</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export PYSPARK_HOME=/usr/local/spark</span><br><span class="line">export PYTHONPATH=$PYSPARK_HOME/python:$PYTHONPATH</span><br><span class="line">export PYTHONPATH=$PYSPARK_HOME/python/lib/py4j-0.10.4-src.zip:$PYTHONPATH</span><br></pre></td></tr></table></figure><p>有关deb文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i mysql-connector-j_8.0.33-1ubuntu22.04_all.deb</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/05/26/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/xiao.png"><meta itemprop="name" content="毛"><meta itemprop="description" content="在梦里啥都有"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="睡觉万岁"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/05/26/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">电影推荐系统</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-05-26 22:05:08" itemprop="dateCreated datePublished" datetime="2023-05-26T22:05:08+08:00">2023-05-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-07-05 15:13:30" itemprop="dateModified" datetime="2023-07-05T15:13:30+08:00">2023-07-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/2023/" itemprop="url" rel="index"><span itemprop="name">2023</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>1.创建新的虚拟机</p><h1 id="一、创建虚拟机"><a href="#一、创建虚拟机" class="headerlink" title="一、创建虚拟机"></a>一、创建虚拟机</h1><p>1.<img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/1.png" alt="1685109929770"></p><p>2.<img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/2.png" alt="1685109980203"></p><p>3.官网下载iso文件</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/3.png" alt="1685110006853"></p><ol start="4"><li></li></ol><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/4.png" alt="1685110041330"></p><ol start="5"><li></li></ol><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/5.png" alt="1685110066266"></p><p>6.随变取（maduit 密码：123）</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/6.png" alt="1685110292223"></p><p>7.<img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/7.png" alt="1685110316214"></p><p>8.自定义文件</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/8.png" alt="1685110352421"></p><p>9.内存至少需要4GB</p><p>4核也够了</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/9.png" alt="1685110486547"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/10.png" alt="1685110513052"></p><p>10.自动初始化</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/11.png" alt="1685110546985"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/12.png" alt="1685110595550"></p><p>11.初始化完成，点击bigdata用户</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/13.png" alt="1685110913251"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/78.png" alt="1685255418151"></p><ol start="12"><li></li></ol><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/14.png" alt="1685110980025"></p><p>然后虚拟机的安装就完成了</p><p>emmm ，但是书上说要</p><h5 id="创建一个hadoop用户"><a href="#创建一个hadoop用户" class="headerlink" title="创建一个hadoop用户"></a>创建一个hadoop用户</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m hadoop -s /bin/bash</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/16.png" alt="1685111598023"></p><p>设置密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd hadoop</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/17.png" alt="1685111720754"></p><p>切换用户</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/18.png" alt="1685111770370"></p><h5 id="切换下载源"><a href="#切换下载源" class="headerlink" title="切换下载源"></a>切换下载源</h5><p><img src="/images/loading.gif" data-original="C:\Users\GJQ\AppData\Roaming\Typora\typora-user-images\1685171531582.png" alt="1685171531582"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/34.png" alt="1685171458820"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/35.png" alt="1685171599429"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/36.png" alt="1685171618432"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/37.png" alt="1685171647360"></p><h1 id="二、安装vim"><a href="#二、安装vim" class="headerlink" title="二、安装vim"></a>二、安装vim</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get  install vim</span><br></pre></td></tr></table></figure><p>这边得切换到一开始创建的用户（bigdata）那边安装</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/23.png" alt="1685119947481"></p><p>不然会报这个错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop is not in the sudoers file. This incident will be reported.</span><br></pre></td></tr></table></figure><p>显示了这个说明hadoop用户没有root权限</p><p>然后在bigdata的用户里面打开这个命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo visudo </span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/25.png" alt="1685168070062"></p><p>在最后一行加上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop  ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><p>保存关闭之后再切换回hadoop用户</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/24.png" alt="1685167949585"></p><p>然后再执行安装命令就行了</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/26.png" alt="1685169097189"></p><p>如果还是报错，在hadoop用户继续输入<code>sudo visudo</code>这命令 然后保存在执行（我不知到空格有没有影响，反正保持和上面代码命令行一样的空格就好）然后Hadoop用户就可以使用sudo命令了</p><h1 id="三、安装JDK环境"><a href="#三、安装JDK环境" class="headerlink" title="三、安装JDK环境"></a>三、安装JDK环境</h1><p>从百度网盘里的东西直接移动到downloads里面</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/19.png" alt="1685111974555"></p><p>如果不行的话，自己查找vmware tool的东西</p><p>复制完成</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/21.png" alt="1685112959995"></p><p>切换到管理员模式可以减少很多麻烦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/27.png" alt="1685170106349"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/lib</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir jvm #创建jvm文件夹用来放JDK文件</span><br><span class="line">cd /home/hadoop/Downloads</span><br><span class="line">tar -zxvf ./jdk-8u162-linux-x64.tar.gz #解压</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/28.png" alt="1685170197086"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/29.png" alt="1685170290984"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv jdk1.8.0_162 /usr/lib/jvm #移动到jvm里</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/30.png" alt="1685170386914"></p><p>回到jvm文件那么发现多了一个</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/31.png" alt="1685170435438"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~ #用于将当前工作目录切换到当前用户的主目录（home directory）</span><br><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure><p>在最后输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=&quot;/usr/lib/jvm/jdk1.8.0_162&quot;</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/tools.jar</span><br><span class="line">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export JAVA_HOME CLASSPATH PATH</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_162</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/32.png" alt="1685170892887"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/33.png" alt="1685170968110"></p><p>返回这个就是好的</p><h1 id="四、下载Hadoop"><a href="#四、下载Hadoop" class="headerlink" title="四、下载Hadoop"></a>四、下载Hadoop</h1><h4 id="安装ssh"><a href="#安装ssh" class="headerlink" title="安装ssh"></a>安装ssh</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install openssh-server</span><br><span class="line">ssh localhost</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh/</span><br><span class="line">ssh-keygen -t rsa  #全回车</span><br><span class="line">cat ./id_rsa.pub &gt;&gt; ./authorized_keys</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/39.png" alt="1685175855423"></p><h4 id="安装hadoop"><a href="#安装hadoop" class="headerlink" title="安装hadoop"></a>安装hadoop</h4><p>找到原本下载hadoop安装包的文件夹解压</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf hadoop-2.7.1.tar.gz</span><br><span class="line">sudo mv hadoop-2.7.1 /usr/local #移动</span><br><span class="line">sudo mv hadoop-2.7.1 ./hadoop #改名</span><br><span class="line">sudo chown -R hadoop ./hadoop #修改文件夹权限</span><br></pre></td></tr></table></figure><p>看单机版hadoop信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">./bin/hadoop version</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/40.png" alt="1685190557505"></p><p>因为需要伪分布式，继续伪分布式的配置</p><h5 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim core-site.xml</span><br></pre></td></tr></table></figure><p>复制这个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;file:/usr/local/hadoop/tmp&lt;/value&gt;</span><br><span class="line">        &lt;description&gt;Abase for other temporary directories.&lt;/description&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim hdfs-site.xml</span><br></pre></td></tr></table></figure><p>复制这个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;file:/usr/local/hadoop/tmp/dfs/name&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;file:/usr/local/hadoop/tmp/dfs/data&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop-env.sh"></a>hadoop-env.sh</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim hadoop-env.sh</span><br></pre></td></tr></table></figure><p>找到这边添加一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># The java implementation to use.</span><br><span class="line">export JAVA_HOME=$&#123;JAVA_HOME&#125;</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_162</span><br></pre></td></tr></table></figure><h5 id="yarn-env-sh"><a href="#yarn-env-sh" class="headerlink" title="yarn-env.sh"></a>yarn-env.sh</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim yarn-env.sh</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">插入如下代码：</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_162</span><br></pre></td></tr></table></figure><h5 id="mapred-site-xml文件配置"><a href="#mapred-site-xml文件配置" class="headerlink" title="mapred-site.xml文件配置"></a>mapred-site.xml文件配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim mapred-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><h5 id="yarn-site-xml配置"><a href="#yarn-site-xml配置" class="headerlink" title="yarn-site.xml配置"></a>yarn-site.xml配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/etc/hadoop</span><br><span class="line">vim yarn-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;  </span><br><span class="line">&lt;property&gt;  </span><br><span class="line">        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;  </span><br><span class="line">        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;  </span><br><span class="line">&lt;/property&gt;  </span><br><span class="line">&lt;property&gt;  </span><br><span class="line">        &lt;name&gt;yarn.resourcemanager.webapp.address&lt;/name&gt;  </span><br><span class="line">        &lt;value&gt;192.168.2.10:8099&lt;/value&gt;  </span><br><span class="line">        &lt;description&gt;这个地址是mr管理界面的&lt;/description&gt;  </span><br><span class="line">&lt;/property&gt;  </span><br><span class="line">&lt;/configuration&gt;  </span><br></pre></td></tr></table></figure><p>执行名称结点格式化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">./bin/hdfs namenode -format</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/41.png" alt="1685192609644"></p><p>显示这个就是成功</p><p>ps：如果显示没有java啥的，重新看看<code>vim ~/.bashrc</code>里面的东西在不在，然后<code>source</code></p><h4 id="启动hadoop"><a href="#启动hadoop" class="headerlink" title="启动hadoop"></a>启动hadoop</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/</span><br><span class="line">./sbin/start-dfs.sh</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/42.png" alt="1685192760524"></p><p>打yes</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/43.png" alt="1685194525156"></p><p>再打</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/44.png" alt="1685195119670"></p><p>成功</p><p>但是还要干点东西，不知道为啥书上没看懂</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们在配置文件中配置了一些文件夹路径，现在我们来创建他们，在/usr/local/hadoop/目录下使用hadoop用户操作，建立tmp、hdfs/name、hdfs/data目录，执行如下命令：</span><br><span class="line">mkdir -p /usr/local/hadoop/tmp </span><br><span class="line">mkdir /usr/local/hadoop/hdfs </span><br><span class="line">mkdir /usr/local/hadoop/hdfs/data </span><br><span class="line">mkdir /usr//localhadoop/hdfs/name</span><br></pre></td></tr></table></figure><h5 id="将Hadoop添加到环境变量中"><a href="#将Hadoop添加到环境变量中" class="headerlink" title="将Hadoop添加到环境变量中"></a>将Hadoop添加到环境变量中</h5><p>切换到root用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p>插入</p><figure class="highlight plaintext"><figcaption><span>HADOOP_HOME</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure><p>使之生效</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>确保 <code>bin</code> 目录已添加到 <code>PATH</code> 环境变量中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/usr/local/hadoop/bin:$PATH</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>现在配置工作已经基本搞定，接下来只需要完成：1.格式化<code>HDFS</code>文件、2.启动<code>hadoop</code>、3.验证<code>Hadoop</code> 即可。</p><h5 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h5><p>在使用<code>Hadoop</code>之前我们需要格式化一些<code>hadoop</code>的基本信息。 使用如下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop namenode -format</span><br></pre></td></tr></table></figure><p>出现如下界面代表成功：</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/45.png" alt="1685196452276"></p><h5 id="启动Hadoop"><a href="#启动Hadoop" class="headerlink" title="启动Hadoop"></a>启动Hadoop</h5><p>接下来我们启动<code>Hadoop</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/46.png" alt="预览大图"></p><p>这个是表示启动没成功，是因为<code>root</code>用户现在还不能启动<code>hadoop</code>，我们来设置一下就可以了。</p><p>在<code>/hadoop/sbin</code>路径下： <code>cd /usr/local/hadoop/sbin</code>。</p><p>将<code>start-dfs.sh</code>，<code>stop-dfs.sh</code>两个文件顶部添加以下参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">HDFS_DATANODE_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=hdfs</span><br><span class="line">HDFS_NAMENODE_USER=root</span><br><span class="line">HDFS_SECONDARYNAMENODE_USER=root</span><br></pre></td></tr></table></figure><p>还有，<code>start-yarn.sh</code>，<code>stop-yarn.sh</code>顶部也需添加以下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=yarn</span><br><span class="line">YARN_NODEMANAGER_USER=root</span><br></pre></td></tr></table></figure><p>再次启动<code>start-dfs.sh</code>，最后输入命令 <code>jps</code> 验证,出现如下界面代表启动成功：</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/44.png" alt="1685195119670"></p><p><em><strong>下次启动就不要再执行namenode -format那个命令了！！！！</strong></em></p><h1 id="五、HDFS操作常用Shell命令"><a href="#五、HDFS操作常用Shell命令" class="headerlink" title="五、HDFS操作常用Shell命令"></a>五、HDFS操作常用Shell命令</h1><h4 id="1-1-启动HDFS服务"><a href="#1-1-启动HDFS服务" class="headerlink" title="1.1 启动HDFS服务"></a>1.1 启动HDFS服务</h4><p>1.使用start-dfs.sh命令启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure><p>2.使用JPS命令查看是否启动成功<br><strong>jps</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/44.png" alt="1685195119670"></p><h4 id="1-2-help-命令"><a href="#1-2-help-命令" class="headerlink" title="1.2 help 命令"></a>1.2 help 命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs  dfs  -help</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/47.png" alt="1685198775065"></p><h4 id="1-3-ls-命令"><a href="#1-3-ls-命令" class="headerlink" title="1.3 ls 命令"></a>1.3 ls 命令</h4><p>功能：显示目录信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -ls /</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/48.png" alt="1685198866616"></p><p><em>可以看到找到一个&#x2F;user文件</em></p><h4 id="1-4-mkdir-命令"><a href="#1-4-mkdir-命令" class="headerlink" title="1.4 mkdir 命令"></a>1.4 mkdir 命令</h4><p>功能：在 hdfs 上创建目录</p><p>1.在根目录的 user 文件夹下创建 hadoop 文件夹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">hdfs dfs -mkdir  /user/hadoop</span><br></pre></td></tr></table></figure><p>2.使用 ls 命令查看，可以看到出现了hadoop 文件夹：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs  dfs -ls  /user</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/49.png" alt="1685199066453"></p><h4 id="1-5-put-命令"><a href="#1-5-put-命令" class="headerlink" title="1.5 put 命令"></a>1.5 put 命令</h4><p>功能：上传 Linux 系统中的文件到 HDFS 文件系统的指定目录</p><p>1.首先使用 vi 命令在 linux本地编辑一份数据文件 输入命令：vi stu01.txt</p><p><strong>vi stu01.txt</strong></p><p>按 <strong>i键</strong>进入编辑模式，左下角出现–INSERT–字符后，输入以下内容，</p><p><strong>234</strong></p><p><strong>5678</strong></p><p><strong>Hadoop</strong></p><p>然后按<strong>ESC 键</strong>，左下角–INSERT–字符消失后，在英文输入状态下输入 <strong>:wq</strong> ，回车保存退出文件。</p><p>2.将刚刚创建的stu01.txt文件上传到HDFS上面</p><p><strong>hdfs dfs -put stu01.txt &#x2F;user&#x2F;hadoop</strong></p><p>3.使用 ls 命令查看，可以看到出现了stu01.txt文件</p><p><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/50.png" alt="1685202619219"></p><h4 id="1-6-cat-命令"><a href="#1-6-cat-命令" class="headerlink" title="1.6 cat 命令"></a>1.6 cat 命令</h4><p>功能：显示文件内容</p><p><strong>hdfs dfs -cat &#x2F;user&#x2F;hadoop&#x2F;stu01.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/51.png" alt="1685202707851"></p><h4 id="1-7-text-命令"><a href="#1-7-text-命令" class="headerlink" title="1.7 text 命令"></a>1.7 text 命令</h4><p>功能：以字符形式打印一个文件的内容</p><p><strong>hdfs dfs -text &#x2F;user&#x2F;hadoop&#x2F;stu01.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/52.png" alt="1685202765362"></p><h4 id="1-8-cp-命令"><a href="#1-8-cp-命令" class="headerlink" title="1.8 cp 命令"></a>1.8 cp 命令</h4><p>功能：从 hdfs 的一个路径拷贝 hdfs 的另一个路径</p><p>1.查看HDFS上的根目录下的内容</p><p><strong>hdfs dfs -ls &#x2F;</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/53.png" alt="1685202832771"></p><p>2.查看HDFS上的&#x2F;user&#x2F;hadoop下的内容<br><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop</strong></p><p>3.将&#x2F;user&#x2F;hadoop下的stu01.txt拷贝到根目录下</p><p><strong>hdfs dfs -cp &#x2F;user&#x2F;hadoop&#x2F;stu01.txt &#x2F;</strong></p><p>4.再次查看HDFS上的根目录下的内容</p><p><strong>hdfs dfs -ls &#x2F;</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/54.png" alt="1685202983534"></p><p><em>从上面的图中可以看出文件已经被复制到了HDFS的根目录下。</em></p><h4 id="1-9-mv-命令"><a href="#1-9-mv-命令" class="headerlink" title="1.9 mv 命令"></a>1.9 mv 命令</h4><p>功能：从 hdfs 的一个路径拷贝 hdfs 的另一个路径</p><p>1.在HDFS上面创建一个新的目录<br><strong>hdfs dfs -mkdir &#x2F;user&#x2F;hadoop2</strong><br><strong>hdfs dfs -ls &#x2F;user</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/55.png" alt="1685203093936"></p><p>2.查看HDFS上的根目录下的内容<br><strong>hdfs dfs -ls &#x2F;</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/56.png" alt="1685203176090"></p><p>3.将跟目录下的stu01.txt移动到&#x2F;user&#x2F;hadoop2下</p><p><strong>hdfs dfs -mv &#x2F;stu01.txt &#x2F;user&#x2F;hadoop2</strong></p><p>4.再次查看HDFS上的根目录下的内容</p><p><strong>hdfs dfs -ls &#x2F;</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/57.png" alt="1685203297506"></p><p>5.查看&#x2F;user&#x2F;stu02下的内容<br><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop2</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/58.png" alt="1685203353082"></p><p><em>从上面的图中可以看出文件已经被移动到了&#x2F;user&#x2F;stu02的根目录下。</em></p><h4 id="1-10-rm-命令"><a href="#1-10-rm-命令" class="headerlink" title="1.10 rm 命令"></a>1.10 rm 命令</h4><p>功能：删除 hdfs 文件或文件夹</p><p>1.将HDFS上面的&#x2F;user&#x2F;hadoop&#x2F;stu01.txt文件删除</p><p><strong>hdfs dfs -rm &#x2F;user&#x2F;hadoop&#x2F;stu01.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/59.png" alt="1685203456655"></p><p><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop</strong><br><em>没有显示stu01.txt结果，则正确。</em></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/60.png" alt="1685203653530"></p><p>2.将HDFS上面的&#x2F;user&#x2F;hadoop&#x2F;input&#x2F;文件夹删除<br><strong>hdfs dfs -rm -r &#x2F;user&#x2F;hadoop&#x2F;input</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/61.png" alt="1685203722917"></p><p><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/62.png" alt="1685203775061"></p><p>删除成功</p><h4 id="2-1-moveFromLocal命令"><a href="#2-1-moveFromLocal命令" class="headerlink" title="2.1 moveFromLocal命令"></a>2.1 moveFromLocal命令</h4><p>功能：从本地剪切粘贴到 hdfs</p><p>1.使用 vi 命令在 linux 本地先创建一个数据文件，stu01_2.txt</p><p><strong>vi stu01_2.txt</strong> 按 i 进入编辑模式，输入内容，</p><p>**hadoop **</p><p><strong>hive</strong></p><p>然后按 esc 键，再同时按下 shift 和冒号键，输入 wq，保存退出。</p><p>2.查看本地目录中的文件</p><p><strong>ls</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/63.png" alt="1685204261895"></p><p>3.将该文件从本地剪切粘贴到 hdfs</p><p><strong>hdfs dfs -mkdir &#x2F;user&#x2F;hadoop&#x2F;</strong></p><p><strong>hdfs dfs -moveFromLocal stu01-2.txt &#x2F;user&#x2F;hadoop&#x2F;</strong></p><p>4.查看本地文件</p><p><strong>ls</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/64.png" alt="1685204419455"></p><p>5.查看HDFS上面的文件</p><p><strong>hdfs dfs -ls &#x2F;user&#x2F;hadoop&#x2F;</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/65.png" alt="1685204477195"></p><p>6.查看文件的内容</p><p><strong>hdfs dfs -cat &#x2F;user&#x2F;hadoop&#x2F;stu01-2.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/66.png" alt="1685204545062"></p><p><em>可以看到和我们写入的内容一致，而且本地中也没有了该文件，该文件已经被剪切到了HDFS上面。</em></p><h4 id="2-2-appendToFile-命令"><a href="#2-2-appendToFile-命令" class="headerlink" title="2.2 appendToFile 命令"></a>2.2 appendToFile 命令</h4><p>功能：追加一个文件到已经存在的文件末尾</p><p>1.创建本地stu01.txt文件的内容</p><p><strong>vi stu01.txt</strong></p><p>按下<strong>i</strong>键进入编辑模式，左下角出现–INSERT–后，将以下内容输入</p><p><strong>234</strong></p><p><strong>5678</strong></p><p><strong>Hadoop</strong></p><p>输入完成后，按下<strong>ESC键</strong>，左下角–INSERT–消失后，在英文状态下输入 <strong>:wq</strong> ，回车保存退出文件。</p><p>2.查看HDFS上面的stu01-2.txt文件的内容</p><p><strong>hdfs dfs -cat &#x2F;user&#x2F;hadoop&#x2F;stu01-2.txt</strong></p><p><code>234</code></p><p><code>5678</code></p><p><code>hadoop</code></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/67.png" alt="1685204861869"></p><p>3.将本地stu01.txt文件的内容追加写到HDFS上面的stu01_2.txt文件中</p><p><strong>hdfs dfs -appendToFile stu01.txt &#x2F;user&#x2F;hadoop&#x2F;stu01-2.txt</strong></p><p>4.再次查看HDFS上面的stu01-2.txt文件的内容</p><p><strong>hdfs dfs -cat &#x2F;user&#x2F;hadoop&#x2F;stu01-2.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/68.png" alt="1685204947959"></p><h4 id="2-3-get-命令"><a href="#2-3-get-命令" class="headerlink" title="2.3 get 命令"></a>2.3 get 命令</h4><p>功能：等同于 copyToLocal，就是从 hdfs 下载文件到本地</p><p>1.查看本地目录中的文件</p><p><strong>ls</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/69.png" alt="1685205045298"></p><p>2.将stu01_2.txt文件下载到本地</p><p>**hdfs dfs -get &#x2F;user&#x2F;hadoop&#x2F;stu01-2.txt **</p><p>3.查看本地目录中的文件</p><p><strong>ls</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/70.png" alt="1685205084641"></p><p>4.查看stu01-2.txt中的内容</p><p><strong>cat stu01_2.txt</strong></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/71.png" alt="1685205126650"></p><h1 id="六、Spark下载"><a href="#六、Spark下载" class="headerlink" title="六、Spark下载"></a>六、Spark下载</h1><p>进入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /home/hadoop/Downloads</span><br><span class="line">tar -zxvf spark-2.1.0-bin-without-hadoop.tgz</span><br><span class="line">mv spark-2.1.0-bin-without-hadoop  spark #改名</span><br><span class="line">sudo spark /usr/local </span><br></pre></td></tr></table></figure><p>加上权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R hadoop:hadoop ./spark</span><br></pre></td></tr></table></figure><p>复制一份</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./conf/spark-env.sh.template  ./conf/spark-env.sh</span><br></pre></td></tr></table></figure><p>编辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim spark-env.sh</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export SPARK_DIST_CLASSPATH=$(/usr/local/hadoop/bin/hadoop classpath)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/79.png" alt="1685260995121"></p><p>检验是否成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark</span><br><span class="line">bin/run-example SparkPi</span><br></pre></td></tr></table></figure><p>过滤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/run-example  SparkPi 2&gt;&amp;1 | grep &quot;Pi is roughly&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/80.png" alt="1685261139576"></p><h1 id="七、在spark-shell中运行"><a href="#七、在spark-shell中运行" class="headerlink" title="七、在spark-shell中运行"></a>七、在spark-shell中运行</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark</span><br><span class="line"> ./bin/spark-shell</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/81.png" alt="1685262195916"></p><h1 id="八、安装MySQL"><a href="#八、安装MySQL" class="headerlink" title="八、安装MySQL"></a>八、安装MySQL</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server</span><br></pre></td></tr></table></figure><p>启动mysql服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysql stop 先手动关</span><br><span class="line">service mysql start再手动开</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/82.png" alt="1685262504893"></p><p>看是否成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -tap | grep mysql</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/83.png" alt="1685262547044"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/84.png" alt="1685262954690"></p><p>没有权限</p><p>用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>然后输入这个 密码输入是’123’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;123&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/85.png" alt="1685263053475"></p><p>好了</p><p>修改乱码问题</p><p><code>atin1</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;char%&quot;;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/86.png" alt="1685263155580"></p><p>修改配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/mysql/mysql.conf.d/</span><br><span class="line">vim mysqlb.cnf</span><br></pre></td></tr></table></figure><p>在mysqld.cnf添加</p><p><code>character_set_server=utf8</code></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/87.png" alt="1685263422570"></p><p>重启mysql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure><p>再进去mysql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p>再查看编码方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &quot;char%&quot;;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/88.png" alt="1685263835946"></p><p>好了</p><h3 id="mysql常用操作"><a href="#mysql常用操作" class="headerlink" title="mysql常用操作"></a>mysql常用操作</h3><h6 id="1-1显示数据库"><a href="#1-1显示数据库" class="headerlink" title="1.1显示数据库"></a>1.1显示数据库</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/89.png" alt="1685263940575"></p><h5 id="2-2显示数据库中的表"><a href="#2-2显示数据库中的表" class="headerlink" title="2.2显示数据库中的表"></a>2.2显示数据库中的表</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/90.png" alt="1685264067018"></p><h5 id="3-3显示数据表的结构"><a href="#3-3显示数据表的结构" class="headerlink" title="3.3显示数据表的结构"></a>3.3显示数据表的结构</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">describe user(表名);</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/91.png" alt="1685264110204"></p><h5 id="3-4查询表中的记录"><a href="#3-4查询表中的记录" class="headerlink" title="3.4查询表中的记录"></a>3.4查询表中的记录</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user(表名);</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/92.png" alt="1685264219643"></p><h5 id="3-5创建数据库"><a href="#3-5创建数据库" class="headerlink" title="3.5创建数据库"></a>3.5创建数据库</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database 库名;</span><br></pre></td></tr></table></figure><p>创建一个名称为aaa</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database aaa;</span><br></pre></td></tr></table></figure><h5 id="3-6创建表"><a href="#3-6创建表" class="headerlink" title="3.6创建表"></a>3.6创建表</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use 库名;</span><br><span class="line">create table 表名(字段设定列表);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use aaa;</span><br><span class="line">create table person (id int(3) auto_increment not null primary key,xm varchar(10),xb varchar(2),csny date);</span><br></pre></td></tr></table></figure><p>显示person表的结构</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">describe person;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/93.png" alt="1685264596457"></p><h5 id="3-7增加记录"><a href="#3-7增加记录" class="headerlink" title="3.7增加记录"></a>3.7增加记录</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into person values(null,&#x27;张三&#x27;,&#x27;男&#x27;,&#x27;1997-01-02&#x27;);</span><br><span class="line">insert into person values(null,&#x27;李四&#x27;,&#x27;女&#x27;,&#x27;1998-05-04&#x27;);</span><br></pre></td></tr></table></figure><p>用select查询person表的记录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from person;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/94.png" alt="1685264874151"></p><h5 id="3-8修改记录"><a href="#3-8修改记录" class="headerlink" title="3.8修改记录"></a>3.8修改记录</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update person set csny=&#x27;1971-01-10&#x27; where xm=&#x27;张三&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/95.png" alt="1685264965167"></p><h5 id="3-9删除记录"><a href="#3-9删除记录" class="headerlink" title="3.9删除记录"></a>3.9删除记录</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from person where xm=&#x27;张三&#x27;;</span><br></pre></td></tr></table></figure><h5 id="3-10删除数据库和表"><a href="#3-10删除数据库和表" class="headerlink" title="3.10删除数据库和表"></a>3.10删除数据库和表</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop database 库名;</span><br><span class="line">drop table 表名;</span><br></pre></td></tr></table></figure><h5 id="3-11看mysql版本"><a href="#3-11看mysql版本" class="headerlink" title="3.11看mysql版本"></a>3.11看mysql版本</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;version&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/96.png" alt="1685265089600"></p><h1 id="九、Scala安装"><a href="#九、Scala安装" class="headerlink" title="九、Scala安装"></a>九、Scala安装</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /home/hadoop/Downloads</span><br><span class="line">tar -zxvf scala-2.11.8.tgz</span><br><span class="line">mv scala-2.11.8  scala #改名</span><br><span class="line">sudo scala /usr/local </span><br><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/usr/local/scala/bin</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>检查scala是否安装成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/97.png" alt="1685269159574"></p><h1 id="十、IntelliJ-IDEA开发工具的安装和使用方法"><a href="#十、IntelliJ-IDEA开发工具的安装和使用方法" class="headerlink" title="十、IntelliJ IDEA开发工具的安装和使用方法"></a>十、IntelliJ IDEA开发工具的安装和使用方法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /home/hadoop/Downloads</span><br><span class="line">tar -zxvf ideaIU-2017.3.5.tar.gz</span><br><span class="line">mv idea-IU-173.4674.33 idea  #改名</span><br><span class="line">sudo mv idea /usr/local </span><br></pre></td></tr></table></figure><h1 id="十一、启动IDEA"><a href="#十一、启动IDEA" class="headerlink" title="十一、启动IDEA"></a>十一、启动IDEA</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/idea</span><br><span class="line">./bin/idea.sh</span><br></pre></td></tr></table></figure><p>会显示</p><p>一个界面忘记截图了</p><p>然后</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/98.png" alt="1685270925380"></p><p>我选的evaluate for free</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/99.png" alt="1685271025736"></p><h4 id="1-为IDEA安装Scala插件"><a href="#1-为IDEA安装Scala插件" class="headerlink" title="1.为IDEA安装Scala插件"></a>1.为IDEA安装Scala插件</h4><p>点plugins</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/100.png" alt="1685271144033"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/101.png" alt="1685271268655"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/102.png" alt="1685271312332"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/103.png" alt="1685271339540"></p><h4 id="2-配置JDK"><a href="#2-配置JDK" class="headerlink" title="2.配置JDK"></a>2.配置JDK</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/104.png" alt="1685271410325"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/105.png" alt="1685271441447"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/106.png" alt="1685271471890"></p><h4 id="3-创建一个新项目WordCount"><a href="#3-创建一个新项目WordCount" class="headerlink" title="3.创建一个新项目WordCount"></a>3.创建一个新项目WordCount</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/107.png" alt="1685271523118"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/108.png" alt="1685271563074"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/109.png" alt="1685271626948"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/110.png" alt="1685271651301"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/111.png" alt="1685271769565"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/112.png" alt="1685271806997"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/113.png" alt="1685271836024"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/114.png" alt="1685271870252"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/115.png" alt="1685271886513"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/116.png" alt="1685271905730"></p><h4 id="4-设置目录"><a href="#4-设置目录" class="headerlink" title="4.设置目录"></a>4.设置目录</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/117.png" alt="1685271994038"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/118.png" alt="1685272015590"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/119.png" alt="1685272055139"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/120.png" alt="1685272092519"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/121.png" alt="1685272125104"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/122.png" alt="1685272147217"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/123.png" alt="1685272271767"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span>._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> inputFile =  <span class="string">&quot;file:///usr/local/spark/mycode/wordcount/word.txt&quot;</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WordCount&quot;</span>).setMaster(<span class="string">&quot;local&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">    <span class="keyword">val</span> textFile = sc.textFile(inputFile)</span><br><span class="line">    <span class="keyword">val</span> wordCount = textFile.flatMap(line =&gt; line.split(<span class="string">&quot; &quot;</span>)).map(word =&gt; (word, <span class="number">1</span>)).reduceByKey((a, b) =&gt; a + b)</span><br><span class="line">    wordCount.foreach(println)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>记得去mycode里面船舰一个wordcount</p><h4 id="5-配置pom-xml文件"><a href="#5-配置pom-xml文件" class="headerlink" title="5.配置pom.xml文件"></a>5.配置pom.xml文件</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/124.png" alt="1685272480099"></p><p>输入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dblab<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>WordCount<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scala.version</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">scala.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-hive_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-mllib_$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-scala-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/125.png" alt="1685272619864"></p><p>emm….因为前面没有安装maven所以，压根九不能自动生成</p><p>首先装一下maven</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install maven</span><br></pre></td></tr></table></figure><p>命令检查 Maven 是否已安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -v</span><br></pre></td></tr></table></figure><p>然后在terminal里面输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/126.png" alt="1685274127953"></p><p>然后就自动安装依赖环境了，有点久</p><p>然后</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/127.png" alt="1685278544534"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/129.png" alt="1685282343457"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/128.png" alt="1685282309762"></p><p>搞定了</p><h4 id="6-打包WordCount程序生成JAR包"><a href="#6-打包WordCount程序生成JAR包" class="headerlink" title="6.打包WordCount程序生成JAR包"></a>6.打包WordCount程序生成JAR包</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/130.png" alt="1685282444814"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/131.png" alt="1685282485542"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/132.png" alt="1685282560600"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/133.png" alt="1685282626558"></p><p>只保留这两个</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/134.png" alt="1685282715895"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/135.png" alt="1685283580402"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/136.png" alt="1685283604818"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/137.png" alt="1685283626589"></p><p>生成的JAR在~&#x2F;IdeaProjects&#x2F;WordCount&#x2F;out&#x2F;artifacts&#x2F;WordCount_jar&#x2F;WordCount.jar</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/138.png" alt="1685283743535"></p><h4 id="7-把JAR包提交到Spark中运行"><a href="#7-把JAR包提交到Spark中运行" class="headerlink" title="7.把JAR包提交到Spark中运行"></a>7.把JAR包提交到Spark中运行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark</span><br><span class="line">./bin/spark-submit --class &quot;WordCount&quot; ~/IdeaProjects/WordCount/out/artifacts/WordCount_jar/WordCount.jar</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/139.png" alt="1685284011953"></p><h1 id="十二、安装Kettle"><a href="#十二、安装Kettle" class="headerlink" title="十二、安装Kettle"></a>十二、安装Kettle</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">sudo mkdir kettle</span><br><span class="line">sudo chown -R hadoop ./kettle #用用户赋予针对kettle目录的操作权限</span><br></pre></td></tr></table></figure><p>把安装包data-integration.zip解压到安装目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">sudo unzip ~/Downloads/data-integration.zip</span><br><span class="line">sudo mv data-integration /usr/local/kettle</span><br></pre></td></tr></table></figure><h4 id="1-复制MySQL数据库驱动程序JAR包"><a href="#1-复制MySQL数据库驱动程序JAR包" class="headerlink" title="1.复制MySQL数据库驱动程序JAR包"></a>1.复制MySQL数据库驱动程序JAR包</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Downloads</span><br><span class="line">sudo unzip mysql-connector-java-5.1.40.zip</span><br><span class="line">sudo cp ./mysql-connector-java-5.1.40/mysql-connector-java-5.1.40 /usr/local/kettle/data-integration/lib</span><br></pre></td></tr></table></figure><h4 id="2-启动Kettle中的Spoon"><a href="#2-启动Kettle中的Spoon" class="headerlink" title="2.启动Kettle中的Spoon"></a>2.启动Kettle中的Spoon</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/kettle/data-integration</span><br><span class="line">chmod +x spoon.sh #设置权限</span><br><span class="line">sudo ./spoon.sh</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/140.png" alt="1685285957893"></p><h4 id="3-使用Kettle把数据加载到HDFS中"><a href="#3-使用Kettle把数据加载到HDFS中" class="headerlink" title="3.使用Kettle把数据加载到HDFS中"></a>3.使用Kettle把数据加载到HDFS中</h4><ul><li>配置Kettle</li></ul><p>先创建一个word.txt文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">vim word.txt</span><br></pre></td></tr></table></figure><p>随便输入一点英文</p><p>然后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/kettle/data-integration/plugins/pentaho-big-data-plugin/hadoop-configurations/cdh55/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim config.properties </span><br></pre></td></tr></table></figure><p>最后一行输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authentication.superuser.provider=NO_AUTH</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mv core-site.xml ./core-site.xml.bak</span><br><span class="line">mv mapred-site.xml ./mapred-site.xml.bak</span><br><span class="line">mv yarn-site.xml ./yarn-site.xml.bak</span><br><span class="line">cp /usr/local/hadoop/etc/hadoop/mapred-site.xml ./mapred-site.xml</span><br><span class="line">cp /usr/local/hadoop/etc/hadoop/yarn-site.xml ./</span><br><span class="line">cp /usr/local/hadoop/etc/hadoop/core-site.xml ./</span><br></pre></td></tr></table></figure><ul><li>新建作业</li></ul><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/141.png" alt="1685334227311"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/142.png" alt="1685334262155"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/143.png" alt="1685334291930"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/144.png" alt="1685334370303"></p><p>这边的post端口必须和之前配置的core-site.xml的设置一样，其他参数可以不改动</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/145.png" alt="1685334394578"></p><p>点击测试后就是下面三×，其他全勾才对。得保证hadoop开启了。<img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/147.png" alt="1685334916654"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/146.png" alt="1685334574781"></p><ul><li>添加START组件</li></ul><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/148.png" alt="1685335309177"></p><p>拖拽一个START到右侧</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/149.png" alt="1685335404082"></p><p>然后去JHDFS创建目录input_spark</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">hdfs dfs -mkdir /input_spark</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/150.png" alt="1685335697903"></p><p>建立连接（按住shift和鼠标左键）</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/152.png" alt="1685336425475"></p><p>双击 Hadoop Copy File 那么设置</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/151.png" alt="1685335750060"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/153.png" alt="1685336517970"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/154.png" alt="1685336542756"></p><p>执行成功</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/155.png" alt="1685336580568"></p><p>然后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">hdfs dfs -ls /input_spark</span><br></pre></td></tr></table></figure><p>就能看到信息</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/156.png" alt="1685336783168"></p><p><em><strong>那么做的意义是用工具kettle把数据从本地文件加载到HDFS中</strong></em></p><h1 id="十三、使用Spark-SQL读写MySQL数据库的方法"><a href="#十三、使用Spark-SQL读写MySQL数据库的方法" class="headerlink" title="十三、使用Spark SQL读写MySQL数据库的方法"></a>十三、使用Spark SQL读写MySQL数据库的方法</h1><h4 id="1-创建MySQL数据库"><a href="#1-创建MySQL数据库" class="headerlink" title="1.创建MySQL数据库"></a>1.创建MySQL数据库</h4><p>启动数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p>创建数据库和表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create database spark;</span><br><span class="line">use spark;</span><br><span class="line">create table student (id int(4), name char(20),gender char(4),age int (4));</span><br><span class="line">insert into student values(1,&#x27;Xueqian&#x27;,&#x27;F&#x27;,23);</span><br><span class="line">insert into student values(2,&#x27;Weiliang&#x27;,&#x27;M&#x27;,24);</span><br><span class="line">select * from student;</span><br></pre></td></tr></table></figure><h4 id="2-在spark-shell中读写mysql数据库"><a href="#2-在spark-shell中读写mysql数据库" class="headerlink" title="2.在spark-shell中读写mysql数据库"></a>2.在spark-shell中读写mysql数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Downloads</span><br><span class="line"> cp ./mysql-connector-java-5.1.40/mysql-connector-java-5.1.40-bin.jar /usr/local/spark/jars/</span><br></pre></td></tr></table></figure><p>启动spark shell 时，必须指定MySQL连接驱动JAR包，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark</span><br><span class="line">./bin/spark-shell --jars /usr/local/spark/jars/mysql-connector-java-5.1.40-bin.jar  --driver-class-path /usr/local/spark/jars/mysql-connector-java-5.1.40-bin.jar </span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/157.png" alt="1685338120883"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val jdbcDF= spark.read.format(&quot;jdbc&quot;).</span><br><span class="line">     option(&quot;url&quot;,&quot;jdbc:mysql://localhost:3306/spark&quot;).</span><br><span class="line">     option(&quot;driver&quot;,&quot;com.mysql.jdbc.Driver&quot;).</span><br><span class="line">     option(&quot;dbtable&quot;,&quot;student&quot;).</span><br><span class="line">     option(&quot;user&quot;,&quot;root&quot;).</span><br><span class="line">     option(&quot;password&quot;,&quot;123&quot;).</span><br><span class="line">     option(&quot;useSSL&quot;, &quot;false&quot;).</span><br><span class="line">     load()</span><br></pre></td></tr></table></figure><p>如果出现了，不用在意，好像对下面操作影响不大</p><hr><p>Sun May 28 22:52:36 PDT 2023 WARN: Establishing SSL connection without server’s identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn’t set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to ‘false’. You need either to explicitly disable SSL by setting useSSL&#x3D;false, or set useSSL&#x3D;true and provide truststore for server certificate verification.<br>jdbcDF: org.apache.spark.sql.DataFrame &#x3D; [id: int, name: string … 2 more fields]</p><hr><p>输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF.show()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/158.png" alt="1685340272475"></p><h4 id="3-向MySQL数据库写入数据"><a href="#3-向MySQL数据库写入数据" class="headerlink" title="3.向MySQL数据库写入数据"></a>3.向MySQL数据库写入数据</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以下代码需要一行一行地输入到spark-shell交互式环境中执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span> </span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">Row</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//下面设置两条数据，表示两个学生的信息</span></span><br><span class="line"><span class="keyword">val</span> studentRDD = spark.sparkContext.parallelize(<span class="type">Array</span>(<span class="string">&quot;3 Rongcheng M 26&quot;</span>,<span class="string">&quot;4 Guanhua M 27&quot;</span>)).map(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"> </span><br><span class="line"><span class="comment">//下面设置模式信息</span></span><br><span class="line"><span class="keyword">val</span> schema = <span class="type">StructType</span>(<span class="type">List</span>(<span class="type">StructField</span>(<span class="string">&quot;id&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),<span class="type">StructField</span>(<span class="string">&quot;name&quot;</span>, <span class="type">StringType</span>, <span class="literal">true</span>),<span class="type">StructField</span>(<span class="string">&quot;gender&quot;</span>, <span class="type">StringType</span>, <span class="literal">true</span>),<span class="type">StructField</span>(<span class="string">&quot;age&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>)))</span><br><span class="line"> </span><br><span class="line"><span class="comment">//下面创建Row对象，每个Row对象都是rowRDD中的一行</span></span><br><span class="line"><span class="keyword">val</span> rowRDD = studentRDD.map(p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>).toInt, p(<span class="number">1</span>).trim, p(<span class="number">2</span>).trim, p(<span class="number">3</span>).toInt))</span><br><span class="line"> </span><br><span class="line"><span class="comment">//建立起Row对象和模式之间的对应关系，也就是把数据和模式对应起来</span></span><br><span class="line"><span class="keyword">val</span> studentDF = spark.createDataFrame(rowRDD, schema)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//下面创建一个prop变量用来保存JDBC连接参数</span></span><br><span class="line"><span class="keyword">val</span> prop = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;root&quot;</span>) <span class="comment">//表示用户名是root</span></span><br><span class="line">prop.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;123&quot;</span>) <span class="comment">//表示密码是123</span></span><br><span class="line">prop.put(<span class="string">&quot;driver&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>) <span class="comment">//表示驱动程序是com.mysql.jdbc.Driver</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//下面连接数据库，采用append模式，表示追加记录到数据库spark的student表中</span></span><br><span class="line">studentDF.write.mode(<span class="string">&quot;append&quot;</span>).jdbc(<span class="string">&quot;jdbc:mysql://localhost:3306/spark&quot;</span>,<span class="string">&quot;spark.student&quot;</span>,prop)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF.show()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/159.png" alt="1685353146978"></p><h4 id="4-编写独立应用程序读写MySQL数据库"><a href="#4-编写独立应用程序读写MySQL数据库" class="headerlink" title="4.编写独立应用程序读写MySQL数据库"></a>4.编写独立应用程序读写MySQL数据库</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/160.png" alt="1685353875195"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/161.png" alt="1685353929474"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/162.png" alt="1685353976875"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/163.png" alt="1685354043177"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/164.png" alt="1685354118424"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/165.png" alt="1685354165755"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/166.png" alt="1685354350410"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/167.png" alt="1685354421083"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/119.png" alt="1685272055139"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/120.png" alt="1685272092519"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/121.png" alt="1685272125104"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/168.png" alt="1685354538874"></p><p>在SparkOperateMySQL写入</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.&#123;<span class="type">Row</span>, <span class="type">SparkSession</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkOperateMySQL</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> spark= <span class="type">SparkSession</span>.builder().appName(<span class="string">&quot;sqltest&quot;</span>).master(<span class="string">&quot;local[2]&quot;</span>).getOrCreate()</span><br><span class="line">    <span class="keyword">val</span> jdbcDF = spark.</span><br><span class="line">      read.format(<span class="string">&quot;jdbc&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://localhost:3306/spark&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;driver&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;student&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123&quot;</span>).load()</span><br><span class="line">    jdbcDF.show()</span><br><span class="line">    <span class="keyword">val</span> studentRDD = spark.sparkContext.parallelize(<span class="type">Array</span>(<span class="string">&quot;5 Chenglu F 22&quot;</span>,<span class="string">&quot;6 Linzhe M 23&quot;</span>)).map(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> rowRDD = studentRDD.map(p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>).toInt, p(<span class="number">1</span>).trim, p(<span class="number">2</span>).trim, p(<span class="number">3</span>).toInt))</span><br><span class="line">    rowRDD.foreach(println)</span><br><span class="line">    <span class="keyword">val</span> schema = <span class="type">StructType</span>(<span class="type">List</span>(</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;id&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;name&quot;</span>, <span class="type">StringType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;gender&quot;</span>, <span class="type">StringType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;age&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>)))</span><br><span class="line">    <span class="keyword">val</span> studentDF=spark.createDataFrame(rowRDD,schema)</span><br><span class="line">    <span class="keyword">val</span> prop = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    prop.put(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">    prop.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123&quot;</span>)</span><br><span class="line">    prop.put(<span class="string">&quot;driver&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>)</span><br><span class="line">    studentDF.write.mode(<span class="string">&quot;append&quot;</span>).jdbc(<span class="string">&quot;jdbc:mysql://localhost:3306/spark&quot;</span>, <span class="string">&quot;spark.student&quot;</span>, prop)</span><br><span class="line">    jdbcDF.show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在pom.xml中添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dblab<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.40<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/125.png" alt="1685272619864"></p><p>看到下面有这个就是在下载</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/169.png" alt="1685355010668"></p><p>run一下</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/170.png" alt="1685355401632"></p><h4 id="5-生成应用程序JAR包"><a href="#5-生成应用程序JAR包" class="headerlink" title="5.生成应用程序JAR包"></a>5.生成应用程序JAR包</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/130.png" alt="1685282444814"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/131.png" alt="1685282485542"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/171.png" alt="1685355576293"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/172.png" alt="1685355685885"></p><p>同之前的一样</p><p>只删剩</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/173.png" alt="1685355764997"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/136.png" alt="1685283604818"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/137.png" alt="1685283626589"></p><p>生成的在~&#x2F;IdeaProjects&#x2F;SparkMySQL&#x2F;out&#x2F;artifacts&#x2F;SparkMySQL_jar&#x2F;SparkMySQL.jar中</p><h4 id="6-把JAR包提交到Spark中运行"><a href="#6-把JAR包提交到Spark中运行" class="headerlink" title="6.把JAR包提交到Spark中运行"></a>6.把JAR包提交到Spark中运行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> cd /usr/local/spark/</span><br><span class="line">./bin/spark-submit --class &quot;SparkOperateMySQL&quot; ~/IdeaProjects/SparkMySQL/out/artifacts/SparkMySQL_jar/SparkMySQL.jar</span><br></pre></td></tr></table></figure><p>成功后如下图</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/174.png" alt="1685356210586"></p><h1 id="十四、使用Spark-MLlib实现协同过滤算法"><a href="#十四、使用Spark-MLlib实现协同过滤算法" class="headerlink" title="十四、使用Spark MLlib实现协同过滤算法"></a>十四、使用Spark MLlib实现协同过滤算法</h1><h4 id="1-在spark-shell中运行ALS算法"><a href="#1-在spark-shell中运行ALS算法" class="headerlink" title="1.在spark-shell中运行ALS算法"></a>1.在spark-shell中运行ALS算法</h4><p>找到Saprk自带的MoveLens数据集</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/spark/data/mllib/als/sample_movielens_data.txt</span><br></pre></td></tr></table></figure><p>使用ALS.train()方法来构建</p><ul><li>引入包</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  org.apache.spark.ml.evaluation.<span class="type">RegressionEvaluator</span></span><br><span class="line"><span class="keyword">import</span>  org.apache.spark.ml.recommendation.<span class="type">ALS</span></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/175.png" alt="1685360157793"></p><ul><li>创建一个Rating类和parseRating函数。</li></ul><p>parseRating函数读取MovieLens数据集中的每一行，并转化成Rating类的对象</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span>  <span class="class"><span class="keyword">class</span>  <span class="title">Rating</span>(<span class="params">userId: <span class="type">Int</span>, movieId: <span class="type">Int</span>, rating: <span class="type">Float</span>, timestamp: <span class="type">Long</span></span>)</span></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/176.png" alt="1685360184128"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">parseRating</span></span>(str: <span class="type">String</span>): <span class="type">Rating</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span>  fields = str.split(<span class="string">&quot;::&quot;</span>)</span><br><span class="line">    assert(fields.size == <span class="number">4</span>)</span><br><span class="line">    <span class="type">Rating</span>(fields(<span class="number">0</span>).toInt, fields(<span class="number">1</span>).toInt, fields(<span class="number">2</span>).toFloat, fields(<span class="number">3</span>).toLong)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/177.png" alt="1685360292549"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  ratings = spark.sparkContext.textFile(<span class="string">&quot;file:///usr/local/spark/data/mllib/als/sample_movielens_ratings.txt&quot;</span>).map(parseRating).toDF()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/178.png" alt="1685360452458"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ratings.show()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/179.png" alt="1685360494208"></p><ul><li>把MovieLens数据集划分训练集和测试集，训练集80%，测试集20%</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  <span class="type">Array</span>(training,test) = ratings.randomSplit(<span class="type">Array</span>(<span class="number">0.8</span>,<span class="number">0.2</span>))</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/180.png" alt="1685360696050"></p><ul><li>使用ALS来建立推荐模型。</li></ul><p>这里构建两个模型，一个是显性反馈，另一个是隐性反馈。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  alsExplicit = <span class="keyword">new</span> <span class="type">ALS</span>().setMaxIter(<span class="number">5</span>).setRegParam(<span class="number">0.01</span>).setUserCol(<span class="string">&quot;userId&quot;</span>).setItemCol(<span class="string">&quot;movieId&quot;</span>).setRatingCol(<span class="string">&quot;rating&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/181.png" alt="1685360872033"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  alsImplicit = <span class="keyword">new</span> <span class="type">ALS</span>().setMaxIter(<span class="number">5</span>).setRegParam(<span class="number">0.01</span>).setImplicitPrefs(<span class="literal">true</span>).setUserCol(<span class="string">&quot;userId&quot;</span>).setItemCol(<span class="string">&quot;movieId&quot;</span>).setRatingCol(<span class="string">&quot;rating&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/182.png" alt="1685360920841"></p><ul><li>使用训练数据训练推荐模型</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  modelExplicit = alsExplicit.fit(training)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/183.png" alt="1685361134803"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  modelImplicit = alsImplicit.fit(training)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/184.png" alt="1685361165242"></p><ul><li>对测试集中的用户-电影进行预测，的到预测评分的数据集</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  predictionsExplicit= modelExplicit.transform(test).na.drop()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/185.png" alt="1685361468018"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  predictionsImplicit= modelImplicit.transform(test).na.drop()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/186.png" alt="1685361488969"></p><ul><li>输出，对比一下真实结果与预测结果</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predictionsExplicit.show()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/187.png" alt="1685361695118"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predictionsImplicit.show()</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/188.png" alt="1685361738211"></p><ul><li>通过计算模型的均方根误差，来对模型进行评估。均匀方根差越小，模型越准确</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  evaluator = <span class="keyword">new</span> <span class="type">RegressionEvaluator</span>().setMetricName(<span class="string">&quot;rmse&quot;</span>).setLabelCol(<span class="string">&quot;rating&quot;</span>).setPredictionCol(<span class="string">&quot;prediction&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/189.png" alt="1685361898480"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  rmseExplicit = evaluator.evaluate(predictionsExplicit)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/190.png" alt="1685361952024"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span>  rmseImplicit = evaluator.evaluate(predictionsImplicit)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/191.png" alt="1685361984946"></p><p>&#x2F;&#x2F;打出两个模型的均方根误差</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println(<span class="string">s&quot;Explicit:Root-mean-square error = <span class="subst">$rmseExplicit</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/192.png" alt="1685362065744"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println(<span class="string">s&quot;Implicit:Root-mean-square error = <span class="subst">$rmseImplicit</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/193.png" alt="1685362121407"></p><h4 id="2-编写独立应用程序运行ALS算法"><a href="#2-编写独立应用程序运行ALS算法" class="headerlink" title="2.编写独立应用程序运行ALS算法"></a>2.编写独立应用程序运行ALS算法</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/194.png" alt="1685366342990"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/195.png" alt="1685375243537"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/117.png" alt="1685271994038"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/118.png" alt="1685272015590"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/119.png" alt="1685272055139"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/120.png" alt="1685272092519"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/121.png" alt="1685272125104"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SparkSession</span></span><br><span class="line"><span class="keyword">import</span>  org.apache.spark.ml.evaluation.<span class="type">RegressionEvaluator</span></span><br><span class="line"><span class="keyword">import</span>  org.apache.spark.ml.recommendation.<span class="type">ALS</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MovieLensALS</span> </span>&#123;</span><br><span class="line">  <span class="keyword">case</span>  <span class="class"><span class="keyword">class</span>  <span class="title">Rating</span>(<span class="params">userId: <span class="type">Int</span>, movieId: <span class="type">Int</span>, rating: <span class="type">Float</span>, timestamp: <span class="type">Long</span></span>)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">def</span>  <span class="title">parseRating</span></span>(str: <span class="type">String</span>): <span class="type">Rating</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span>  fields = str.split(<span class="string">&quot;::&quot;</span>)</span><br><span class="line">    <span class="type">Rating</span>(fields(<span class="number">0</span>).toInt, fields(<span class="number">1</span>).toInt, fields(<span class="number">2</span>).toFloat, fields(<span class="number">3</span>).toLong)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> spark=<span class="type">SparkSession</span>.builder().appName(<span class="string">&quot;sparkmllibtest&quot;</span>).master(<span class="string">&quot;local[2]&quot;</span>).getOrCreate()</span><br><span class="line">      <span class="keyword">import</span> spark.implicits._</span><br><span class="line">      <span class="keyword">val</span>  ratings = spark.sparkContext.textFile(<span class="string">&quot;file:///usr/local/spark/data/mllib/als/sample_movielens_ratings.txt&quot;</span>).</span><br><span class="line">         map(parseRating).toDF()</span><br><span class="line">          ratings.show()</span><br><span class="line">      <span class="keyword">val</span>  <span class="type">Array</span>(training,test) = ratings.randomSplit(<span class="type">Array</span>(<span class="number">0.8</span>,<span class="number">0.2</span>))</span><br><span class="line">      <span class="keyword">val</span>  alsExplicit = <span class="keyword">new</span> <span class="type">ALS</span>().setMaxIter(<span class="number">5</span>).setRegParam(<span class="number">0.01</span>).setUserCol(<span class="string">&quot;userId&quot;</span>).setItemCol(<span class="string">&quot;movieId&quot;</span>).setRatingCol(<span class="string">&quot;rating&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span>  alsImplicit = <span class="keyword">new</span> <span class="type">ALS</span>().setMaxIter(<span class="number">5</span>).setRegParam(<span class="number">0.01</span>).setImplicitPrefs(<span class="literal">true</span>).setUserCol(<span class="string">&quot;userId&quot;</span>).setItemCol(<span class="string">&quot;movieId&quot;</span>).setRatingCol(<span class="string">&quot;rating&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span>  modelExplicit = alsExplicit.fit(training)</span><br><span class="line">      <span class="keyword">val</span>  modelImplicit = alsImplicit.fit(training)</span><br><span class="line">      <span class="keyword">val</span>  predictionsExplicit= modelExplicit.transform(test).na.drop()</span><br><span class="line">      <span class="keyword">val</span>  predictionsImplicit= modelImplicit.transform(test).na.drop()</span><br><span class="line">      predictionsExplicit.show()</span><br><span class="line">      predictionsImplicit.show()</span><br><span class="line">      <span class="keyword">val</span>  evaluator = <span class="keyword">new</span> <span class="type">RegressionEvaluator</span>().setMetricName(<span class="string">&quot;rmse&quot;</span>).setLabelCol(<span class="string">&quot;rating&quot;</span>).setPredictionCol(<span class="string">&quot;prediction&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span>  rmseExplicit = evaluator.evaluate(predictionsExplicit)</span><br><span class="line">      <span class="keyword">val</span>  rmseImplicit = evaluator.evaluate(predictionsImplicit)</span><br><span class="line">      println(<span class="string">s&quot;Explicit:Root-mean-square error = <span class="subst">$rmseExplicit</span>&quot;</span>)</span><br><span class="line">      println(<span class="string">s&quot;Implicit:Root-mean-square error = <span class="subst">$rmseImplicit</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/196.png" alt="1685375773432"></p><p>然后搞pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dblab<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SparkALS<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-sql_2.11 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-mllib_2.11 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-mllib_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-core_2.11 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>2.11.8<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>自己参照前面的把maven运行一下</p><p>然后</p><p>run那个class文件</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/197+.png" alt="1685376988299"></p><p>成功！</p><p>导出jar文件，参考上面的</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/198.png" alt="1685377096140"></p><p>把jar提交到spark中运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark</span><br><span class="line">./bin/spark-submit --class &quot;MovieLensALS&quot; ~/IdeaProjects/SparkALS/out/artifacts/SparkALS_jar/SparkALS.jar</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/199.png" alt="1685377694946"></p><p>搞定！</p><h1 id="十五、Node-js的安装和使用方法"><a href="#十五、Node-js的安装和使用方法" class="headerlink" title="十五、Node.js的安装和使用方法"></a>十五、Node.js的安装和使用方法</h1><h5 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Downloads</span><br><span class="line">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.33.8/install.sh | bash</span><br></pre></td></tr></table></figure><p>这边需要配置一下host 因为某些不可抗拒因素</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to connect to raw.githubusercontent.com port 443</span><br></pre></td></tr></table></figure><p><strong>查询真实IP</strong></p><p>在<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.ipaddress.com/">https://www.ipaddress.com/</a>查询raw.githubusercontent.com的真实IP。</p><p><strong>修改hosts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts</span><br></pre></td></tr></table></figure><p>添加如下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">199.232</span>.<span class="number">96.133</span> raw<span class="selector-class">.githubusercontent</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上面curl的下载完成后</span><br><span class="line">sudo  vim ~/.bashrc</span><br></pre></td></tr></table></figure><p>把下面的写进去</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=&quot;$HOME/.nvm&quot;</span><br><span class="line">[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>然后下一步</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvm install --lts</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure><p>会出现这个，因为Ubuntu命令太古老了</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/200.png" alt="1685443698497"></p><p>所以另辟蹊径</p><p>nvm install v12.22.6</p><p>nvm use v12.22.6</p><p>node -v</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/201.png" alt="1685443838168"></p><h4 id="2-应用"><a href="#2-应用" class="headerlink" title="2.应用"></a>2.应用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir mynodeapp</span><br><span class="line">cd mynodeapp</span><br><span class="line">vim server.js</span><br></pre></td></tr></table></figure><p>输入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">request,response</span>)&#123;</span><br><span class="line">response.<span class="title function_">writeHead</span>(<span class="number">200</span>,&#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/plain&#x27;</span>&#125;);</span><br><span class="line">response.<span class="title function_">end</span>(<span class="string">&#x27;Hello World\n&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running at http://127.0.0.1:3000/&#x27;</span>);</span><br></pre></td></tr></table></figure><p>保存之后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/202.png" alt="1685444371625"></p><h4 id="3-安装express和Jade"><a href="#3-安装express和Jade" class="headerlink" title="3.安装express和Jade"></a>3.安装express和Jade</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir expressjadeapp</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd expressjadeapp</span><br><span class="line">npm init</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd expressjadeapp</span><br><span class="line">npm install express --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd expressjadeapp</span><br><span class="line">npm install jade --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim expressjade.js</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 Pug（Jade）作为模板引擎</span></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, __dirname);</span><br><span class="line"><span class="comment">// 定义路由和处理程序</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;test&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;Jade test&#x27;</span>,<span class="attr">message</span>:<span class="string">&#x27;Database Lab&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> servser=http.<span class="title function_">createServer</span>(app);</span><br><span class="line">servser.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running at http://127.0.0.1:3000/&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim test.jade</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">	head</span><br><span class="line">		tittle!=tittle</span><br><span class="line">	body</span><br><span class="line">		h1!=message</span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node expressjade.js</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/203.png" alt="1685446545268"></p><h4 id="实例1-登陆注册"><a href="#实例1-登陆注册" class="headerlink" title="实例1 登陆注册"></a>实例1 登陆注册</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database userlogin;</span><br><span class="line">use userlogin;</span><br><span class="line">create table user (userid int(20) not null auto_increment,username char(50),password char(50),primary key(userid));</span><br><span class="line">desc user;</span><br><span class="line">select * from user;</span><br></pre></td></tr></table></figure><p>创建项目目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir userloginapp</span><br><span class="line">cd userloginapp</span><br><span class="line">npm init</span><br></pre></td></tr></table></figure><p>要apt install npm</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install express -save</span><br><span class="line">npm install jade --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mysql --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim userlogin.js</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by linziyu on 2018/7/3.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sexpress接收html传递的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span>  express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span>  app=<span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">var</span> mysql=<span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置MySQL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> connection = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">    host     : <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    user     : <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    password : <span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    database : <span class="string">&#x27;userlogin&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>:<span class="string">&#x27;3306&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">connection.<span class="title function_">connect</span>();</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendfile</span>(__dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;index.html&quot;</span> );</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现登录验证功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span>  name=req.<span class="property">query</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="keyword">var</span> pwd=req.<span class="property">query</span>.<span class="property">pwd</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> selectSQL = <span class="string">&quot;select * from user where username = &#x27;&quot;</span>+name+<span class="string">&quot;&#x27; and password = &#x27;&quot;</span>+pwd+<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">    connection.<span class="title function_">query</span>(selectSQL,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(rs);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;OK&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">sendfile</span>(__dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;ok.html&quot;</span> );</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/register.html&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendfile</span>(__dirname+<span class="string">&quot;/&quot;</span>+<span class="string">&quot;register.html&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现注册功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/register&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span>  name=req.<span class="property">query</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="keyword">var</span>  pwd=req.<span class="property">query</span>.<span class="property">pwd</span>;</span><br><span class="line">    <span class="keyword">var</span>  user=&#123;<span class="attr">username</span>:name,<span class="attr">password</span>:pwd&#125;;</span><br><span class="line">    connection.<span class="title function_">query</span>(<span class="string">&#x27;insert into user set ?&#x27;</span>,user,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">sendfile</span>(__dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;index.html&quot;</span> );</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span>  server=app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;userlogin server starts......&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim index.html</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>用户登录</span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>  <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1:3000/login&quot;</span>&gt;</span></span><br><span class="line">                User Name:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">                Password:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;register.html&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim register.html</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>用户注册</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>  <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1:3000/register&quot;</span>&gt;</span></span><br><span class="line">   User Name:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">    Password:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ok.html</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">login success!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node userlogin.js</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/206.png" alt="1685448718411"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/205.png" alt="1685448694065"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/204.png" alt="1685448654349"></p><h4 id="实例2-用jade实现"><a href="#实例2-用jade实现" class="headerlink" title="实例2 用jade实现"></a>实例2 用jade实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir userloginjadeapp</span><br><span class="line">cd userloginjadeapp</span><br><span class="line">npm init</span><br><span class="line">npm install express -save</span><br><span class="line">npm install jade --save</span><br><span class="line">npm install mysql --save</span><br><span class="line">npm install body-parser --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim userloginjade.js</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Created by linziyu on 2018/7/3.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * express接收html传递的参数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">   <span class="keyword">var</span>  express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line">   <span class="keyword">var</span>  bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line">   <span class="keyword">var</span>  app=<span class="title function_">express</span>();</span><br><span class="line">   <span class="keyword">var</span> mysql=<span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line">   app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>); </span><br><span class="line">   app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, __dirname);</span><br><span class="line">   app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">   app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置MySQL</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">var</span> connection = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">       host     : <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">       user     : <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">       password : <span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">       database : <span class="string">&#x27;movierecommend&#x27;</span>,</span><br><span class="line">       <span class="attr">port</span>:<span class="string">&#x27;3306&#x27;</span></span><br><span class="line">   &#125;);</span><br><span class="line">   connection.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 跳转到网站首页，也就是用户登录页面</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">       res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">   &#125;)</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 实现登录验证功能</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">       <span class="keyword">var</span>  name=req.<span class="property">body</span>.<span class="property">username</span>.<span class="title function_">trim</span>();</span><br><span class="line">       <span class="keyword">var</span> pwd=req.<span class="property">body</span>.<span class="property">pwd</span>.<span class="title function_">trim</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;username:&#x27;</span>+name+<span class="string">&#x27;password:&#x27;</span>+pwd);</span><br><span class="line">    </span><br><span class="line">       <span class="keyword">var</span> selectSQL = <span class="string">&quot;select * from user where username = &#x27;&quot;</span>+name+<span class="string">&quot;&#x27; and password = &#x27;&quot;</span>+pwd+<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">       connection.<span class="title function_">query</span>(selectSQL,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(rs);</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>);</span><br><span class="line">           res.<span class="title function_">render</span>(<span class="string">&#x27;ok&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;Welcome User&#x27;</span>,<span class="attr">message</span>:name&#125;);</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 跳转到注册页面</span></span><br><span class="line"><span class="comment">    */</span>     </span><br><span class="line">   app.<span class="title function_">get</span>(<span class="string">&#x27;/registerpage&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">     res.<span class="title function_">render</span>(<span class="string">&#x27;registerpage&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;注册&#x27;</span>&#125;);</span><br><span class="line">   &#125;)</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 实现注册功能</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">       <span class="keyword">var</span>  name=req.<span class="property">body</span>.<span class="property">username</span>.<span class="title function_">trim</span>();</span><br><span class="line">       <span class="keyword">var</span>  pwd=req.<span class="property">body</span>.<span class="property">pwd</span>.<span class="title function_">trim</span>();</span><br><span class="line">       <span class="keyword">var</span>  user=&#123;<span class="attr">username</span>:name,<span class="attr">password</span>:pwd&#125;;</span><br><span class="line">       connection.<span class="title function_">query</span>(<span class="string">&#x27;insert into user set ?&#x27;</span>,user,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>);</span><br><span class="line">          res.<span class="title function_">render</span>(<span class="string">&#x27;ok&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;Welcome User&#x27;</span>,<span class="attr">message</span>:name&#125;);</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   <span class="keyword">var</span>  server=app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;userloginjade server start......&quot;</span>);</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim index.jade</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">      </span><br><span class="line">    form(action=&#x27;/login&#x27;, method=&#x27;post&#x27;)</span><br><span class="line"></span><br><span class="line">      p 用户登录</span><br><span class="line">      input(type=&#x27;text&#x27;,name=&#x27;username&#x27;)</span><br><span class="line">      input(type=&#x27;text&#x27;,name=&#x27;pwd&#x27;)</span><br><span class="line">      input(type=&#x27;submit&#x27;,value=&#x27;登录&#x27;)</span><br><span class="line">      br</span><br><span class="line">    a(href=&#x27;/registerpage&#x27;, title=&#x27;注册&#x27;) 注册</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim registerpage.jade</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line"></span><br><span class="line">    form(action=&#x27;/register&#x27;, method=&#x27;post&#x27;)</span><br><span class="line"></span><br><span class="line">      p 用户注册</span><br><span class="line">      input(type=&#x27;text&#x27;,name=&#x27;username&#x27;)</span><br><span class="line">      input(type=&#x27;text&#x27;,name=&#x27;pwd&#x27;)</span><br><span class="line">      input(type=&#x27;submit&#x27;,value=&#x27;注册&#x27;)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ok.jade</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1 热烈欢迎用户: #&#123;message&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先去mysql里面创建一个movierecommend数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database movierecommend;</span><br><span class="line">use movierecommend;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span> (userid <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,username <span class="type">char</span>(<span class="number">50</span>),password <span class="type">char</span>(<span class="number">50</span>),<span class="keyword">primary</span> key(userid));</span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p>然后再</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node userloginjade.js  </span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/207.png" alt="1685449367685"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/208.png" alt="1685449532848"></p><h4 id="通过网页调用词频统计程序"><a href="#通过网页调用词频统计程序" class="headerlink" title="通过网页调用词频统计程序"></a>通过网页调用词频统计程序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir myapp</span><br><span class="line">cd myapp</span><br><span class="line">npm init</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~/myapp</span><br><span class="line">npm install express -save</span><br><span class="line">npm install jade --save</span><br><span class="line">npm install body-parser --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim index.js</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义路由和处理程序</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> servser=app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> host=servser.<span class="title function_">address</span>().<span class="property">address</span>;</span><br><span class="line">    <span class="keyword">const</span> port=servser.<span class="title function_">address</span>().<span class="property">port</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Listening at http://%:%&#x27;</span>,host,port);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/209.png" alt="1685450260367"></p><p><code>vim index.jade</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">	head</span><br><span class="line">		tittle!=tittle</span><br><span class="line">	body</span><br><span class="line">		h1!=message</span><br></pre></td></tr></table></figure><p>再次修改index.js文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> exec = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">exec</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置模板引擎</span></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>,<span class="string">&#x27;./views&#x27;</span>)</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>)</span><br><span class="line"><span class="comment">// 添加body-parser解析post过来的数据</span></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WordCount测试&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室!&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> path = req.<span class="property">body</span>.<span class="property">path</span>.<span class="title function_">trim</span>()</span><br><span class="line">  <span class="keyword">const</span> jarStr = <span class="string">&#x27;/usr/local/spark/bin/spark-submit --class WordCount ~/IdeaProjects/WordCount/out/artifacts/WordCount_jar/WordCount.jar &#x27;</span>+path+<span class="string">&#x27; /output&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> rmrStr = <span class="string">&#x27;/usr/local/hadoop/bin/hdfs dfs -rmr /output&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> catStr = <span class="string">&#x27;/usr/local/hadoop/bin/hdfs dfs -cat /output/*&#x27;</span></span><br><span class="line">  <span class="title function_">exec</span>(rmrStr,<span class="keyword">function</span>(<span class="params">err, stdout, stderr</span>)&#123;</span><br><span class="line">    <span class="title function_">exec</span>(jarStr, <span class="keyword">function</span>(<span class="params">err, stdout, stderr</span>)&#123;</span><br><span class="line">      <span class="comment">// 判断路径是否存在,如果路径不存在，则显示错误信息</span></span><br><span class="line">      <span class="keyword">if</span>(stderr)&#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WordCount测试&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室!&#x27;</span>, <span class="attr">result</span>: stderr&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//执行成功后，显示统计结果。</span></span><br><span class="line">      <span class="title function_">exec</span>(catStr,<span class="keyword">function</span>(<span class="params">err, stdout, stderr</span>)&#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WordCount测试&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室!&#x27;</span>, <span class="attr">result</span>: stdout&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> host = server.<span class="title function_">address</span>().<span class="property">address</span>;</span><br><span class="line">  <span class="keyword">const</span> port = server.<span class="title function_">address</span>().<span class="property">port</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Example app listening at http://%s:%s&#x27;</span>, host, port);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再改index.jade,并且创建一个views的目录把index.jade移动进去</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir views</span><br><span class="line">mv index.jade ~/myapp/views</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1!= message  </span><br><span class="line">    form(action=&#x27;/&#x27;, method=&#x27;post&#x27;)</span><br><span class="line">      p 请在下面输入所需要进行词频统计文件的路径</span><br><span class="line">      p HDFS文件路径示例：hdfs://localhost:9000/user/hadoop/word.txt</span><br><span class="line">      p 本地文件路径示例：file:///home/hadoop/word.txt</span><br><span class="line">      br</span><br><span class="line">      input(name=&#x27;path&#x27;)</span><br><span class="line">      input(type=&#x27;submit&#x27;)</span><br><span class="line">      br</span><br><span class="line">      textarea(rows=&#x27;40&#x27;, cols=&#x27;40&#x27;)!=result</span><br></pre></td></tr></table></figure><p>搞完之后开启hadoop，hdfs，然后修改WirdCount.jar的内容</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkContext</span>._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> inputFile = args(<span class="number">0</span>)  <span class="comment">//第1个参数是输入文件路径</span></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WordCount&quot;</span>).setMaster(<span class="string">&quot;local&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">    <span class="keyword">val</span> textFile = sc.textFile(inputFile)</span><br><span class="line">    <span class="keyword">val</span> wordCount = textFile.flatMap(line =&gt; line.split(<span class="string">&quot; &quot;</span>)).map(word =&gt; (word, <span class="number">1</span>)).reduceByKey((a, b) =&gt; a + b)</span><br><span class="line">wordCount.foreach(println)</span><br><span class="line">wordCount.saveAsTextFile(args(<span class="number">1</span>))  <span class="comment">//第2个参数是输出文件路径</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/myapp</span><br><span class="line">node index.js</span><br></pre></td></tr></table></figure><p>这边建议修改一下index.js代码，因为报错包括WARN，所以很难没错</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> exec = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">exec</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置模板引擎</span></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>,<span class="string">&#x27;./views&#x27;</span>)</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>)</span><br><span class="line"><span class="comment">// 添加body-parser解析post过来的数据</span></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WordCount测试&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室!&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> path = req.<span class="property">body</span>.<span class="property">path</span>.<span class="title function_">trim</span>()</span><br><span class="line">  <span class="keyword">const</span> jarStr = <span class="string">&#x27;/usr/local/spark/bin/spark-submit --class WordCount ~/IdeaProjects/WordCount/out/artifacts/WordCount_jar/WordCount.jar &#x27;</span>+path+<span class="string">&#x27; /output&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> rmrStr = <span class="string">&#x27;/usr/local/hadoop/bin/hdfs dfs -rmr /output&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> catStr = <span class="string">&#x27;/usr/local/hadoop/bin/hdfs dfs -cat /output/*&#x27;</span></span><br><span class="line">  <span class="title function_">exec</span>(rmrStr,<span class="keyword">function</span>(<span class="params">err, stdout, stderr</span>)&#123;</span><br><span class="line">    <span class="title function_">exec</span>(jarStr, <span class="keyword">function</span>(<span class="params">err, stdout</span>)&#123;</span><br><span class="line">      <span class="comment">// 判断路径是否存在,如果路径不存在，则显示错误信息</span></span><br><span class="line">      <span class="comment">//执行成功后，显示统计结果。</span></span><br><span class="line">      <span class="title function_">exec</span>(catStr,<span class="keyword">function</span>(<span class="params">err, stdout, stderr</span>)&#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WordCount测试&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室!&#x27;</span>, <span class="attr">result</span>: stdout&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> host = server.<span class="title function_">address</span>().<span class="property">address</span>;</span><br><span class="line">  <span class="keyword">const</span> port = server.<span class="title function_">address</span>().<span class="property">port</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Example app listening at http://%s:%s&#x27;</span>, host, port);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/210.png" alt="1685452159233"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/211.png" alt="1685463559272"></p><p>这个是测试spark和hdfs连通问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val data = Seq(&quot;Hello&quot;, &quot;World&quot;, &quot;Spark&quot;, &quot;HDFS&quot;)</span><br><span class="line">val rdd = spark.sparkContext.parallelize(data)</span><br><span class="line">rdd.saveAsTextFile(&quot;hdfs://localhost:9000/usr/hadoop/my.txt&quot;)</span><br><span class="line">val rdd = spark.sparkContext.textFile(&quot;hdfs://localhost:9000/usr/hadoop/my.txt&quot;)</span><br><span class="line">rdd.foreach(println)</span><br><span class="line">有输出就是联通的</span><br></pre></td></tr></table></figure><p>解决一个warn警告</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“WARN util.NativeCodeLoader: Unable to load native-hadoop library for your platform” warning</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">配置一下</span><br><span class="line">HADOOP_HOME</span><br><span class="line">检测命令</span><br><span class="line">echo $HADOOP_HOME</span><br></pre></td></tr></table></figure><h1 id="十六、电影推荐系统（基础版）实现过程"><a href="#十六、电影推荐系统（基础版）实现过程" class="headerlink" title="十六、电影推荐系统（基础版）实现过程"></a>十六、电影推荐系统（基础版）实现过程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Downloads</span><br><span class="line">sudo unzip movie_recommend.zip</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/212.png" alt="1685464042286"></p><h4 id="1-清洗数据"><a href="#1-清洗数据" class="headerlink" title="1.清洗数据"></a>1.清洗数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop</span><br><span class="line">./sbin/start-dfs.sh#启动</span><br><span class="line">#建立一个数据集HDFS目录input_spark</span><br><span class="line">hdfs dfs -mkdir /input_spark</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/213.png" alt="1685464195081"></p><p>把下面俩个导入进hdfs里面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file:///home/hadoop/Downloads/movie_recommend/personalRatings.dat </span><br><span class="line">file:///home/hadoop/Downloads/movie_recommend/ratings.dat</span><br></pre></td></tr></table></figure><p>对movie.dat清洗</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/214.png" alt="1685466452270"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/215.png" alt="1685466504655"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/216.png" alt="1685466561456"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/217.png" alt="1685466642348"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/218.png" alt="1685466699402"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/219.png" alt="1685466790159"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/245.png" alt="1685498131672"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/246.png" alt="1685498172429"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/220.png" alt="1685466822014"></p><p>提娜佳剪切字符串控件</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/221.png" alt="1685491556477"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/222.png" alt="1685491610432"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/223.png" alt="1685491657365"></p><p>我打错了应该是dat</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/226.png" alt="1685491922035"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/227.png" alt="1685492017446"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/228.png" alt="1685492061793"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/229.png" alt="1685492351484"></p><p>good game</p><p>查看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -cat /input_spark/movies.dat | head -5</span><br></pre></td></tr></table></figure><p>乱码也不知道为什么，因为后面不用清洗过的呵呵呵</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/230.png" alt="1685492776500"></p><h4 id="2-编写Spark程序"><a href="#2-编写Spark程序" class="headerlink" title="2.编写Spark程序"></a>2.编写Spark程序</h4><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/160.png" alt="1685353875195"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/161.png" alt="1685353929474"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/231.png" alt="1685493647131"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/164.png" alt="1685354118424"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/165.png" alt="1685354165755"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/166.png" alt="1685354350410"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/167.png" alt="1685354421083"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/233.png" alt="1685494006879"></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> recommend</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.<span class="type">File</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.&#123;<span class="type">Level</span>, <span class="type">Logger</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.recommendation.&#123;<span class="type">ALS</span>, <span class="type">ALSModel</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.&#123;<span class="type">DataFrame</span>, <span class="type">Row</span>, <span class="type">SparkSession</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.io.<span class="type">Source</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MovieLensALS</span> </span>&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Rating</span>(<span class="params">user : <span class="type">Int</span>, product : <span class="type">Int</span>, rating : <span class="type">Double</span></span>)</span></span><br><span class="line">  <span class="keyword">val</span> spark=<span class="type">SparkSession</span>.builder().appName(<span class="string">&quot;MovieLensALS&quot;</span>).master(<span class="string">&quot;local[2]&quot;</span>).getOrCreate()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="comment">// 屏蔽不必要的日志显示在终端上</span></span><br><span class="line">    <span class="type">Logger</span>.getLogger(<span class="string">&quot;org.apache.spark&quot;</span>).setLevel(<span class="type">Level</span>.<span class="type">ERROR</span>)</span><br><span class="line">    <span class="type">Logger</span>.getLogger(<span class="string">&quot;org.eclipse.jetty.server&quot;</span>).setLevel(<span class="type">Level</span>.<span class="type">OFF</span>)</span><br><span class="line">    <span class="keyword">if</span> (args.length != <span class="number">5</span>) &#123;</span><br><span class="line">      println(<span class="string">&quot;Usage: /usr/local/spark/bin/spark-submit --class recommend.MovieLensALS &quot;</span> +</span><br><span class="line">        <span class="string">&quot;Spark_Recommend_Dataframe.jar movieLensHomeDir personalRatingsFile bestRank bestLambda bestNumiter&quot;</span>)</span><br><span class="line">      sys.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置运行环境</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 装载参数二,即用户评分,该评分由评分器生成</span></span><br><span class="line">    <span class="keyword">val</span> myRatings = loadRatings(args(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">val</span> myRatingsRDD = spark.sparkContext.parallelize(myRatings, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// 样本数据目录</span></span><br><span class="line">    <span class="keyword">val</span> movieLensHomeDir = args(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 装载样本评分数据,其中最后一列 Timestamp 取除 10 的余数作为 key,Rating 为值,即(Int,Rating)</span></span><br><span class="line">    <span class="comment">//ratings.dat 原始数据:用户编号、电影编号、评分、评分时间戳</span></span><br><span class="line">    <span class="keyword">val</span> ratings = spark.sparkContext.textFile(<span class="keyword">new</span> <span class="type">File</span>(movieLensHomeDir,</span><br><span class="line">      <span class="string">&quot;ratings.dat&quot;</span>).toString).map &#123; line =&gt;</span><br><span class="line">      <span class="keyword">val</span> fields = line.split(<span class="string">&quot;::&quot;</span>)</span><br><span class="line">      (fields(<span class="number">3</span>).toLong % <span class="number">10</span>, <span class="type">Rating</span>(fields(<span class="number">0</span>).toInt, fields(<span class="number">1</span>).toInt,</span><br><span class="line">        fields(<span class="number">2</span>).toDouble))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//装载电影目录对照表(电影 ID-&gt;电影标题)</span></span><br><span class="line">    <span class="comment">//movies.dat 原始数据:电影编号、电影名称、电影类别</span></span><br><span class="line">    <span class="keyword">val</span> movies = spark.sparkContext.textFile(<span class="keyword">new</span> <span class="type">File</span>(movieLensHomeDir,</span><br><span class="line">      <span class="string">&quot;movies.dat&quot;</span>).toString).map &#123; line =&gt;</span><br><span class="line">      <span class="keyword">val</span> fields = line.split(<span class="string">&quot;::&quot;</span>)</span><br><span class="line">      (fields(<span class="number">0</span>).toInt, fields(<span class="number">1</span>).toString())</span><br><span class="line">    &#125;.collect().toMap</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> numRatings = ratings.count()</span><br><span class="line">    <span class="keyword">val</span> numUsers = ratings.map(_._2.user).distinct().count()</span><br><span class="line">    <span class="keyword">val</span> numMovies = ratings.map(_._2.product).distinct().count()</span><br><span class="line">    <span class="comment">// 将样本评分表以 key 值切分成 3 个部分,分别用于训练 (60%,并加入用户评分), 校验 (20%), and 测试 (20%)</span></span><br><span class="line">    <span class="comment">// 该数据在计算过程中要多次应用到,所以 cache 到内存</span></span><br><span class="line">    <span class="keyword">val</span> numPartitions = <span class="number">4</span></span><br><span class="line">    <span class="comment">// training 训练样本数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> trainingDF = ratings.filter(x =&gt; x._1 &lt; <span class="number">6</span>) <span class="comment">//取评分时间除 10 的余数后值小于 6 的作为训练样本</span></span><br><span class="line">      .values</span><br><span class="line">      .union(myRatingsRDD) <span class="comment">//注意 ratings 是(Int,Rating),取 value 即可</span></span><br><span class="line">      .toDF()</span><br><span class="line">      .repartition(numPartitions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation 校验样本数据</span></span><br><span class="line">    <span class="keyword">val</span> validationDF = ratings.filter(x =&gt; x._1 &gt;= <span class="number">6</span> &amp;&amp; x._1 &lt; <span class="number">8</span>) <span class="comment">//取评分时间除 10 的余数后值大于等于 6 且小于 8 分的作为校验样本</span></span><br><span class="line">      .values</span><br><span class="line">      .toDF()</span><br><span class="line">      .repartition(numPartitions)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test 测试样本数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> testDF = ratings.filter(x =&gt; x._1 &gt;= <span class="number">8</span>).values.toDF() <span class="comment">//取评分时间除 10 的余数后值大于等于 8 分的作为测试样本</span></span><br><span class="line">    <span class="keyword">val</span> numTraining = trainingDF.count()</span><br><span class="line">    <span class="keyword">val</span> numValidation = validationDF.count()</span><br><span class="line">    <span class="keyword">val</span> numTest = testDF.count()</span><br><span class="line">    <span class="comment">// 训练不同参数下的模型,并在校验集中验证,获取最佳参数下的模型</span></span><br><span class="line">    <span class="keyword">val</span> ranks = <span class="type">List</span>(<span class="number">8</span>, <span class="number">12</span>) <span class="comment">//模型中隐语义因子的个数</span></span><br><span class="line">    <span class="keyword">val</span> lambdas = <span class="type">List</span>(<span class="number">0.1</span>, <span class="number">10.0</span>) <span class="comment">//是 ALS 的正则化参数</span></span><br><span class="line">    <span class="keyword">val</span> numIters = <span class="type">List</span>(<span class="number">10</span>, <span class="number">20</span>) <span class="comment">//迭代次数</span></span><br><span class="line">    <span class="keyword">var</span> bestModel: <span class="type">Option</span>[<span class="type">ALSModel</span>] = <span class="type">None</span> <span class="comment">//最好的模型</span></span><br><span class="line">    <span class="keyword">var</span> bestValidationRmse = <span class="type">Double</span>.<span class="type">MaxValue</span> <span class="comment">//最好的校验均方根误差</span></span><br><span class="line">    <span class="keyword">var</span> bestRank = args(<span class="number">2</span>).toInt <span class="comment">//最好的隐语义因子的个数</span></span><br><span class="line">    <span class="keyword">var</span> bestLambda = args(<span class="number">3</span>).toDouble  <span class="comment">//最好的ALS正则化参数</span></span><br><span class="line">    <span class="keyword">var</span> bestNumIter = args(<span class="number">4</span>).toInt  <span class="comment">//最好的迭代次数</span></span><br><span class="line">    <span class="comment">//val model = ALS.train(training, bestRank, bestNumIter, bestLambda) //如果是从外部传入参数，则使用该语句训练模型</span></span><br><span class="line">    <span class="comment">//如果不使用外部传入的参数，而是使用上面定义的ranks、lambdas和numIters的列表值进行模型训练，则使用下面的for循环语句训练模型</span></span><br><span class="line">    <span class="keyword">for</span> (rank &lt;- ranks; lambda &lt;- lambdas; numIter &lt;- numIters) &#123;</span><br><span class="line">      <span class="keyword">val</span> als = <span class="keyword">new</span> <span class="type">ALS</span>().setMaxIter(numIter).setRank(rank).setRegParam(lambda).setUserCol(<span class="string">&quot;user&quot;</span>).setItemCol(<span class="string">&quot;product&quot;</span>).setRatingCol(<span class="string">&quot;rating&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> model = als.fit(trainingDF)<span class="comment">//训练样本、隐语义因子的个数、迭代次数、ALS 的正则化参数</span></span><br><span class="line">      <span class="comment">// model 训练模型</span></span><br><span class="line">      <span class="comment">//输入训练模型、校验样本、校验个数</span></span><br><span class="line">      <span class="keyword">val</span> validationRmse = computeRmse(model, validationDF, numValidation) <span class="comment">// 校验模型结果</span></span><br><span class="line">      <span class="keyword">if</span> (validationRmse &lt; bestValidationRmse) &#123;</span><br><span class="line">        bestModel = <span class="type">Some</span>(model)</span><br><span class="line">        bestValidationRmse = validationRmse</span><br><span class="line">        bestRank = rank</span><br><span class="line">        bestLambda = lambda</span><br><span class="line">        bestNumIter = numIter</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用最佳模型预测测试集的评分,并计算和实际评分之间的均方根误差</span></span><br><span class="line">    <span class="keyword">val</span> testRmse = computeRmse(bestModel.get, testDF, numTest)</span><br><span class="line">    <span class="comment">//创建一个基准(Naïve Baseline),并把它和最好的模型进行比较</span></span><br><span class="line">    <span class="keyword">val</span> meanRating = trainingDF.union(validationDF).select(<span class="string">&quot;rating&quot;</span>).rdd.map&#123;<span class="keyword">case</span> <span class="type">Row</span>(v : <span class="type">Double</span>) =&gt; v&#125;.mean</span><br><span class="line">    <span class="keyword">val</span> baselineRmse = math.sqrt(testDF.select(<span class="string">&quot;rating&quot;</span>).rdd.map&#123;<span class="keyword">case</span> <span class="type">Row</span>(v : <span class="type">Double</span>) =&gt; v&#125;.map(x =&gt; (meanRating - x) * (meanRating - x)).mean)</span><br><span class="line">    <span class="comment">//改进了基准的最佳模型</span></span><br><span class="line">    <span class="keyword">val</span> improvement = (baselineRmse - testRmse) / baselineRmse * <span class="number">100</span></span><br><span class="line">    <span class="comment">// 推荐前十部最感兴趣的电影,注意要剔除用户已经评分的电影</span></span><br><span class="line">    <span class="keyword">val</span> myRatedMovieIds = myRatings.map(_.product).toSet</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> candidates = spark.sparkContext.parallelize(movies.keys.filter(!myRatedMovieIds.contains(_)).toSeq).map(<span class="type">Rating</span>(<span class="number">1</span>,_,<span class="number">0.0</span>))</span><br><span class="line">      .toDF().select(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;product&quot;</span>)</span><br><span class="line">    <span class="comment">//上面的Rating(1,_,0.0)中，1表示用户的userid，0.0是赋予的初始评分值，如果为userid为2的用户预测评分值，则需要修改为Rating(2,_,0.0)</span></span><br><span class="line">    <span class="keyword">val</span> recommendations = bestModel.get</span><br><span class="line">      .transform(candidates).select(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;product&quot;</span>,<span class="string">&quot;prediction&quot;</span>).rdd</span><br><span class="line">      .map(x =&gt; <span class="type">Rating</span>(x(<span class="number">0</span>).toString.toInt,x(<span class="number">1</span>).toString.toInt,x(<span class="number">2</span>).toString.toDouble))</span><br><span class="line">      .sortBy(-_.rating)</span><br><span class="line">      .take(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">1</span></span><br><span class="line">    println(<span class="string">&quot;Movies recommended for you(用户 ID:推荐电影 ID:推荐分数:推荐电影名称):&quot;</span>)</span><br><span class="line">    recommendations.foreach &#123; r =&gt;</span><br><span class="line">      println(r.user + <span class="string">&quot;:&quot;</span> + r.product + <span class="string">&quot;:&quot;</span> + r.rating + <span class="string">&quot;:&quot;</span> + movies(r.product))</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    spark.sparkContext.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 校验集预测数据和实际数据之间的均方根误差 **/</span></span><br><span class="line">  <span class="comment">//输入训练模型、校验样本、校验个数</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">computeRmse</span></span>(model: <span class="type">ALSModel</span>, df: <span class="type">DataFrame</span>, n: <span class="type">Long</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line">    <span class="keyword">val</span> predictions = model.transform(df.select(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;product&quot;</span>)) <span class="comment">//调用预测的函数</span></span><br><span class="line">    <span class="comment">// 输出 predictionsAndRatings 预测和评分</span></span><br><span class="line">    <span class="keyword">val</span> predictionsAndRatings = predictions.select(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;product&quot;</span>,<span class="string">&quot;prediction&quot;</span>).rdd.map(x =&gt; ((x(<span class="number">0</span>),x(<span class="number">1</span>)),x(<span class="number">2</span>)))</span><br><span class="line">      .join(df.select(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;product&quot;</span>,<span class="string">&quot;rating&quot;</span>).rdd.map(x =&gt; ((x(<span class="number">0</span>),x(<span class="number">1</span>)),x(<span class="number">2</span>))))</span><br><span class="line">      .values</span><br><span class="line">      .take(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    math.sqrt(predictionsAndRatings.map(x =&gt; (x._1.toString.toDouble  - x._2.toString.toDouble) * (x._1.toString.toDouble - x._2.toString.toDouble)).reduce(_ + _) / n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 装载用户评分文件 **/</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">loadRatings</span></span>(path: <span class="type">String</span>): <span class="type">Seq</span>[<span class="type">Rating</span>] = &#123;</span><br><span class="line">    <span class="keyword">val</span> lines = <span class="type">Source</span>.fromFile(path).getLines()</span><br><span class="line">    <span class="keyword">val</span> ratings = lines.map &#123; line =&gt;</span><br><span class="line">      <span class="keyword">val</span> fields = line.split(<span class="string">&quot;::&quot;</span>)</span><br><span class="line">      <span class="type">Rating</span>(fields(<span class="number">0</span>).toInt, fields(<span class="number">1</span>).toInt, fields(<span class="number">2</span>).toDouble)</span><br><span class="line">    &#125;.filter(_.rating &gt; <span class="number">0.0</span>)</span><br><span class="line">    <span class="keyword">if</span> (ratings.isEmpty) &#123;</span><br><span class="line">      sys.error(<span class="string">&quot;No ratings provided.&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ratings.toSeq</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>Spark_Recommend_Dataframe<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Spark_Recommend_Dataframe<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-sql_2.11 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-mllib_2.11 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-mllib_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-core_2.11 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>2.11.8<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/234.png" alt="1685494206333"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/235.png" alt="1685494554534"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/236.png" alt="1685494602636"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/237.png" alt="1685494852399"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/240.png" alt="1685495480155"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/238.png" alt="1685494906503"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/241.png" alt="1685495635526"></p><p>运行成功</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/130.png" alt="1685282444814"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/131.png" alt="1685282485542"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/242.png" alt="1685495693374"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/244.png" alt="1685495849116"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/243.png" alt="1685495731256"></p><p>用老图示意一下</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/136.png" alt="1685283604818"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/137.png" alt="1685283626589"></p><p>jar放入spark中运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark/</span><br><span class="line"> ./bin/spark-submit --class recommend.MovieLensALS ~/IdeaProjects/Spark_Recommend_Dataframe/out/artifacts/Spark_Recommend_Dataframe_jar/Spark_Recommend_Dataframe.jar  /input_spark ~/Downloads/personalRatings.dat 10 5 10</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/247.png" alt="1685498468383"></p><p>运行完成</p><h4 id="3-node-js中展示"><a href="#3-node-js中展示" class="headerlink" title="3.node.js中展示"></a>3.node.js中展示</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir mysparkapp</span><br><span class="line">cd mysparkapp</span><br><span class="line">npm init</span><br><span class="line"></span><br><span class="line">npm install express -save</span><br><span class="line">npm install jade --save</span><br><span class="line">npm install body-parser --save</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir views</span><br><span class="line">vim index.js</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> spawnSync = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">spawnSync</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置模板引擎</span></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>,<span class="string">&#x27;./views&#x27;</span>)</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>)</span><br><span class="line"><span class="comment">// 添加body-parser解析post过来的数据</span></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;电影推荐系统&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室电影推荐系统&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> path = req.<span class="property">body</span>.<span class="property">path</span>.<span class="title function_">trim</span>() || <span class="string">&#x27;/input_spark&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> myRatings = req.<span class="property">body</span>.<span class="property">myRatings</span>.<span class="title function_">trim</span>() || <span class="string">&#x27;~/Downloads/personalRatings.dat&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> bestRank = req.<span class="property">body</span>.<span class="property">bestRank</span>.<span class="title function_">trim</span>() || <span class="number">10</span></span><br><span class="line">  <span class="keyword">const</span> bestLambda = req.<span class="property">body</span>.<span class="property">bestLambda</span>.<span class="title function_">trim</span>() || <span class="number">5</span></span><br><span class="line">  <span class="keyword">const</span> bestNumIter = req.<span class="property">body</span>.<span class="property">bestNumIter</span>.<span class="title function_">trim</span>() || <span class="number">10</span></span><br><span class="line">  <span class="keyword">let</span> spark_submit = <span class="title function_">spawnSync</span>(<span class="string">&#x27;/usr/local/spark/bin/spark-submit&#x27;</span>,[<span class="string">&#x27;--class&#x27;</span>, <span class="string">&#x27;recommend.MovieLensALS&#x27;</span>,<span class="string">&#x27; ~/IdeaProjects/Spark_Recommend_Dataframe/out/artifacts/Spark_Recommend_Dataframe_jar/Spark_Recommend_Dataframe.jar&#x27;</span>, path, myRatings, bestRank, bestLambda, bestNumIter],&#123; <span class="attr">shell</span>:<span class="literal">true</span>, <span class="attr">encoding</span>: <span class="string">&#x27;utf8&#x27;</span> &#125;)</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;电影推荐系统&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;厦门大学数据库实验室电影推荐系统&#x27;</span>, <span class="attr">result</span>: spark_submit.<span class="property">stdout</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> host = server.<span class="title function_">address</span>().<span class="property">address</span>;</span><br><span class="line">  <span class="keyword">const</span> port = server.<span class="title function_">address</span>().<span class="property">port</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Example app listening at http://%s:%s&#x27;</span>, host, port);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd views</span><br><span class="line">vim index.<span class="property">jade</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1!= message  </span><br><span class="line">    <span class="title function_">form</span>(action=<span class="string">&#x27;/&#x27;</span>, method=<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">      p 请输入建模的相关信息</span><br><span class="line">      <span class="title function_">table</span>(border=<span class="number">0</span>)</span><br><span class="line">        tr</span><br><span class="line">          td 样本数据的路径(默认为/input_spark)</span><br><span class="line">          td </span><br><span class="line">            <span class="title function_">input</span>(style=<span class="string">&#x27;width:350px&#x27;</span>,placeholder=<span class="string">&#x27;/input_spark&#x27;</span>,name=<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line">        tr</span><br><span class="line">          td 用户评分数据的路径(默认为~<span class="regexp">/Downloads/</span>personalRatings.<span class="property">dat</span>)</span><br><span class="line">          td </span><br><span class="line">            <span class="title function_">input</span>(style=<span class="string">&#x27;width:350px&#x27;</span>,placeholder=<span class="string">&#x27;~/Downloads/personalRatings.dat &#x27;</span>,name=<span class="string">&#x27;myRatings&#x27;</span>)    </span><br><span class="line">        tr</span><br><span class="line">          td 隐语义因子的个数：</span><br><span class="line">          td </span><br><span class="line">            <span class="title function_">input</span>(placeholder=<span class="string">&#x27;10&#x27;</span>,type=<span class="string">&#x27;number&#x27;</span>,min=<span class="string">&#x27;8&#x27;</span>,max=<span class="string">&#x27;12&#x27;</span>,name=<span class="string">&#x27;bestRank&#x27;</span>)</span><br><span class="line">        tr</span><br><span class="line">          td 正则化参数：</span><br><span class="line">          td </span><br><span class="line">            <span class="title function_">input</span>(placeholder=<span class="string">&#x27;5&#x27;</span>,type=<span class="string">&#x27;number&#x27;</span>,min=<span class="string">&#x27;0&#x27;</span>,max=<span class="string">&#x27;10&#x27;</span>,step=<span class="string">&#x27;0.1&#x27;</span>,name=<span class="string">&#x27;bestLambda&#x27;</span>)</span><br><span class="line">        tr</span><br><span class="line">          td 迭代次数：</span><br><span class="line">          td </span><br><span class="line">            <span class="title function_">input</span>(placeholder=<span class="string">&#x27;10&#x27;</span>,type=<span class="string">&#x27;number&#x27;</span>,min=<span class="string">&#x27;10&#x27;</span>,max=<span class="string">&#x27;20&#x27;</span>,name=<span class="string">&#x27;bestNumIter&#x27;</span>)            </span><br><span class="line">      <span class="title function_">input</span>(type=<span class="string">&#x27;submit&#x27;</span>)</span><br><span class="line">      br      </span><br><span class="line">      <span class="title function_">textarea</span>(rows=<span class="string">&#x27;20&#x27;</span>, cols=<span class="string">&#x27;40&#x27;</span>)!=result</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd mysparkapp</span><br><span class="line">node index.js</span><br></pre></td></tr></table></figure><h1 id="十七、update"><a href="#十七、update" class="headerlink" title="十七、update"></a>十七、update</h1><p>数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br><span class="line">mysql -u root -p</span><br><span class="line">source ~/Downloads/MovieRecommendDatabase.sql</span><br><span class="line">select count(*) from movieinfo;use movierecommend ;</span><br></pre></td></tr></table></figure><p>idea</p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/248.png" alt="1685500057215"></p><p>和之前步骤一样，最后创建一个recomme文件</p><p>在文件里面创建四个文件</p><p>MovieLensALS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">package recommend</span><br><span class="line"></span><br><span class="line">import java.io.File</span><br><span class="line">import org.apache.log4j.&#123;Level, Logger&#125;</span><br><span class="line">import org.apache.spark.ml.recommendation.&#123;ALS, ALSModel&#125;</span><br><span class="line">import org.apache.spark.mllib.recommendation.Rating</span><br><span class="line">import org.apache.spark.rdd.RDD</span><br><span class="line">import org.apache.spark.sql.&#123;DataFrame, Row, SparkSession&#125;</span><br><span class="line">import org.apache.spark.&#123;SparkConf, SparkContext&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">object MovieLensALS &#123;</span><br><span class="line">  case class Rating(user : Int, product : Int, rating : Double)</span><br><span class="line">  val spark=SparkSession.builder().appName(&quot;MovieLensALS&quot;).master(&quot;local[2]&quot;).getOrCreate()</span><br><span class="line"></span><br><span class="line">  def main(args: Array[String]) &#123;</span><br><span class="line">    // 屏蔽不必要的日志显示在终端上</span><br><span class="line">    Logger.getLogger(&quot;org.apache.spark&quot;).setLevel(Level.ERROR)</span><br><span class="line">    Logger.getLogger(&quot;org.eclipse.jetty.server&quot;).setLevel(Level.OFF)</span><br><span class="line">    if (args.length != 2) &#123;</span><br><span class="line">      println(&quot;Usage: /usr/local/spark/bin/spark-submit --class recommend.MovieLensALS &quot; +</span><br><span class="line">        &quot;Spark_Recommend_Dataframe.jar movieLensHomeDir userid&quot;)</span><br><span class="line">      sys.exit(1)</span><br><span class="line">    &#125;</span><br><span class="line">    // 设置运行环境</span><br><span class="line">    import spark.implicits._</span><br><span class="line"></span><br><span class="line">    // 装载参数二,即用户评分,该评分由评分器生成</span><br><span class="line">    val userid=args(1).toInt;</span><br><span class="line">    //删除该用户之前已经存在的电影推荐结果，为本次写入最新的推荐结果做准备</span><br><span class="line">    DeleteFromMySQL.delete(userid)</span><br><span class="line">    //从关系数据库中读取该用户对一些电影的个性化评分数据</span><br><span class="line">    val personalRatingsLines:Array[String]=ReadFromMySQL.read(userid)</span><br><span class="line">    val myRatings = loadRatings(personalRatingsLines)</span><br><span class="line">    val myRatingsRDD = spark.sparkContext.parallelize(myRatings, 1)</span><br><span class="line"></span><br><span class="line">    // 样本数据目录</span><br><span class="line">    val movieLensHomeDir = args(0)</span><br><span class="line">    // 装载样本评分数据,其中最后一列 Timestamp 取除 10 的余数作为 key,Rating 为值,即(Int,Rating)</span><br><span class="line">    //ratings.dat 原始数据:用户编号、电影编号、评分、评分时间戳</span><br><span class="line">    val ratings = spark.sparkContext.textFile(new File(movieLensHomeDir,</span><br><span class="line">      &quot;ratings.dat&quot;).toString).map &#123; line =&gt;</span><br><span class="line">      val fields = line.split(&quot;::&quot;)</span><br><span class="line">      (fields(3).toLong % 10, Rating(fields(0).toInt, fields(1).toInt,</span><br><span class="line">        fields(2).toDouble))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //装载电影目录对照表(电影 ID-&gt;电影标题)</span><br><span class="line">    //movies.dat 原始数据:电影编号、电影名称、电影类别</span><br><span class="line">    val movies = spark.sparkContext.textFile(new File(movieLensHomeDir,</span><br><span class="line">      &quot;movies.dat&quot;).toString).map &#123; line =&gt;</span><br><span class="line">      val fields = line.split(&quot;::&quot;)</span><br><span class="line">      (fields(0).toInt, fields(1).toString())</span><br><span class="line">    &#125;.collect().toMap</span><br><span class="line"></span><br><span class="line">    val numRatings = ratings.count()</span><br><span class="line">    val numUsers = ratings.map(_._2.user).distinct().count()</span><br><span class="line">    val numMovies = ratings.map(_._2.product).distinct().count()</span><br><span class="line">    // 将样本评分表以 key 值切分成 3 个部分,分别用于训练 (60%,并加入用户评分), 校验 (20%), and 测试 (20%)</span><br><span class="line">    // 该数据在计算过程中要多次应用到,所以 cache 到内存</span><br><span class="line">    val numPartitions = 4</span><br><span class="line">    // training 训练样本数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    val trainingDF = ratings.filter(x =&gt; x._1 &lt; 6) //取评分时间除 10 的余数后值小于 6 的作为训练样本</span><br><span class="line">      .values</span><br><span class="line">      .union(myRatingsRDD) //注意 ratings 是(Int,Rating),取 value 即可</span><br><span class="line">      .toDF()</span><br><span class="line">      .repartition(numPartitions)</span><br><span class="line"></span><br><span class="line">    // validation 校验样本数据</span><br><span class="line">    val validationDF = ratings.filter(x =&gt; x._1 &gt;= 6 &amp;&amp; x._1 &lt; 8) //取评分时间除 10 的余数后值大于等于 6 且小于 8 分的作为校验样本</span><br><span class="line">      .values</span><br><span class="line">      .toDF()</span><br><span class="line">      .repartition(numPartitions)</span><br><span class="line"></span><br><span class="line">    // test 测试样本数据</span><br><span class="line"></span><br><span class="line">    val testDF = ratings.filter(x =&gt; x._1 &gt;= 8).values.toDF() //取评分时间除 10 的余数后值大于等于 8 分的作为测试样本</span><br><span class="line">    val numTraining = trainingDF.count()</span><br><span class="line">    val numValidation = validationDF.count()</span><br><span class="line">    val numTest = testDF.count()</span><br><span class="line">    // 训练不同参数下的模型,并在校验集中验证,获取最佳参数下的模型</span><br><span class="line">    val ranks = List(8, 12) //模型中隐语义因子的个数</span><br><span class="line">    val lambdas = List(0.1, 10.0) //是 ALS 的正则化参数</span><br><span class="line">    val numIters = List(10, 20) //迭代次数</span><br><span class="line">    var bestModel: Option[ALSModel] = None //最好的模型</span><br><span class="line">    var bestValidationRmse = Double.MaxValue //最好的校验均方根误差</span><br><span class="line">    var bestRank = 0 //最好的隐语义因子的个数</span><br><span class="line">    var bestLambda = 0.0  //最好的ALS正则化参数</span><br><span class="line">    var bestNumIter = 0  //最好的迭代次数</span><br><span class="line">    for (rank &lt;- ranks; lambda &lt;- lambdas; numIter &lt;- numIters) &#123;</span><br><span class="line">      println(&quot;正在执行循环训练模型&quot;)</span><br><span class="line">      val als = new ALS().setMaxIter(numIter).setRank(rank).setRegParam(lambda).setUserCol(&quot;user&quot;).setItemCol(&quot;product&quot;).setRatingCol(&quot;rating&quot;)</span><br><span class="line">      val model = als.fit(trainingDF)//训练样本、隐语义因子的个数、迭代次数、ALS 的正则化参数</span><br><span class="line">      // model 训练模型</span><br><span class="line">      //输入训练模型、校验样本、校验个数</span><br><span class="line">      val validationRmse = computeRmse(model, validationDF, numValidation) // 校验模型结果</span><br><span class="line">      if (validationRmse &lt; bestValidationRmse) &#123;</span><br><span class="line">        bestModel = Some(model)</span><br><span class="line">        bestValidationRmse = validationRmse</span><br><span class="line">        bestRank = rank</span><br><span class="line">        bestLambda = lambda</span><br><span class="line">        bestNumIter = numIter</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 用最佳模型预测测试集的评分,并计算和实际评分之间的均方根误差</span><br><span class="line">    val testRmse = computeRmse(bestModel.get, testDF, numTest)</span><br><span class="line">    //创建一个基准(Naïve Baseline),并把它和最好的模型进行比较</span><br><span class="line">    val meanRating = trainingDF.union(validationDF).select(&quot;rating&quot;).rdd.map&#123;case Row(v : Double) =&gt; v&#125;.mean</span><br><span class="line">    val baselineRmse = math.sqrt(testDF.select(&quot;rating&quot;).rdd.map&#123;case Row(v : Double) =&gt; v&#125;.map(x =&gt; (meanRating - x) * (meanRating - x)).mean)</span><br><span class="line">    //改进了基准的最佳模型</span><br><span class="line">    val improvement = (baselineRmse - testRmse) / baselineRmse * 100</span><br><span class="line">    // 推荐前十部最感兴趣的电影,注意要剔除用户已经评分的电影</span><br><span class="line">    val myRatedMovieIds = myRatings.map(_.product).toSet</span><br><span class="line"></span><br><span class="line">    val candidates = spark.sparkContext.parallelize(movies.keys.filter(!myRatedMovieIds.contains(_)).toSeq).map(Rating(userid,_,0.0))</span><br><span class="line">      .toDF().select(&quot;user&quot;,&quot;product&quot;)</span><br><span class="line">    //上面的Rating(userid,_,0.0)中，0.0是赋予的初始评分值</span><br><span class="line">    val recommendations = bestModel.get</span><br><span class="line">      .transform(candidates).select(&quot;user&quot;,&quot;product&quot;,&quot;prediction&quot;).rdd</span><br><span class="line">      .map(x =&gt; Rating(x(0).toString.toInt,x(1).toString.toInt,x(2).toString.toDouble))</span><br><span class="line">      .sortBy(-_.rating)</span><br><span class="line">      .take(10)</span><br><span class="line">    //把推荐结果写入数据库</span><br><span class="line">    val rddForMySQL=recommendations.map(r=&gt;r.user + &quot;::&quot;+ r.product + &quot;::&quot;+ r.rating+&quot;::&quot; + movies(r.product))</span><br><span class="line">    InsertIntoMySQL.insert(rddForMySQL)</span><br><span class="line">    var i = 1</span><br><span class="line">    println(&quot;Movies recommended for you(用户 ID:推荐电影 ID:推荐分数:推荐电影名称):&quot;)</span><br><span class="line">    recommendations.foreach &#123; r =&gt;</span><br><span class="line">      println(r.user + &quot;:&quot; + r.product + &quot;:&quot; + r.rating + &quot;:&quot; + movies(r.product))</span><br><span class="line">      i += 1</span><br><span class="line">    &#125;</span><br><span class="line">    spark.sparkContext.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** 校验集预测数据和实际数据之间的均方根误差 **/</span><br><span class="line">  //输入训练模型、校验样本、校验个数</span><br><span class="line">  def computeRmse(model: ALSModel, df: DataFrame, n: Long): Double = &#123;</span><br><span class="line">    import spark.implicits._</span><br><span class="line">    val predictions = model.transform(df.select(&quot;user&quot;,&quot;product&quot;)) //调用预测的函数</span><br><span class="line">    // 输出 predictionsAndRatings 预测和评分</span><br><span class="line">    val predictionsAndRatings = predictions.select(&quot;user&quot;,&quot;product&quot;,&quot;prediction&quot;).rdd.map(x =&gt; ((x(0),x(1)),x(2)))</span><br><span class="line">      .join(df.select(&quot;user&quot;,&quot;product&quot;,&quot;rating&quot;).rdd.map(x =&gt; ((x(0),x(1)),x(2))))</span><br><span class="line">      .values</span><br><span class="line">      .take(10)</span><br><span class="line"></span><br><span class="line">    math.sqrt(predictionsAndRatings.map(x =&gt; (x._1.toString.toDouble  - x._2.toString.toDouble) * (x._1.toString.toDouble - x._2.toString.toDouble)).reduce(_ + _) / n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** 装载用户评分文件 **/</span><br><span class="line">  def loadRatings(lines: Array[String]): Seq[Rating] = &#123;</span><br><span class="line">    val ratings = lines.map &#123; line =&gt;</span><br><span class="line">      val fields = line.split(&quot;::&quot;)</span><br><span class="line">      Rating(fields(0).toInt, fields(1).toInt, fields(2).toDouble)</span><br><span class="line">    &#125;.filter(_.rating &gt; 0.0)</span><br><span class="line">    if (ratings.isEmpty) &#123;</span><br><span class="line">      sys.error(&quot;No ratings provided.&quot;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      ratings.toSeq</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DeleteFromMySQL</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package recommend</span><br><span class="line">import java.sql.&#123;Connection, DriverManager, PreparedStatement&#125;</span><br><span class="line">import org.apache.spark.sql.&#123;DataFrame, Row, SQLContext&#125;</span><br><span class="line"></span><br><span class="line">object DeleteFromMySQL &#123;</span><br><span class="line"></span><br><span class="line">  val url = &quot;jdbc:mysql://localhost:3306/movierecommend?useUnicode=true&amp;characterEncoding=UTF-8&quot;</span><br><span class="line">  val prop = new java.util.Properties</span><br><span class="line">  prop.setProperty(&quot;user&quot;, &quot;root&quot;)</span><br><span class="line">  prop.setProperty(&quot;password&quot;, &quot;123&quot;)</span><br><span class="line">  def delete(userid:Int): Unit = &#123;</span><br><span class="line">    var conn: Connection = null</span><br><span class="line">    var ps: PreparedStatement = null</span><br><span class="line">    val sql = &quot;delete from recommendresult where userid=&quot;+userid</span><br><span class="line">    conn = DriverManager.getConnection(url,prop)</span><br><span class="line">    ps = conn.prepareStatement(sql)</span><br><span class="line">    ps.executeUpdate()</span><br><span class="line"></span><br><span class="line">    if (ps != null) &#123;</span><br><span class="line">      ps.close()</span><br><span class="line">    &#125;</span><br><span class="line">    if (conn != null) &#123;</span><br><span class="line">      conn.close()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InsertIntoMySQL</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> recommend</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.&#123;<span class="type">Row</span>, <span class="type">SparkSession</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">InsertIntoMySQL</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">insert</span></span>(array:<span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> spark= <span class="type">SparkSession</span>.builder().appName(<span class="string">&quot;InsertIntoMySQL&quot;</span>).master(<span class="string">&quot;local[2]&quot;</span>).getOrCreate()</span><br><span class="line">    <span class="keyword">val</span> movieRDD = spark.sparkContext.parallelize(array).map(_.split(<span class="string">&quot;::&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> rowRDD = movieRDD.map(p =&gt; <span class="type">Row</span>(p(<span class="number">0</span>).trim.toInt, p(<span class="number">1</span>).trim.toInt, p(<span class="number">2</span>).trim.toFloat, p(<span class="number">3</span>).trim))</span><br><span class="line">    rowRDD.foreach(println)</span><br><span class="line">    <span class="keyword">val</span> schema = <span class="type">StructType</span>(<span class="type">List</span>(</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;userid&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;movieid&quot;</span>, <span class="type">IntegerType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;rating&quot;</span>, <span class="type">FloatType</span>, <span class="literal">true</span>),</span><br><span class="line">      <span class="type">StructField</span>(<span class="string">&quot;moviename&quot;</span>, <span class="type">StringType</span>, <span class="literal">true</span>)))</span><br><span class="line">    <span class="keyword">val</span> movieDF=spark.createDataFrame(rowRDD,schema)</span><br><span class="line">    <span class="keyword">val</span> prop = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    prop.put(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">    prop.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123&quot;</span>)</span><br><span class="line">    prop.put(<span class="string">&quot;driver&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>)</span><br><span class="line">    movieDF.write.mode(<span class="string">&quot;append&quot;</span>).jdbc(<span class="string">&quot;jdbc:mysql://localhost:3306/movierecommend&quot;</span>, <span class="string">&quot;movierecommend.recommendresult&quot;</span>, prop)</span><br><span class="line">    movieDF.show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ReadFromMySQL</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> recommend</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.&#123;<span class="type">Row</span>, <span class="type">SparkSession</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ArrayBuffer</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ReadFromMySQL</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">read</span></span>(userid:<span class="type">Int</span>): <span class="type">Array</span>[<span class="type">String</span>] = &#123;</span><br><span class="line">    <span class="keyword">val</span> spark= <span class="type">SparkSession</span>.builder().appName(<span class="string">&quot;ReadFromMySQL&quot;</span>).master(<span class="string">&quot;local[2]&quot;</span>).getOrCreate()</span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line">    <span class="keyword">val</span> personalRatingsDF = spark.</span><br><span class="line">      read.format(<span class="string">&quot;jdbc&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://localhost:3306/movierecommend&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;driver&quot;</span>,<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;personalratings&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>).</span><br><span class="line">      option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123&quot;</span>).load()</span><br><span class="line">    personalRatingsDF.show()</span><br><span class="line">    personalRatingsDF.createOrReplaceTempView(<span class="string">&quot;personalratings&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> prDF=spark.sql(<span class="string">&quot;select * from personalratings where userid=&quot;</span>+userid)</span><br><span class="line">    <span class="keyword">val</span> myrdd=prDF.rdd.map(r=&gt;&#123;r(<span class="number">0</span>).toString+<span class="string">&quot;::&quot;</span>+r(<span class="number">1</span>).toString+<span class="string">&quot;::&quot;</span>+r(<span class="number">2</span>).toString+<span class="string">&quot;::&quot;</span>+r(<span class="number">3</span>).toString&#125;)</span><br><span class="line">    <span class="keyword">val</span> array=<span class="type">ArrayBuffer</span>[<span class="type">String</span>]()</span><br><span class="line">    array++=myrdd.collect();</span><br><span class="line">    println(array.length)</span><br><span class="line">    <span class="keyword">val</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until array.length)&#123;println(array(i))&#125;</span><br><span class="line">    array.toArray</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>Film_Recommend_Dataframe<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Film_Recommend_Dataframe<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-mllib_2.11 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-mllib_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-core_2.11 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.40<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.hadoop/hadoop-yarn-common --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-yarn-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile-scala<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>2.11.8<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/249.png" alt="1685501301214"></p><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/250.png" alt="1685501677945"></p><p>打包jar</p><p>运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/spark/</span><br><span class="line">./bin/spark-submit --class recommend.MovieLensALS ~/IdeaProjects/Film_Recommend_Dataframe/out/artifacts/Film_Recommend_Dataframe_jar/Film_Recommend_Dataframe.jar /input_spark 1</span><br></pre></td></tr></table></figure><p><img src="/images/loading.gif" data-original="/images/%E7%94%B5%E5%BD%B1%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/256.png" alt="1685502183115"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir movierecommendapp</span><br><span class="line">cd  movierecommendapp</span><br><span class="line">npm install express -save</span><br><span class="line">npm install jade --save</span><br><span class="line">npm install body-parser --save</span><br><span class="line">npm install mysql --save</span><br></pre></td></tr></table></figure><p>vim movierecommend.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Created by linziyu on 2018/7/3.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * express接收html传递的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span>  express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span>  bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> spawnSync = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">spawnSync</span>;</span><br><span class="line">    <span class="keyword">var</span>  app=<span class="title function_">express</span>();</span><br><span class="line">    <span class="keyword">var</span> mysql=<span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">    app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;jade&#x27;</span>); </span><br><span class="line">    app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;./views&#x27;</span>);</span><br><span class="line">    app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;))</span><br><span class="line">    app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置MySQL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> connection = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">        host     : <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        user     : <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        password : <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">        database : <span class="string">&#x27;movierecommend&#x27;</span>,</span><br><span class="line">        <span class="attr">port</span>:<span class="string">&#x27;3306&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    connection.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转到网站首页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转到登录页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    app.<span class="title function_">get</span>(<span class="string">&#x27;/loginpage&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;loginpage&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;登录&#x27;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现登录验证功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span>  name=req.<span class="property">body</span>.<span class="property">username</span>.<span class="title function_">trim</span>();</span><br><span class="line">        <span class="keyword">var</span> pwd=req.<span class="property">body</span>.<span class="property">pwd</span>.<span class="title function_">trim</span>();</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;username:&#x27;</span>+name+<span class="string">&#x27;password:&#x27;</span>+pwd);</span><br><span class="line">        <span class="keyword">var</span> selectMovieInfoSQL=<span class="string">&quot;select movieid,moviename,picture from movieinfo limit 1000&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> movieinfolist=[];</span><br><span class="line">	connection.<span class="title function_">query</span>(selectMovieInfoSQL,<span class="keyword">function</span>(<span class="params">err,rows,fields</span>)&#123;</span><br><span class="line">	   <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">	   <span class="comment">//console.log(&#x27;movieids length is:&#x27;+rows.length);</span></span><br><span class="line">	   <span class="comment">//console.log(&#x27;movieid is:&#x27;+rows[0].movieid);</span></span><br><span class="line">           <span class="comment">//console.log(&#x27;moviename is:&#x27;+rows[0].moviename);</span></span><br><span class="line">           movieinfolist=rows;</span><br><span class="line">           &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> selectSQL = <span class="string">&quot;select * from user where username = &#x27;&quot;</span>+name+<span class="string">&quot;&#x27; and password = &#x27;&quot;</span>+pwd+<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        connection.<span class="title function_">query</span>(selectSQL,<span class="keyword">function</span> (<span class="params">err,rows,fields</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">randomFrom</span>(<span class="params">lowerValue,upperValue</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * (upperValue - lowerValue + <span class="number">1</span>) + lowerValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//console.log(&#x27;userid is:&#x27;+rows[0].userid);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> lowerValue=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> upperValue=movieinfolist.<span class="property">length</span>;</span><br><span class="line">            <span class="keyword">var</span> index=<span class="title function_">randomFrom</span>(lowerValue,upperValue);</span><br><span class="line">            <span class="comment">//console.log(&#x27;movieid random is:&#x27;+movieinfolist[index].movieid);</span></span><br><span class="line">            <span class="comment">//console.log(&#x27;moviename random is:&#x27;+movieinfolist[index].moviename);</span></span><br><span class="line">            <span class="keyword">var</span> movielist=[];</span><br><span class="line">            <span class="keyword">var</span> movieNumbers=<span class="number">10</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;movieNumbers;i++)&#123;</span><br><span class="line">              index=<span class="title function_">randomFrom</span>(lowerValue,upperValue);</span><br><span class="line">              movielist.<span class="title function_">push</span>(&#123;<span class="attr">movieid</span>:movieinfolist[index].<span class="property">movieid</span>,<span class="attr">moviename</span>:movieinfolist[index].<span class="property">moviename</span>,<span class="attr">picture</span>:movieinfolist[index].<span class="property">picture</span>&#125;);</span><br><span class="line">              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//for(var item in movielist)&#123;</span></span><br><span class="line">            <span class="comment">//  console.log(&#x27;item is:&#x27;+item);</span></span><br><span class="line">            <span class="comment">//  console.log(&#x27;movieid is:&#x27;+movielist[item].movieid);</span></span><br><span class="line">            <span class="comment">//  console.log(&#x27;moviename is:&#x27;+movielist[item].moviename);</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">                       </span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;personalratings&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;Welcome User&#x27;</span>,<span class="attr">userid</span>:rows[<span class="number">0</span>].<span class="property">userid</span>,<span class="attr">username</span>:rows[<span class="number">0</span>].<span class="property">username</span>,<span class="attr">movieforpage</span>:movielist&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转到注册页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">    app.<span class="title function_">get</span>(<span class="string">&#x27;/registerpage&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;registerpage&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;注册&#x27;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现注册功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span>  name=req.<span class="property">body</span>.<span class="property">username</span>.<span class="title function_">trim</span>();</span><br><span class="line">        <span class="keyword">var</span>  pwd=req.<span class="property">body</span>.<span class="property">pwd</span>.<span class="title function_">trim</span>();</span><br><span class="line">        <span class="keyword">var</span>  user=&#123;<span class="attr">username</span>:name,<span class="attr">password</span>:pwd&#125;;</span><br><span class="line">        connection.<span class="title function_">query</span>(<span class="string">&#x27;insert into user set ?&#x27;</span>,user,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;register success&#x27;</span>);</span><br><span class="line">           res.<span class="title function_">render</span>(<span class="string">&#x27;registersuccess&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;注册成功&#x27;</span>,<span class="attr">message</span>:name&#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把用户评分写入数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">    app.<span class="title function_">post</span>(<span class="string">&#x27;/submituserscore&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span>  userid=req.<span class="property">body</span>.<span class="property">userid</span>;</span><br><span class="line">        <span class="keyword">var</span> moviescores=[];</span><br><span class="line">        <span class="keyword">var</span> movieids=[];</span><br><span class="line">        req.<span class="property">body</span>.<span class="property">moviescore</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">score</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(&#x27;the score is:&#x27;+score);</span></span><br><span class="line">            moviescores.<span class="title function_">push</span>(&#123;<span class="attr">moviescore</span>:score&#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        req.<span class="property">body</span>.<span class="property">movieid</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(&#x27;the id is:&#x27;+id);</span></span><br><span class="line">            movieids.<span class="title function_">push</span>(&#123;<span class="attr">movieid</span>:id&#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//for(var item in movieids)&#123;</span></span><br><span class="line">        <span class="comment">//   console.log(&#x27;item is:&#x27;+item);</span></span><br><span class="line">        <span class="comment">//   console.log(&#x27;movieid is:&#x27;+movieids[item].movieid);</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">//for(var item in moviescores)&#123;</span></span><br><span class="line">        <span class="comment">//   console.log(&#x27;item is:&#x27;+item);</span></span><br><span class="line">        <span class="comment">//   console.log(&#x27;moviescore is:&#x27;+moviescores[item].moviescore);</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">//删除该用户历史评分数据，为写入本次最新评分数据做准备</span></span><br><span class="line">        connection.<span class="title function_">query</span>(<span class="string">&#x27;delete from  personalratings where userid=&#x27;</span>+userid, <span class="keyword">function</span>(<span class="params">err, result</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;deleted&#x27;</span>);</span><br><span class="line">            <span class="comment">//console.log(result);</span></span><br><span class="line">            <span class="comment">//console.log(&#x27;\n&#x27;);</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//生成评分时间戳</span></span><br><span class="line">        <span class="keyword">var</span> mytimestamp =<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>().<span class="title function_">toString</span>().<span class="title function_">slice</span>(<span class="number">1</span>,<span class="number">10</span>);        </span><br><span class="line">        <span class="comment">//console.log(&#x27;mytimestamp2 is:&#x27;+mytimestamp);</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> item <span class="keyword">in</span> movieids)&#123;</span><br><span class="line">           <span class="comment">//把每条评分记录(userid,movieid,rating,timestamp)插入数据库  </span></span><br><span class="line">           <span class="keyword">var</span> personalratings=&#123;<span class="attr">userid</span>:userid,<span class="attr">movieid</span>:movieids[item].<span class="property">movieid</span>,<span class="attr">rating</span>:moviescores[item].<span class="property">moviescore</span>,<span class="attr">timestamp</span>:mytimestamp&#125;;</span><br><span class="line">           connection.<span class="title function_">query</span>(<span class="string">&#x27;insert into personalratings set ?&#x27;</span>,personalratings,<span class="keyword">function</span> (<span class="params">err,rs</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;insert into personalrating success&#x27;</span>);          </span><br><span class="line">           &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> selectUserIdNameSQL=<span class="string">&#x27;select userid,username from user where userid=&#x27;</span>+userid;</span><br><span class="line">        connection.<span class="title function_">query</span>(selectUserIdNameSQL,<span class="keyword">function</span>(<span class="params">err,rows,fields</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">           res.<span class="title function_">render</span>(<span class="string">&#x27;userscoresuccess&#x27;</span>,&#123;<span class="attr">title</span>:<span class="string">&#x27;Personal Rating Success&#x27;</span>,<span class="attr">user</span>:rows[<span class="number">0</span>]&#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    &#125;); </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用Spark程序为用户推荐电影并把推荐结果写入数据库,把推荐结果显示到网页</span></span><br><span class="line"><span class="comment">     */</span>     </span><br><span class="line">    app.<span class="title function_">get</span>(<span class="string">&#x27;/recommendmovieforuser&#x27;</span>,<span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">	<span class="comment">//console.log(&#x27;result point 1&#x27;);</span></span><br><span class="line">        <span class="keyword">const</span> userid=req.<span class="property">query</span>.<span class="property">userid</span>;</span><br><span class="line">        <span class="keyword">const</span> username=req.<span class="property">query</span>.<span class="property">username</span>;</span><br><span class="line">        <span class="comment">//console.log(&#x27;recommendation userid is:&#x27;+userid);      </span></span><br><span class="line">        <span class="keyword">const</span> path = <span class="string">&#x27;/input_spark&#x27;</span>;</span><br><span class="line">        <span class="comment">//调用Spark程序为用户推荐电影并把推荐结果写入数据库</span></span><br><span class="line">        <span class="keyword">let</span> spark_submit = <span class="title function_">spawnSync</span>(<span class="string">&#x27;/usr/local/spark/bin/spark-submit&#x27;</span>,[<span class="string">&#x27;--class&#x27;</span>, <span class="string">&#x27;recommend.MovieLensALS&#x27;</span>,<span class="string">&#x27; ~/IdeaProjects/Film_Recommend/out/artifacts/Film_Recommend_jar/Film_Recommend.jar&#x27;</span>, path, userid],&#123; <span class="attr">shell</span>:<span class="literal">true</span>, <span class="attr">encoding</span>: <span class="string">&#x27;utf8&#x27;</span> &#125;);</span><br><span class="line">        <span class="comment">//console.log(&#x27;spark running result is:&#x27;+spark_submit.stdout);</span></span><br><span class="line">        <span class="comment">//从数据库中读取推荐结果,把推荐结果显示到网页</span></span><br><span class="line">        <span class="keyword">var</span> selectRecommendResultSQL=<span class="string">&quot;select recommendresult.userid,recommendresult.movieid,recommendresult.rating,recommendresult.moviename,movieinfo.picture from recommendresult inner join movieinfo on recommendresult.movieid=movieinfo.movieid where recommendresult.userid=&quot;</span>+userid;</span><br><span class="line">        <span class="keyword">var</span> movieinfolist=[];</span><br><span class="line">        connection.<span class="title function_">query</span>(selectRecommendResultSQL,<span class="keyword">function</span>(<span class="params">err,rows,fields</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span> (err) <span class="keyword">throw</span>  err;</span><br><span class="line">           <span class="comment">//console.log(&#x27;result point 3&#x27;);</span></span><br><span class="line">           <span class="comment">//console.log(&#x27;movieids length is:&#x27;+rows.length);</span></span><br><span class="line">           <span class="comment">//console.log(&#x27;movieid is:&#x27;+rows[0].movieid);</span></span><br><span class="line">           <span class="comment">//console.log(&#x27;moviename is:&#x27;+rows[0].moviename);</span></span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;read recommend result from database&#x27;</span>);</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;rows.<span class="property">length</span>;i++)&#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;forxunhuan:i=&#x27;</span>+i);</span><br><span class="line">              movieinfolist.<span class="title function_">push</span>(&#123;<span class="attr">userid</span>:rows[i].<span class="property">userid</span>,<span class="attr">movieid</span>:rows[i].<span class="property">movieid</span>,<span class="attr">rating</span>:rows[i].<span class="property">rating</span>,<span class="attr">moviename</span>:rows[i].<span class="property">moviename</span>,<span class="attr">picture</span>:rows[i].<span class="property">picture</span>&#125;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//for(var item in movieinfolist)&#123;</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;result point 6&#x27;);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;item is:&#x27;+item);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;userid is:&#x27;+movieinfolist[item].userid);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;movieid is:&#x27;+movieinfolist[item].movieid);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;moviename is:&#x27;+movieinfolist[item].moviename);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;rating is:&#x27;+movieinfolist[item].rating);</span></span><br><span class="line">           <span class="comment">//   console.log(&#x27;picture is:&#x27;+movieinfolist[item].picture);</span></span><br><span class="line">           <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">           res.<span class="title function_">render</span>(<span class="string">&#x27;recommendresult&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;Recommend Result&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;this is recommend for you&#x27;</span>,<span class="attr">username</span>:username,<span class="attr">movieinfo</span>:movieinfolist&#125;)</span><br><span class="line">           &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;)    </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span>  server=app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;movierecommend server start......&quot;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir views</span><br><span class="line">cd views</span><br></pre></td></tr></table></figure><p>vim index.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!=title    </span><br><span class="line">    meta(charset=&#x27;utf-8&#x27;)</span><br><span class="line">    meta(name=&#x27;description&#x27;)</span><br><span class="line">    meta(name=&#x27;keywords&#x27;)</span><br><span class="line">    meta(name=&#x27;author&#x27;)</span><br><span class="line">    link(rel=&#x27;shortcut icon&#x27;, href=&#x27;http://eduppp.cn/images/logo4.gif&#x27;)</span><br><span class="line">    link(rel=&#x27;apple-touch-icon&#x27;, href=&#x27;http://eduppp.cn/images/logo.gif&#x27;)</span><br><span class="line">    style</span><br><span class="line">      include css/index.css</span><br><span class="line">    style(type=&#x27;text/css&#x27;).</span><br><span class="line">      #frame &#123;/*----------图片轮播相框容器----------*/</span><br><span class="line">      position: absolute; /*--绝对定位，方便子元素的定位*/</span><br><span class="line">      width: 1500px;</span><br><span class="line">      height: 75%;</span><br><span class="line">      overflow: hidden;/*--相框作用，只显示一个图片---*/</span><br><span class="line">      border-radius:5px;</span><br><span class="line">      &#125;</span><br><span class="line">      #dis &#123;/*--绝对定位方便li图片简介的自动分布定位---*/</span><br><span class="line">      position: absolute;</span><br><span class="line">      left: -50px;</span><br><span class="line">      top: -10px;</span><br><span class="line">      opacity: 0.5;</span><br><span class="line">      &#125;</span><br><span class="line">      #dis li &#123;</span><br><span class="line">      display: inline-block;</span><br><span class="line">      width: 200px;</span><br><span class="line">      height: 20px;</span><br><span class="line">      margin: 0 650px;</span><br><span class="line">      float: left;</span><br><span class="line">      text-align: center;</span><br><span class="line">      color: #fff;</span><br><span class="line">      border-radius: 10px;</span><br><span class="line">      background: #000;</span><br><span class="line">      &#125;</span><br><span class="line">      #photos img &#123;</span><br><span class="line">      float: left;</span><br><span class="line">      width:1500px;</span><br><span class="line">      height:75%;</span><br><span class="line">      &#125;</span><br><span class="line">      #photos &#123;/*---设置总的图片宽度--通过位移来达到轮播效果----*/</span><br><span class="line">      position: absolute;z-index:9px;</span><br><span class="line">      width: calc(1500px * 5);/*---修改图片数量的话需要修改下面的动画参数*/</span><br><span class="line">      &#125;</span><br><span class="line">      .play&#123;</span><br><span class="line">      animation: ma 20s ease-out infinite alternate;/**/</span><br><span class="line">      &#125;</span><br><span class="line">      @keyframes ma &#123;/*---每图片切换有两个阶段：位移切换和静置。中间的效果可以任意定制----*/</span><br><span class="line">      0%,20% &#123;		margin-left: 0px;		&#125;</span><br><span class="line">      25%,40% &#123;		margin-left: -1500px;	&#125;</span><br><span class="line">      45%,60% &#123;		margin-left: -3000px;	&#125;</span><br><span class="line">      65%,80% &#123;		margin-left: -4500px;	&#125;</span><br><span class="line">      85%,100% &#123;		margin-left: -6000px;	&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      .num&#123;</span><br><span class="line">      position:absolute;z-index:10;</span><br><span class="line">      display:inline-block;</span><br><span class="line">      right:10px;top:550px;</span><br><span class="line">      border-radius:100%;</span><br><span class="line">      background:#778899;</span><br><span class="line">      width:50px;height:50px;</span><br><span class="line">      line-height:50px;</span><br><span class="line">      cursor:pointer;</span><br><span class="line">      color:#fff;</span><br><span class="line">      background-clor:rgba(0,0,0,0.5);</span><br><span class="line">      text-align:center;</span><br><span class="line">      opacity:0.8;</span><br><span class="line">      &#125;</span><br><span class="line">      .num:hover&#123;background:#000;&#125;</span><br><span class="line">      .num:hover,#photos:hover&#123;animation-play-state:paused;&#125;</span><br><span class="line">      .num:nth-child(2)&#123;margin-right:60px&#125;</span><br><span class="line">      .num:nth-child(3)&#123;margin-right:120px&#125;</span><br><span class="line">      .num:nth-child(4)&#123;margin-right:180px&#125;</span><br><span class="line">      .num:nth-child(5)&#123;margin-right:240px&#125;</span><br><span class="line">      #a1:hover ~ #photos&#123;animation: ma1 .5s ease-out forwards;&#125;</span><br><span class="line">      #a2:hover ~ #photos&#123;animation: ma2 .5s ease-out forwards;&#125;</span><br><span class="line">      #a3:hover ~ #photos&#123;animation: ma3 .5s ease-out forwards;&#125;</span><br><span class="line">      #a4:hover ~ #photos&#123;animation: ma4 .5s ease-out forwards;&#125;</span><br><span class="line">      #a5:hover ~ #photos &#123;animation: ma5 .5s ease-out forwards;&#125;</span><br><span class="line">      @keyframes ma1 &#123;0%&#123;margin-left:-1200px;&#125;100%&#123;margin-left:-0px;&#125;	&#125;</span><br><span class="line">      @keyframes ma2 &#123;0%&#123;margin-left:-1200px;&#125;100%&#123;margin-left:-1500px;&#125;	&#125;</span><br><span class="line">      @keyframes ma3 &#123;100%&#123;margin-left:-3000px;&#125;	&#125;</span><br><span class="line">      @keyframes ma4 &#123;100%&#123;margin-left:-4500px;&#125;	&#125;</span><br><span class="line">      @keyframes ma5 &#123;100%&#123;margin-left:-6000px;&#125;	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  body</span><br><span class="line">    div#navigation 欢迎访问厦门大学数据库实验室电影推荐系统</span><br><span class="line">      div#logreg</span><br><span class="line">        input(type=&#x27;submit&#x27;,value=&#x27;登录&#x27;,onclick=&quot;window.location=&#x27;/loginpage&#x27;&quot;)</span><br><span class="line">        input(type=&#x27;submit&#x27;, value=&#x27;注册&#x27;,onclick=&quot;window.location=&#x27;/registerpage&#x27;&quot;) </span><br><span class="line">    div#mid</span><br><span class="line">      #frame</span><br><span class="line">        a#a5.num 5</span><br><span class="line">        a#a4.num 4</span><br><span class="line">        a#a3.num 3</span><br><span class="line">        a#a2.num 2</span><br><span class="line">        a#a1.num 1</span><br><span class="line">        #photos.play</span><br><span class="line">          img(src=&#x27;http://img05.tooopen.com/products/20150130/44128217.jpg&#x27;)</span><br><span class="line">          img(src=&#x27;http://image.17173.com/bbs/v1/2012/11/14/1352873759491.jpg&#x27;)</span><br><span class="line">          img(src=&#x27;http://t1.27270.com/uploads/tu/201502/103/5.jpg&#x27;)</span><br><span class="line">          img(src=&#x27;http://img.doooor.com/img/forum/201507/15/171203xowepc3ju9n9br9z.jpg&#x27;)</span><br><span class="line">          img(src=&#x27;http://4493bz.1985t.com/uploads/allimg/170503/5-1F503140J0.jpg&#x27;)</span><br><span class="line">          ul#dis</span><br><span class="line">            li 魔戒：霍比特人</span><br><span class="line">            li 魔境仙踪</span><br><span class="line">            li 阿凡达</span><br><span class="line">            li 大圣归来</span><br><span class="line">            li 拆弹专家</span><br><span class="line">      </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim loginpage.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">    style.</span><br><span class="line">      body&#123;</span><br><span class="line">        background-image:url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1537261291133&amp;di=c04553d39f158272a36be6e3ec0c8071&amp;imgtype=0&amp;src=http%3A%2F%2Fh.hiphotos.baidu.com%2Fzhidao%2Fpic%2Fitem%2Fc2fdfc039245d6885bc3be94a2c27d1ed21b2438.jpg);</span><br><span class="line">      &#125;</span><br><span class="line">      #log&#123;</span><br><span class="line">        padding-top: 2px;</span><br><span class="line">        margin-top: 10%;</span><br><span class="line">        margin-left: 37%;</span><br><span class="line">        background: white;</span><br><span class="line">        width: 25%;</span><br><span class="line">        height: 40%;</span><br><span class="line">        text-align: center;</span><br><span class="line">      &#125;</span><br><span class="line">  body</span><br><span class="line">    div#log</span><br><span class="line">      form(action=&#x27;/login&#x27;, method=&#x27;post&#x27;)</span><br><span class="line">        h1 用户登录</span><br><span class="line">        br</span><br><span class="line">        span 帐号:</span><br><span class="line">        input(type=&#x27;text&#x27;,name=&#x27;username&#x27;)</span><br><span class="line">        br</span><br><span class="line">        span 密码:</span><br><span class="line">        input(type=&#x27;password&#x27;,name=&#x27;pwd&#x27;)</span><br><span class="line">        br</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;submit&#x27;,value=&#x27;登录&#x27;)</span><br><span class="line">        br</span><br><span class="line">        a(href=&#x27;/registerpage&#x27;, title=&#x27;注册&#x27;)注册</span><br><span class="line">        br</span><br><span class="line">        a(href=&#x27;/&#x27;,title=&#x27;主页&#x27;)返回主页</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim personalratings.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1 热烈欢迎用户: #&#123;username&#125;,请您为以下电影打分:</span><br><span class="line">    form(action=&#x27;/submituserscore&#x27;, method=&#x27;post&#x27;)</span><br><span class="line">       input(type=&#x27;text&#x27;,style=&quot;visibility: hidden;width:0px; height:0px;&quot;,name=&#x27;userid&#x27;, value=userid)</span><br><span class="line">       table( cellpadding=&quot;5&quot; cellspacing=&quot;5&quot;)</span><br><span class="line">         tr</span><br><span class="line">           -for(var i=0;i&lt;movieforpage.length;i++)</span><br><span class="line">            td</span><br><span class="line">              //p 电影名称:#&#123;movieforpage[i].moviename&#125;</span><br><span class="line">              input(type=&#x27;text&#x27;,style=&quot;visibility: hidden;width:0px; height:0px;&quot;,name=&#x27;movieid&#x27;, value=movieforpage[i].movieid)</span><br><span class="line">              img(src=movieforpage[i].picture)</span><br><span class="line">              br</span><br><span class="line">              select(name=&#x27;moviescore&#x27;)</span><br><span class="line">                option(value=1) 1</span><br><span class="line">                option(value=2) 2</span><br><span class="line">                option(value=3) 3</span><br><span class="line">                option(value=4) 4</span><br><span class="line">                option(value=5) 5</span><br><span class="line">             -if((i+1)%5==0)</span><br><span class="line">              tr</span><br><span class="line">        input(type=&#x27;submit&#x27;,value=&#x27;提交&#x27;)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim recommendresult.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1 亲爱的用户:#&#123;username&#125;,猜你喜欢电影:</span><br><span class="line">    table( cellpadding=&quot;5&quot; cellspacing=&quot;5&quot;)</span><br><span class="line">         tr</span><br><span class="line">           -for(var i=0;i&lt;movieinfo.length;i++)</span><br><span class="line">            td</span><br><span class="line">              p #&#123;movieinfo[i].moviename&#125;</span><br><span class="line">              img(src=movieinfo[i].picture)</span><br><span class="line">            -if((i+1)%5==0)</span><br><span class="line">             tr</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim registerpage.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">    style.</span><br><span class="line">      body&#123;</span><br><span class="line">        background-image:url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1537261291133&amp;di=c04553d39f158272a36be6e3ec0c8071&amp;imgtype=0&amp;src=http%3A%2F%2Fh.hiphotos.baidu.com%2Fzhidao%2Fpic%2Fitem%2Fc2fdfc039245d6885bc3be94a2c27d1ed21b2438.jpg);</span><br><span class="line">      &#125;</span><br><span class="line">      #reg&#123;</span><br><span class="line">        padding-top: 2px;</span><br><span class="line">        margin-top: 10%;</span><br><span class="line">        margin-left: 37%;</span><br><span class="line">        background: white;</span><br><span class="line">        width: 25%;</span><br><span class="line">        height: 40%;</span><br><span class="line">        text-align: center;</span><br><span class="line">      &#125;</span><br><span class="line">  body</span><br><span class="line">    div#reg</span><br><span class="line">      form(action=&#x27;/register&#x27;, method=&#x27;post&#x27;)</span><br><span class="line">        h1 用户注册</span><br><span class="line">        br</span><br><span class="line">        span 帐号:</span><br><span class="line">        input(type=&#x27;text&#x27;,name=&#x27;username&#x27;)</span><br><span class="line">        br</span><br><span class="line">        span 密码:</span><br><span class="line">        input(type=&#x27;password&#x27;,name=&#x27;pwd&#x27;)</span><br><span class="line">        br</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;submit&#x27;,value=&#x27;注册&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim registersuccess.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1 热烈欢迎用户: #&#123;message&#125;</span><br><span class="line">    a(href=&#x27;loginpage&#x27; tile=&#x27;请点击这里登录&#x27;)请点击这里登录</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vim userscoresuccess.jade</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title!= title</span><br><span class="line">  body</span><br><span class="line">    h1 亲爱的用户:#&#123;user.username&#125;,祝贺评分成功!</span><br><span class="line">    a(href=&#x27;/recommendmovieforuser?userid=#&#123;user.userid&#125;&amp;username=#&#123;user.username&#125;&#x27;) 点击这里为您推荐电影</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir css</span><br><span class="line">cd css</span><br><span class="line">vim index.css</span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1537261291133&amp;di=c04553d39f158272a36be6e3ec0c8071&amp;imgtype=0&amp;src=http%3A%2F%2Fh.hiphotos.baidu.com%2Fzhidao%2Fpic%2Fitem%2Fc2fdfc039245d6885bc3be94a2c27d1ed21b2438.jpg</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#navigation</span>&#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#888888</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">10%</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">50px</span>;  </span><br><span class="line">  <span class="attribute">margin-bottom</span>:<span class="number">5px</span>;    </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#logreg</span>&#123;</span><br><span class="line">  <span class="attribute">float</span>: right;</span><br><span class="line">  <span class="attribute">padding-top</span>: <span class="number">2%</span>;</span><br><span class="line">  <span class="attribute">padding-right</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#FFF</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#mid</span>&#123;</span><br><span class="line">  <span class="attribute">padding-top</span>: <span class="number">50px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">75%</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">1500px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#picchange</span>&#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">75%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#contain</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">margin</span>: auto;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">600px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">font-family</span>: Arial;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#FFF</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#contain</span> <span class="selector-tag">ul</span>&#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">1800px</span>;</span><br><span class="line">  <span class="attribute">transition</span>:all <span class="number">0.5s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#contain</span> <span class="selector-tag">li</span>&#123;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">600px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">36px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#one</span>&#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#9fa8ef</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#two</span>&#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#ef9fb1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#three</span>&#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#9fefc3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> marginLeft&#123;</span><br><span class="line">  <span class="number">0%</span>&#123;<span class="attribute">margin-left</span>: <span class="number">0</span>;&#125;</span><br><span class="line">  <span class="number">28.5%</span>&#123;<span class="attribute">margin-left</span>: <span class="number">0</span>;&#125;</span><br><span class="line">  <span class="number">33.3%</span>&#123;<span class="attribute">margin-left</span>: -<span class="number">600px</span>;&#125;</span><br><span class="line">  <span class="number">62%</span>&#123;<span class="attribute">margin-left</span>: -<span class="number">600px</span>;&#125;</span><br><span class="line">  <span class="number">66.7%</span>&#123;<span class="attribute">margin-left</span>: -<span class="number">1200px</span>;&#125;</span><br><span class="line">  <span class="number">95.2%</span>&#123;<span class="attribute">margin-left</span>: -<span class="number">1200px</span>;&#125;</span><br><span class="line">  <span class="number">100%</span>&#123;<span class="attribute">margin-left</span>: <span class="number">0</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#slide-auto</span>&#123;</span><br><span class="line">  <span class="attribute">animation</span>:marginLeft <span class="number">10.5s</span>infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后 node js</p><p>完成</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="毛" src="/images/xiao.png"><p class="site-author-name" itemprop="name">毛</p><div class="site-description" itemprop="description">在梦里啥都有</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">116</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">39</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/maduit" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;maduit" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:825577940@qq.com" title="E-Mail → mailto:825577940@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/maduit?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;maduit?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="codiepie fa-fw"></i>CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-envelope fa-fw"></i> links_settings</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/" title="https:&#x2F;&#x2F;github.com&#x2F;" rel="noopener" target="_blank">推荐阅读</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2022-09 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">毛</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动</div><div class="theme-info"><div class="powered-by"></div><span class="post-count">博客全站共116.4k字</span></div><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span> <span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span> <span class="post-meta-divider">|</span><script>$(document).ready(function(){var e=setInterval(function(){"none"!=document.getElementById("busuanzi_container_site_pv").style.display&&($("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html())+n),clearInterval(e));"none"!=$("#busuanzi_container_site_pv").css("display")&&($("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html())+n),clearInterval(e))},50),n=2e4})</script><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script defer src="/lib/three/three.min.js"></script><script defer src="/lib/three/three-waves.min.js"></script><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(a){a.imageLazyLoadSetting.processImages=t;var e=a.imageLazyLoadSetting.isSPA,i=a.imageLazyLoadSetting.preloadRatio||1,o=r();function r(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(o=r());for(var t,n=0;n<o.length;n++)0<=(t=o[n].getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(a.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var e=o[n];!function(t,e){if(t.hasAttribute("bg-lazy"))return t.removeAttribute("bg-lazy"),e();var n=new Image,a=t.getAttribute("data-original");n.onload=function(){t.src=a,t.removeAttribute("data-original"),e()},t.src!==a&&(n.src=a)}(e,function(){o=o.filter(function(t){return e!==t}),a.imageLazyLoadSetting.onImageLoaded&&a.imageLazyLoadSetting.onImageLoaded(e)})}()}function n(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",n),a.addEventListener("resize",n),a.addEventListener("orientationchange",n)}(this)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html><script type="text/javascript" src="/js/love.js"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/fireworks.js"></script><script type="text/javascript" src="\js\snow.js"></script><script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.js"></script><script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>